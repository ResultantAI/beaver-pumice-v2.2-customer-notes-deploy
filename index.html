<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Beaver Pumice | Ticket System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            gold: {
              50: '#fefdf8',
              100: '#fdf9e7',
              200: '#faf0c4',
              300: '#f5e08a',
              400: '#e9c446',
              500: '#d4a921',
              600: '#b8860b',
              700: '#96690d',
              800: '#7a5312',
              900: '#654415',
            },
            slate: {
              850: '#1a2332',
              950: '#0d1117',
            }
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', -apple-system, sans-serif; }
    .font-mono { font-family: 'JetBrains Mono', monospace; }
    
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #1a2332; }
    ::-webkit-scrollbar-thumb { background: #3d4f65; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #4d6178; }
    
    .nav-btn { transition: all 0.2s ease; }
    
    .bp-logo {
      background: linear-gradient(135deg, #b8860b 0%, #d4a921 50%, #e9c446 100%);
      box-shadow: 0 4px 14px rgba(184, 134, 11, 0.4);
    }
    
    .stat-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
    
    input:focus, select:focus, textarea:focus { 
      outline: none;
      box-shadow: 0 0 0 3px rgba(212, 169, 33, 0.2); 
    }
    
    .ticket-row { transition: background-color 0.15s ease; cursor: pointer; }
    .ticket-row:hover { background-color: rgba(212, 169, 33, 0.08) !important; }
    
    /* Hide pricing from operators */
    body.role-operator .amount-column { display: none !important; }
    body.role-operator .pricing-info { display: none !important; }
    
    .activity-card { transition: all 0.2s ease; cursor: pointer; }
    .activity-card:hover { background-color: #f1f5f9; transform: translateX(4px); }
    
    .modal-backdrop { transition: opacity 0.3s ease; }
    .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
    
    .print-btn-main { animation: pulse-subtle 2s infinite; }
    @keyframes pulse-subtle {
      0%, 100% { box-shadow: 0 4px 14px rgba(184, 134, 11, 0.4); }
      50% { box-shadow: 0 4px 20px rgba(184, 134, 11, 0.6); }
    }
    
    .quick-btn { transition: all 0.2s ease; }
    .quick-btn:hover { transform: translateY(-2px); }
    .quick-btn:active { transform: translateY(0); }
    
    .badge-role-admin { background: linear-gradient(135deg, #b8860b, #d4a921); }
    .badge-role-finance { background: linear-gradient(135deg, #059669, #10b981); }
    .badge-role-user { background: linear-gradient(135deg, #475569, #64748b); }
    
    .login-bg { background: linear-gradient(135deg, #0d1117 0%, #1a2332 50%, #0d1117 100%); }
    
    .spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .spinner-dark {
      border: 3px solid rgba(0,0,0,0.1);
      border-top-color: #b8860b;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }
    
    .upload-zone {
      border: 2px dashed #cbd5e1;
      transition: all 0.2s ease;
    }
    .upload-zone:hover, .upload-zone.dragover {
      border-color: #d4a921;
      background-color: #fefdf8;
    }
    
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 16px 24px;
      border-radius: 12px;
      font-weight: 600;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .toast-success { background: #10b981; color: white; }
    .toast-error { background: #ef4444; color: white; }
    .toast-info { background: #3b82f6; color: white; }
    .toast-warning { background: #f59e0b; color: white; }
  </style>
</head>
<body class="bg-slate-100 min-h-screen">

  <!-- ==================== LOADING SCREEN ==================== -->
  <div id="loading-screen" class="loading-overlay">
    <div class="text-center">
      <div class="spinner-dark w-12 h-12 mx-auto mb-4" style="width: 48px; height: 48px; border-width: 4px;"></div>
      <p class="text-slate-600 font-medium">Loading customers from Airtable...</p>
    </div>
  </div>

  <!-- ==================== LOGIN SCREEN ==================== -->
  <div id="login-screen" class="login-bg fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden">
      <div class="bg-gradient-to-r from-slate-900 to-slate-800 px-8 py-8 text-center">
        <div class="bp-logo w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-4">
          <span class="text-white font-extrabold text-3xl tracking-tight" style="text-shadow: 0 2px 4px rgba(0,0,0,0.3);">BP</span>
        </div>
        <h1 class="text-2xl font-bold text-white">BEAVER PUMICE</h1>
        <p class="text-slate-400 text-sm mt-1">Ticket Management System</p>
      </div>
      
      <div class="p-8">
        <div class="space-y-5">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Who's logging in?</label>
            <select id="login-user" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-gold-500 text-lg bg-white cursor-pointer">
              <option value="">Select your role...</option>
              <option value="admin">üîë Lucas (Admin)</option>
              <option value="admin2">üîë Brent (Admin)</option>
              <option value="finance">üí∞ Jesse (Finance)</option>
              <option value="user">üë∑ Operator</option>
            </select>
          </div>
          
          <div id="password-field" class="hidden">
            <label class="block text-sm font-semibold text-slate-700 mb-2">Enter PIN</label>
            <input type="password" id="login-pin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" inputmode="numeric" pattern="[0-9]*" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-gold-500 text-2xl font-mono text-center tracking-[0.5em]">
            <p class="text-xs text-slate-400 mt-2 text-center">4-digit PIN</p>
          </div>
          
          <button type="button" id="login-btn" disabled class="w-full bg-slate-200 text-slate-400 font-bold py-4 px-6 rounded-xl text-lg cursor-not-allowed transition-all flex items-center justify-center gap-2">
            <span id="login-btn-text">Select a role to continue</span>
          </button>
          
          <p id="login-error" class="text-red-500 text-sm text-center hidden"></p>
        </div>
        
        <div class="mt-6 p-4 bg-slate-50 rounded-xl">
          <p class="text-xs text-slate-500 text-center">
            Contact your administrator if you need PIN access.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== TUTORIAL MODAL ==================== -->
  <div id="tutorial-modal" class="fixed inset-0 z-[200] hidden">
    <div class="absolute inset-0 bg-black/80" id="tutorial-backdrop"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div id="tutorial-box" class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 relative z-10">
        <div class="flex items-start gap-4">
          <div class="w-14 h-14 bg-gold-100 rounded-xl flex items-center justify-center flex-shrink-0">
            <span id="tutorial-icon" class="text-3xl">üëã</span>
          </div>
          <div class="flex-1">
            <p class="text-xs text-gold-600 font-semibold uppercase tracking-wide mb-1">
              Step <span id="tutorial-step-num">1</span> of <span id="tutorial-step-total">4</span>
            </p>
            <h3 id="tutorial-title" class="text-xl font-bold text-slate-900 mb-2">Welcome!</h3>
            <p id="tutorial-text" class="text-slate-600 leading-relaxed"></p>
          </div>
        </div>
        <div class="flex items-center justify-between mt-6 pt-4 border-t border-slate-100">
          <button type="button" id="tutorial-skip-btn" onclick="closeTutorial()" class="text-slate-400 hover:text-slate-600 text-sm font-medium transition-colors px-3 py-2">
            Skip tutorial
          </button>
          <button type="button" id="tutorial-next-btn" onclick="nextTutorialStep()" class="bg-gold-500 hover:bg-gold-600 text-slate-900 font-semibold py-2.5 px-6 rounded-xl transition-all">
            Next ‚Üí
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== MAIN APP ==================== -->
  <div id="main-app" class="hidden">
  
    <header class="bg-slate-950 text-white shadow-xl sticky top-0 z-40">
      <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4 cursor-pointer" onclick="goHome()">
          <div class="bp-logo w-14 h-14 rounded-xl flex items-center justify-center">
            <span class="text-white font-extrabold text-2xl tracking-tight" style="text-shadow: 0 1px 2px rgba(0,0,0,0.3);">BP</span>
          </div>
          <div>
            <h1 class="text-xl font-bold tracking-tight text-white">BEAVER PUMICE</h1>
            <p class="text-slate-400 text-xs tracking-widest uppercase">Chemult, Oregon <span class="text-gold-500 ml-2">v2.3</span></p>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <div class="text-right hidden sm:block">
            <p class="text-slate-300 text-sm font-medium" id="user-name">Admin</p>
            <p class="text-gold-400 font-mono text-xs" id="user-role-display">Administrator</p>
          </div>
          <div id="user-badge" class="badge-role-admin w-10 h-10 rounded-full flex items-center justify-center">
            <span class="text-white text-lg" id="user-icon">üëë</span>
          </div>
          <button type="button" onclick="logout()" class="text-slate-400 hover:text-white transition-colors p-2" title="Sign Out">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
            </svg>
          </button>
        </div>
      </div>
    </header>

    <nav class="bg-slate-900 border-b-4 border-gold-500 sticky top-[76px] z-30">
      <div class="max-w-6xl mx-auto px-4">
        <div class="flex gap-1 overflow-x-auto" id="main-nav"></div>
      </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 py-8">
      
      <!-- ==================== DASHBOARD VIEW ==================== -->
      <div id="view-dashboard" class="view-content space-y-8">
        <div class="bg-gradient-to-r from-slate-900 to-slate-800 rounded-2xl p-6 text-white shadow-lg" id="dashboard-banner">
          <div class="flex items-center justify-between flex-wrap gap-4">
            <div>
              <h2 class="text-2xl font-bold">Good <span id="greeting-time">morning</span>, Lucas!</h2>
              <p class="text-slate-300 mt-1">Here's your quarry overview.</p>
            </div>
            <div class="flex items-center gap-3">
              <span class="bg-gold-500/20 text-gold-400 px-3 py-1 rounded-full text-sm font-medium">üëë Admin View</span>
              <button type="button" onclick="showView('new-ticket')" id="dashboard-new-btn" class="quick-btn bg-gold-500 hover:bg-gold-600 text-slate-900 font-semibold py-3 px-6 rounded-xl transition-all shadow-lg hover:shadow-xl flex items-center gap-2">
                <span class="text-xl">‚ûï</span><span>New Ticket</span>
              </button>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6" id="stats-section">
          <div class="stat-card bg-white rounded-2xl shadow-md p-6 border-l-4 border-gold-500">
            <div class="flex items-start justify-between">
              <div>
                <p class="text-slate-500 text-sm font-medium uppercase tracking-wide">Total Tickets</p>
                <p class="text-4xl font-bold text-slate-900 mt-2 font-mono" id="stat-tickets">0</p>
                <p class="text-slate-400 text-sm mt-1">all time</p>
              </div>
              <div class="w-12 h-12 bg-gold-100 rounded-xl flex items-center justify-center"><span class="text-2xl">üé´</span></div>
            </div>
          </div>
          <div class="stat-card bg-white rounded-2xl shadow-md p-6 border-l-4 border-emerald-500">
            <div class="flex items-start justify-between">
              <div>
                <p class="text-slate-500 text-sm font-medium uppercase tracking-wide">Total Tons</p>
                <p class="text-4xl font-bold text-slate-900 mt-2 font-mono" id="stat-tons">0</p>
                <p class="text-slate-400 text-sm mt-1">net weight</p>
              </div>
              <div class="w-12 h-12 bg-emerald-100 rounded-xl flex items-center justify-center"><span class="text-2xl">‚öñÔ∏è</span></div>
            </div>
          </div>
          <div class="stat-card bg-white rounded-2xl shadow-md p-6 border-l-4 border-blue-500">
            <div class="flex items-start justify-between">
              <div>
                <p class="text-slate-500 text-sm font-medium uppercase tracking-wide">Total Yards</p>
                <p class="text-4xl font-bold text-slate-900 mt-2 font-mono" id="stat-yards">0</p>
                <p class="text-slate-400 text-sm mt-1">volume</p>
              </div>
              <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center"><span class="text-2xl">üì¶</span></div>
            </div>
          </div>
          <div class="stat-card bg-white rounded-2xl shadow-md p-6 border-l-4 border-purple-500">
            <div class="flex items-start justify-between">
              <div>
                <p class="text-slate-500 text-sm font-medium uppercase tracking-wide">Customers</p>
                <p class="text-4xl font-bold text-slate-900 mt-2 font-mono" id="stat-customers">0</p>
                <p class="text-slate-400 text-sm mt-1">active</p>
              </div>
              <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center"><span class="text-2xl">üë•</span></div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-md p-6" id="admin-actions">
          <h2 class="text-lg font-bold text-slate-900 mb-4">Quick Actions</h2>
          <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
            <button type="button" onclick="showView('new-ticket')" class="quick-btn bg-gradient-to-br from-gold-500 to-gold-600 hover:from-gold-600 hover:to-gold-700 text-slate-900 font-semibold py-5 px-4 rounded-xl transition-all shadow-md hover:shadow-lg flex flex-col items-center gap-2">
              <span class="text-3xl">‚ûï</span><span>New Ticket</span>
            </button>
            <button type="button" onclick="showView('tickets')" class="quick-btn bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-5 px-4 rounded-xl transition-all flex flex-col items-center gap-2">
              <span class="text-3xl">üìã</span><span>All Tickets</span>
            </button>
            <button type="button" onclick="showView('customers')" class="quick-btn bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-5 px-4 rounded-xl transition-all flex flex-col items-center gap-2">
              <span class="text-3xl">üë•</span><span>Customers</span>
            </button>
            <button type="button" onclick="showView('trucks')" class="quick-btn bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-5 px-4 rounded-xl transition-all flex flex-col items-center gap-2">
              <span class="text-3xl">üöõ</span><span>Carriers</span>
            </button>
            <button type="button" onclick="showView('reports')" class="quick-btn bg-blue-100 hover:bg-blue-200 text-blue-700 font-semibold py-5 px-4 rounded-xl transition-all flex flex-col items-center gap-2">
              <span class="text-3xl">üìà</span><span>Reports</span>
            </button>
            <button type="button" onclick="showView('settings')" class="quick-btn bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-5 px-4 rounded-xl transition-all flex flex-col items-center gap-2">
              <span class="text-3xl">‚öôÔ∏è</span><span>Settings</span>
            </button>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-md p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-bold text-slate-900">Recent Activity</h2>
            <button type="button" onclick="showView('tickets')" class="text-gold-600 hover:text-gold-700 text-sm font-semibold">View all ‚Üí</button>
          </div>
          <div class="space-y-3" id="recent-activity"></div>
        </div>
      </div>

      <!-- ==================== OPERATOR HOME VIEW ==================== -->
      <div id="view-operator-home" class="view-content hidden space-y-8">
        <div class="bg-gradient-to-r from-slate-900 to-slate-800 rounded-2xl p-6 text-white shadow-lg">
          <div class="flex items-center justify-between flex-wrap gap-4">
            <div>
              <h2 class="text-2xl font-bold">Ready to create tickets</h2>
              <p class="text-slate-300 mt-1">Select an action below to get started.</p>
            </div>
            <span class="bg-slate-600 text-slate-300 px-3 py-1 rounded-full text-sm font-medium">üë∑ Operator View</span>
          </div>
        </div>

        <button type="button" onclick="showView('new-ticket')" id="operator-new-btn" class="w-full bg-gradient-to-br from-gold-500 to-gold-600 hover:from-gold-600 hover:to-gold-700 text-slate-900 font-bold py-8 px-6 rounded-2xl text-2xl transition-all shadow-xl hover:shadow-2xl flex items-center justify-center gap-4">
          <span class="text-4xl">‚ûï</span><span>Create New Ticket</span>
        </button>

        <div class="bg-white rounded-2xl shadow-md p-6" id="operator-actions">
          <h2 class="text-lg font-bold text-slate-900 mb-4">Quick Actions</h2>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <button type="button" onclick="showView('new-ticket')" class="quick-btn bg-gradient-to-br from-gold-500 to-gold-600 hover:from-gold-600 hover:to-gold-700 text-slate-900 font-semibold py-5 px-4 rounded-xl transition-all shadow-md hover:shadow-lg flex flex-col items-center gap-2">
              <span class="text-3xl">‚ûï</span><span>New Ticket</span>
            </button>
            <button type="button" onclick="showView('tickets')" id="operator-print-btn" class="quick-btn bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-5 px-4 rounded-xl transition-all flex flex-col items-center gap-2">
              <span class="text-3xl">üñ®Ô∏è</span><span>Print Ticket</span>
            </button>
            <button type="button" onclick="showView('customers')" class="quick-btn bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-5 px-4 rounded-xl transition-all flex flex-col items-center gap-2">
              <span class="text-3xl">üë•</span><span>Customers</span>
            </button>
            <button type="button" onclick="showView('trucks')" class="quick-btn bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-5 px-4 rounded-xl transition-all flex flex-col items-center gap-2">
              <span class="text-3xl">üöõ</span><span>Carriers</span>
            </button>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-md p-6">
          <h2 class="text-lg font-bold text-slate-900 mb-4">Recent Tickets</h2>
          <div class="space-y-3" id="operator-recent-activity"></div>
        </div>
        
        <!-- Help & Training Section (Operator) -->
        <div class="bg-white rounded-2xl shadow-md p-6" id="operator-help-section">
          <h2 class="text-lg font-bold text-slate-900 mb-4">üìö Help & Training</h2>
          <div class="grid grid-cols-2 gap-4">
            <a href="operator-guide.html" class="bg-emerald-50 hover:bg-emerald-100 border-2 border-emerald-200 rounded-xl p-4 transition-all block">
              <div class="flex items-center gap-3">
                <span class="text-2xl">üë∑</span>
                <div>
                  <p class="font-semibold text-slate-900">Operator Guide</p>
                  <p class="text-xs text-slate-500">Step-by-step instructions</p>
                </div>
              </div>
            </a>
            <a href="quick-reference.html" class="bg-purple-50 hover:bg-purple-100 border-2 border-purple-200 rounded-xl p-4 transition-all block">
              <div class="flex items-center gap-3">
                <span class="text-2xl">üñ®Ô∏è</span>
                <div>
                  <p class="font-semibold text-slate-900">Print Cheat Sheet</p>
                  <p class="text-xs text-slate-500">Quick reference card</p>
                </div>
              </div>
            </a>
          </div>
          <div class="mt-4 bg-slate-100 rounded-xl p-3 text-center">
            <p class="text-sm text-slate-600">
              Need help? Call the office or email <a href="mailto:support@resultantai.com" class="text-gold-600 hover:underline">support@resultantai.com</a>
            </p>
          </div>
        </div>
      </div>

      <!-- ==================== NEW TICKET VIEW ==================== -->
      <div id="view-new-ticket" class="view-content hidden max-w-2xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
          <div class="bg-gradient-to-r from-slate-900 to-slate-800 px-6 py-5">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-gold-500 rounded-lg flex items-center justify-center">
                <span class="text-slate-900 text-xl">‚ûï</span>
              </div>
              <div>
                <h2 class="text-xl font-bold text-white">New Load Entry</h2>
                <p class="text-slate-400 text-sm">Fill in the ticket details below</p>
              </div>
            </div>
          </div>

          <div id="success-banner" class="hidden bg-emerald-500 text-white px-6 py-4">
            <div class="flex items-center justify-between flex-wrap gap-3">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center"><span class="text-xl">‚úì</span></div>
                <div>
                  <p class="font-semibold">Ticket #<span id="new-ticket-number"></span> Created!</p>
                  <p class="text-sm opacity-90">Saved successfully</p>
                </div>
              </div>
              <div class="flex gap-2">
                <button type="button" onclick="printNewTicket()" class="bg-white text-emerald-600 font-semibold py-2 px-4 rounded-lg text-sm hover:bg-emerald-50 transition-all">üìÑ Print Ticket</button>
                <button type="button" onclick="hideSuccessBanner()" class="bg-white/20 text-white font-semibold py-2 px-4 rounded-lg text-sm hover:bg-white/30 transition-all">‚úï Close</button>
              </div>
            </div>
          </div>

          <form id="ticket-form" class="p-6 space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">Customer <span class="text-gold-600">*</span></label>
                <select id="ticket-customer" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-gold-500 text-lg bg-white">
                  <option value="">Select customer...</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">Hauling For <span class="text-gold-600">*</span></label>
                <select id="ticket-carrier" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-gold-500 text-lg bg-white">
                  <option value="">Select carrier...</option>
                </select>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">Truck <span class="text-gold-600">*</span></label>
                <input type="text" id="ticket-truck" required placeholder="e.g., 12 Mike S or Double J #4" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-gold-500 text-lg bg-white">
              </div>
              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">Product <span class="text-gold-600">*</span></label>
                <select id="ticket-product" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-gold-500 text-lg bg-white">
                  <option value="">Select product...</option>
                </select>
                <p id="product-filter-notice" class="text-xs text-emerald-600 mt-1 hidden">
                  <span class="inline-flex items-center gap-1">‚úì Filtered for this customer</span>
                </p>
              </div>
            </div>

            <div class="bg-slate-50 rounded-xl p-5 border border-slate-200">
              <!-- Scale Connection Panel -->
              <div id="scale-controls" class="bg-blue-50 rounded-xl p-4 mb-4 border border-blue-100">
                <div class="flex items-center justify-between mb-3">
                  <div>
                    <h4 class="font-semibold text-slate-800 flex items-center gap-2">
                      <span>‚öñÔ∏è</span> Rice Lake 880 Scale
                    </h4>
                    <div id="scale-status" class="text-sm">
                      <span class="inline-flex items-center text-slate-500">
                        <span class="w-2 h-2 bg-slate-400 rounded-full mr-2"></span>Scale Not Connected
                      </span>
                    </div>
                  </div>
                  <button id="scale-connect-btn" onclick="toggleScaleConnection()" 
                    class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-medium hover:bg-slate-50 transition-colors">
                    üîå Connect Scale
                  </button>
                </div>
                <div id="scale-live-display" class="text-center py-2 hidden">
                  <div class="text-xs text-slate-500 uppercase tracking-wide">Live Reading</div>
                  <div id="scale-live-reading" class="text-3xl font-mono font-bold text-blue-600">‚Äî lbs</div>
                </div>
              </div>

              <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                <span class="w-8 h-8 bg-slate-200 rounded-lg flex items-center justify-center text-lg">‚öñÔ∏è</span>
                Scale Weights
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-2">Tare Weight (lbs) <span class="text-gold-600">*</span></label>
                  <div class="flex gap-2">
                    <input type="number" id="ticket-tare" required placeholder="Empty truck weight" class="flex-1 px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-gold-500 text-lg font-mono bg-white">
                    <button type="button" onclick="captureTareWeight()" class="scale-capture-btn px-4 py-3 bg-blue-100 border-2 border-blue-200 rounded-xl font-medium text-blue-700 hover:bg-blue-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled title="Capture from scale">
                      üì•
                    </button>
                  </div>
                  <p class="text-xs text-slate-400 mt-1">Weigh truck before loading</p>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-2">Gross Weight (lbs) <span class="text-gold-600">*</span></label>
                  <div class="flex gap-2">
                    <input type="number" id="ticket-gross" required placeholder="Loaded truck weight" class="flex-1 px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-gold-500 text-lg font-mono bg-white">
                    <button type="button" onclick="captureGrossWeight()" class="scale-capture-btn px-4 py-3 bg-green-100 border-2 border-green-200 rounded-xl font-medium text-green-700 hover:bg-green-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled title="Capture from scale">
                      üì§
                    </button>
                  </div>
                  <p class="text-xs text-slate-400 mt-1">Weigh truck after loading</p>
                </div>
              </div>

              <div id="calculations" class="hidden mt-5 pt-5 border-t border-slate-200">
                <div class="grid grid-cols-4 gap-4">
                  <div class="text-center bg-white rounded-xl p-4 shadow-sm">
                    <p class="text-xs text-slate-500 uppercase tracking-wide font-semibold">Net Weight</p>
                    <p class="text-2xl font-bold font-mono text-slate-900 mt-1"><span id="calc-net">0</span></p>
                    <p class="text-xs text-slate-400">lbs</p>
                  </div>
                  <div class="text-center bg-emerald-50 rounded-xl p-4 shadow-sm border border-emerald-100">
                    <p class="text-xs text-emerald-600 uppercase tracking-wide font-semibold">Net Tons</p>
                    <p class="text-2xl font-bold font-mono text-emerald-600 mt-1" id="calc-tons">0.00</p>
                    <p class="text-xs text-emerald-400">tons</p>
                  </div>
                  <div class="text-center bg-blue-50 rounded-xl p-4 shadow-sm border border-blue-100">
                    <p class="text-xs text-blue-600 uppercase tracking-wide font-semibold">Net Yards</p>
                    <p class="text-2xl font-bold font-mono text-blue-600 mt-1" id="calc-yards">‚Äî</p>
                    <p class="text-xs text-blue-400">yards</p>
                  </div>
                  <div class="text-center bg-gold-50 rounded-xl p-4 shadow-sm border border-gold-200">
                    <p class="text-xs text-gold-700 uppercase tracking-wide font-semibold">Est. Amount</p>
                    <p class="text-2xl font-bold font-mono text-gold-700 mt-1" id="calc-amount">$0.00</p>
                    <p class="text-xs text-gold-500" id="calc-rate-info">‚Äî</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">PO Number <span class="text-slate-400 font-normal">(optional)</span></label>
                <input type="text" id="ticket-po" placeholder="Customer PO #" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-gold-500 bg-white">
              </div>
              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">Ticket Note <span class="text-slate-400 font-normal">(optional)</span></label>
                <input type="text" id="ticket-note" placeholder="Special instructions..." class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-gold-500 bg-white">
              </div>
            </div>
            
            <!-- Customer Default Note Display -->
            <div id="customer-default-note-container" class="hidden mb-4 p-3 bg-amber-50 border-2 border-amber-200 rounded-xl">
              <div class="flex items-start gap-2">
                <span class="text-amber-600">üìå</span>
                <div>
                  <p class="text-sm font-semibold text-amber-800">Customer Note (will appear on ticket):</p>
                  <p id="customer-default-note-display" class="text-amber-900 mt-1"></p>
                </div>
              </div>
            </div>

            <!-- Freight Section (for when Beaver Pumice arranges trucking) - hidden by default -->
            <div id="freight-section" class="mb-4 p-4 bg-blue-50 border-2 border-blue-200 rounded-xl hidden">
              <div class="flex items-center gap-2 mb-3">
                <span class="text-blue-600 text-lg">üöö</span>
                <h4 class="font-semibold text-blue-800">Freight (optional)</h4>
                <span class="text-xs text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full">When BP arranges trucking</span>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-2">Freight Cost <span class="text-slate-400 font-normal">(pay to carrier)</span></label>
                  <div class="relative">
                    <span class="absolute left-3 top-3 text-slate-500">$</span>
                    <input type="number" id="ticket-freight-cost" placeholder="0.00" step="0.01" min="0" class="w-full pl-8 pr-4 py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 bg-white" oninput="calculateFreightMargin()">
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-2">Freight Charge <span class="text-slate-400 font-normal">(bill to customer)</span></label>
                  <div class="relative">
                    <span class="absolute left-3 top-3 text-slate-500">$</span>
                    <input type="number" id="ticket-freight-charge" placeholder="0.00" step="0.01" min="0" class="w-full pl-8 pr-4 py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 bg-white" oninput="calculateFreightMargin()">
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-2">Freight Margin <span class="text-slate-400 font-normal">(profit)</span></label>
                  <div class="relative">
                    <span class="absolute left-3 top-3 text-slate-500">$</span>
                    <input type="text" id="ticket-freight-margin" readonly class="w-full pl-8 pr-4 py-3 border-2 border-green-200 rounded-xl bg-green-50 text-green-700 font-semibold">
                  </div>
                </div>
              </div>
            </div>

            <button type="submit" id="submit-ticket-btn" class="w-full bg-gradient-to-r from-gold-600 to-gold-500 hover:from-gold-700 hover:to-gold-600 text-slate-900 font-bold py-4 px-6 rounded-xl text-lg transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
              <span id="submit-text">‚úì CREATE TICKET</span>
              <span id="submit-spinner" class="spinner hidden"></span>
            </button>
          </form>
        </div>
      </div>

      <!-- ==================== TICKETS LIST VIEW ==================== -->
      <div id="view-tickets" class="view-content hidden">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
          <div class="bg-gradient-to-r from-slate-900 to-slate-800 px-6 py-5 flex items-center justify-between flex-wrap gap-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-gold-500 rounded-lg flex items-center justify-center">
                <span class="text-slate-900 text-xl">üìã</span>
              </div>
              <div>
                <h2 class="text-xl font-bold text-white">Recent Tickets</h2>
                <p class="text-slate-400 text-sm">Click any row to view details</p>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <div class="relative">
                <input type="text" id="ticket-search" placeholder="Search tickets..." class="pl-10 pr-4 py-2.5 rounded-xl bg-slate-800 border border-slate-700 text-white placeholder-slate-500 focus:border-gold-500 w-64">
                <span class="absolute left-3 top-3 text-slate-500">üîç</span>
              </div>
              <button type="button" onclick="showView('new-ticket')" class="bg-gold-500 hover:bg-gold-600 text-slate-900 font-semibold py-2.5 px-4 rounded-xl text-sm transition-all">‚ûï New</button>
            </div>
          </div>

          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-slate-100">
                <tr>
                  <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Ticket</th>
                  <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider hidden sm:table-cell">Date</th>
                  <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Customer</th>
                  <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider hidden md:table-cell">Product</th>
                  <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider hidden lg:table-cell">Carrier / Truck</th>
                  <th class="px-6 py-4 text-right text-xs font-bold text-slate-600 uppercase tracking-wider">Tons</th>
                  <th class="px-6 py-4 text-right text-xs font-bold text-slate-600 uppercase tracking-wider hidden sm:table-cell">Yards</th>
                  <th class="px-6 py-4 text-right text-xs font-bold text-slate-600 uppercase tracking-wider hidden sm:table-cell amount-column">$ Amount</th>
                  <th class="px-6 py-4 text-center text-xs font-bold text-slate-600 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-100" id="tickets-table"></tbody>
            </table>
          </div>

          <div class="bg-slate-50 px-6 py-4 flex items-center justify-between border-t">
            <p class="text-sm text-slate-600">Showing <span id="ticket-count" class="font-semibold">0</span> tickets</p>
            <button type="button" onclick="refreshData()" class="text-gold-600 hover:text-gold-700 text-sm font-semibold flex items-center gap-1">
              <span>‚Üª</span> Refresh
            </button>
          </div>
        </div>
      </div>

      <!-- ==================== CUSTOMERS VIEW ==================== -->
      <div id="view-customers" class="view-content hidden">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
          <div class="bg-gradient-to-r from-slate-900 to-slate-800 px-6 py-5 flex items-center justify-between flex-wrap gap-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-gold-500 rounded-lg flex items-center justify-center">
                <span class="text-slate-900 text-xl">üë•</span>
              </div>
              <div>
                <h2 class="text-xl font-bold text-white">Customers</h2>
                <p class="text-slate-400 text-sm"><span id="customer-count">0</span> active customers</p>
              </div>
            </div>
            <div class="flex items-center gap-3" id="customer-admin-actions">
              <div class="flex bg-slate-800 rounded-lg p-1">
                <button type="button" onclick="setCustomerView('cards')" id="view-cards-btn" class="px-3 py-1.5 rounded-md text-sm font-medium bg-gold-500 text-slate-900">
                  ‚ñ¶ Cards
                </button>
                <button type="button" onclick="setCustomerView('list')" id="view-list-btn" class="px-3 py-1.5 rounded-md text-sm font-medium text-slate-400 hover:text-white">
                  ‚ò∞ List
                </button>
              </div>
              <button type="button" onclick="openUploadCustomersModal()" class="bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2.5 px-4 rounded-xl text-sm transition-all flex items-center gap-2">
                <span>üì§</span> Upload CSV
              </button>
              <button type="button" onclick="openAddCustomerModal()" class="bg-gold-500 hover:bg-gold-600 text-slate-900 font-semibold py-2.5 px-4 rounded-xl text-sm transition-all flex items-center gap-2">
                <span>‚ûï</span> Add Customer
              </button>
            </div>
          </div>
          
          <div class="px-6 py-4 bg-slate-50 border-b">
            <div class="relative max-w-md">
              <input type="text" id="customer-search" placeholder="Search customers..." class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 focus:border-gold-500 bg-white">
              <span class="absolute left-3 top-3 text-slate-400">üîç</span>
            </div>
          </div>
          
          <div class="p-6">
            <div id="customers-cards-view" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <div id="customers-list-view" class="hidden">
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-slate-100">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Name</th>
                      <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase hidden md:table-cell">City, State</th>
                      <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase hidden lg:table-cell">Phone</th>
                      <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Pricing</th>
                      <th class="px-4 py-3 text-center text-xs font-bold text-slate-600 uppercase">Actions</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-100" id="customers-table-body"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== CARRIERS VIEW ==================== -->
      <div id="view-trucks" class="view-content hidden">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
          <div class="bg-gradient-to-r from-slate-900 to-slate-800 px-6 py-5 flex items-center justify-between flex-wrap gap-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-gold-500 rounded-lg flex items-center justify-center">
                <span class="text-slate-900 text-xl">üöõ</span>
              </div>
              <div>
                <h2 class="text-xl font-bold text-white">Carriers</h2>
                <p class="text-slate-400 text-sm">Manage freight companies</p>
              </div>
            </div>
            <div class="flex items-center gap-3" id="trucks-admin-actions">
              <button type="button" onclick="openAddCarrierModal()" class="bg-gold-500 hover:bg-gold-600 text-slate-900 font-semibold py-2.5 px-4 rounded-xl text-sm transition-all flex items-center gap-2">
                <span>‚ûï</span> Add Carrier
              </button>
            </div>
          </div>
          <div class="p-6">
            <div>
              <h3 class="text-lg font-bold text-slate-900 mb-4">Carriers (<span id="carrier-count">0</span>)</h3>
              <div class="space-y-2" id="carriers-list"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== SETTINGS VIEW ==================== -->
      <div id="view-settings" class="view-content hidden">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
          <div class="bg-gradient-to-r from-slate-900 to-slate-800 px-6 py-5">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-gold-500 rounded-lg flex items-center justify-center">
                <span class="text-slate-900 text-xl">‚öôÔ∏è</span>
              </div>
              <div>
                <h2 class="text-xl font-bold text-white">Settings</h2>
                <p class="text-slate-400 text-sm">Admin configuration</p>
              </div>
            </div>
          </div>
          <div class="p-6 space-y-6">
            <div>
              <h3 class="text-lg font-bold text-slate-900 mb-4">Products & Weights</h3>
              <div class="space-y-3" id="products-settings"></div>
            </div>
            
            <div class="pt-6 border-t">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-slate-900">User Access</h3>
                <button type="button" onclick="openAddUserModal()" class="bg-gold-500 hover:bg-gold-600 text-slate-900 font-semibold py-2 px-4 rounded-xl text-sm transition-all flex items-center gap-2">
                  <span>‚ûï</span> Add User
                </button>
              </div>
              <div class="space-y-3" id="users-list"></div>
            </div>

            <div class="pt-6 border-t">
              <h3 class="text-lg font-bold text-slate-900 mb-4">System</h3>
              <div class="space-y-3">
                <div class="bg-slate-50 rounded-xl p-4 flex items-center justify-between">
                  <div>
                    <p class="font-semibold text-slate-900">Airtable Connection</p>
                    <p class="text-xs text-slate-500">Customers: tblAQKBdGWHeLz1WO</p>
                  </div>
                  <span id="airtable-status" class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full flex items-center gap-1">
                    <span class="w-2 h-2 bg-emerald-500 rounded-full"></span> Connected
                  </span>
                </div>
                <div class="bg-slate-50 rounded-xl p-4 flex items-center justify-between">
                  <div>
                    <p class="font-semibold text-slate-900">Print Server</p>
                    <p class="text-xs text-slate-500">beaver-pumice-ticket-viewer.netlify.app</p>
                  </div>
                  <span class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full flex items-center gap-1">
                    <span class="w-2 h-2 bg-emerald-500 rounded-full"></span> Online
                  </span>
                </div>
                <div class="bg-slate-50 rounded-xl p-4 flex items-center justify-between">
                  <div>
                    <p class="font-semibold text-slate-900">Reload Customers</p>
                    <p class="text-xs text-slate-500">Refresh customer data from Airtable</p>
                  </div>
                  <button type="button" onclick="reloadCustomers()" class="text-gold-600 hover:text-gold-700 text-sm font-semibold">Reload</button>
                </div>
                <div class="bg-slate-50 rounded-xl p-4 flex items-center justify-between">
                  <div>
                    <p class="font-semibold text-slate-900">Reset Tutorial</p>
                    <p class="text-xs text-slate-500">Show onboarding guide again</p>
                  </div>
                  <button type="button" onclick="resetTutorial()" class="text-gold-600 hover:text-gold-700 text-sm font-semibold">Reset</button>
                </div>
              </div>
            </div>
            
            <!-- Help & Training Section (Admin) -->
            <div class="pt-6 border-t">
              <h3 class="text-lg font-bold text-slate-900 mb-4">üìö Help & Training</h3>
              <div class="grid md:grid-cols-2 gap-4">
                <a href="training.html" class="bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 rounded-xl p-4 transition-all block">
                  <div class="flex items-center gap-3">
                    <span class="text-2xl">üëë</span>
                    <div>
                      <p class="font-semibold text-slate-900">Admin Training Guide</p>
                      <p class="text-xs text-slate-500">QuickBooks, reports, customer setup</p>
                    </div>
                  </div>
                </a>
                <a href="operator-guide.html" class="bg-emerald-50 hover:bg-emerald-100 border-2 border-emerald-200 rounded-xl p-4 transition-all block">
                  <div class="flex items-center gap-3">
                    <span class="text-2xl">üë∑</span>
                    <div>
                      <p class="font-semibold text-slate-900">Operator Guide</p>
                      <p class="text-xs text-slate-500">How to create tickets</p>
                    </div>
                  </div>
                </a>
                <a href="quick-reference.html" class="bg-purple-50 hover:bg-purple-100 border-2 border-purple-200 rounded-xl p-4 transition-all block">
                  <div class="flex items-center gap-3">
                    <span class="text-2xl">üñ®Ô∏è</span>
                    <div>
                      <p class="font-semibold text-slate-900">Print Quick Reference</p>
                      <p class="text-xs text-slate-500">Cheat sheet for scale house</p>
                    </div>
                  </div>
                </a>
                <a href="test-dashboard.html" class="bg-amber-50 hover:bg-amber-100 border-2 border-amber-200 rounded-xl p-4 transition-all block">
                  <div class="flex items-center gap-3">
                    <span class="text-2xl">üß™</span>
                    <div>
                      <p class="font-semibold text-slate-900">System Diagnostics</p>
                      <p class="text-xs text-slate-500">Test all connections</p>
                    </div>
                  </div>
                </a>
              </div>
              <div class="mt-4 bg-slate-100 rounded-xl p-4">
                <p class="text-sm text-slate-600">
                  <strong>Need support?</strong> Email <a href="mailto:support@resultantai.com" class="text-gold-600 hover:underline">support@resultantai.com</a> or call 240-389-4152
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== REPORTS VIEW (Phase 2) ==================== -->
      <div id="view-reports" class="view-content hidden space-y-6">
        <div class="bg-gradient-to-r from-slate-900 to-slate-800 rounded-2xl p-6 text-white shadow-lg">
          <div class="flex items-center justify-between flex-wrap gap-4">
            <div>
              <h2 class="text-2xl font-bold">Reports & Export</h2>
              <p class="text-slate-300 mt-1">Generate reports and export to QuickBooks</p>
            </div>
            <div class="flex items-center gap-3">
              <button type="button" onclick="exportReportToPDF()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2.5 px-4 rounded-xl text-sm transition-all flex items-center gap-2">
                <span>üìÑ</span> PDF
              </button>
              <button type="button" onclick="exportReportToExcel()" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2.5 px-4 rounded-xl text-sm transition-all flex items-center gap-2">
                <span>üìä</span> Excel
              </button>
              <button type="button" id="export-qb-btn" onclick="openQuickBooksExportModal()" disabled class="bg-blue-500 hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-semibold py-2.5 px-4 rounded-xl text-sm transition-all flex items-center gap-2">
                <span>üíº</span> QuickBooks <span id="selected-count" class="text-blue-200"></span>
              </button>
            </div>
          </div>
        </div>

        <!-- Automated Export Panel (Admin & Finance) -->
        <div id="auto-export-panel" class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-2xl p-6 text-white shadow-lg hidden">
          <div class="flex items-center justify-between flex-wrap gap-4">
            <div class="flex items-center gap-4">
              <div class="bg-white/20 rounded-xl p-3">
                <span class="text-3xl">üì§</span>
              </div>
              <div>
                <h3 class="text-xl font-bold">QuickBooks Export</h3>
                <p class="text-blue-200 text-sm mt-1">
                  <span id="pending-export-count" class="font-bold text-white text-lg">--</span> closed tickets ready to export
                </p>
              </div>
            </div>
            <div class="flex items-center gap-3 flex-wrap">
              <button type="button" onclick="refreshPendingCount()" class="bg-white/20 hover:bg-white/30 text-white font-semibold py-2.5 px-4 rounded-xl text-sm transition-all flex items-center gap-2">
                <span>üîÑ</span> Refresh
              </button>
              <button type="button" id="export-now-btn" onclick="triggerManualExport()" disabled class="bg-yellow-400 hover:bg-yellow-300 text-slate-900 font-bold py-3 px-6 rounded-xl transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg">
                <span>‚ö°</span> Export to QuickBooks Now
              </button>
            </div>
          </div>
          
          <!-- Export Progress (hidden by default) -->
          <div id="export-progress" class="hidden mt-4 bg-white/10 rounded-xl p-4">
            <div class="flex items-center gap-3">
              <div class="spinner"></div>
              <div>
                <p class="font-semibold" id="export-progress-text">Generating export...</p>
                <p class="text-blue-200 text-sm" id="export-progress-detail">This may take a moment</p>
              </div>
            </div>
          </div>
          
          <!-- Export Info -->
          <div class="mt-4 pt-4 border-t border-white/20">
            <p class="text-blue-200 text-sm flex items-center gap-2">
              <span>üìß</span>
              Exports are emailed to <strong class="text-white">accounting@beaverpumice.com</strong> (CC: lucas@beaverpumice.com)
            </p>
            <p class="text-blue-200 text-xs mt-2 flex items-center gap-2">
              <span>üí°</span>
              Click "Export to QuickBooks Now" when you're ready to generate the IIF file. Tickets will be marked as exported.
            </p>
          </div>
        </div>

        <!-- Filters Section -->
        <div class="bg-white rounded-2xl shadow-md p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-slate-900">Report Filters</h3>
            <button type="button" onclick="clearReportFilters()" class="text-sm text-slate-500 hover:text-slate-700 font-medium">Clear All</button>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-2">Report Type</label>
              <select id="report-type-select" onchange="renderCurrentReport()" class="w-full px-3 py-2 border-2 border-slate-200 rounded-xl focus:border-gold-500 bg-white">
                <option value="ticket-detail">Ticket Detail</option>
                <option value="customer-activity">Customer Activity</option>
                <option value="sales-by-product">Sales by Product</option>
                <option value="carrier-summary">Carrier Summary</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-2">Date Range</label>
              <select id="report-date-range" onchange="setReportDateRange(this.value)" class="w-full px-3 py-2 border-2 border-slate-200 rounded-xl focus:border-gold-500 bg-white">
                <option value="all">All Time</option>
                <option value="today">Today</option>
                <option value="yesterday">Yesterday</option>
                <option value="thisWeek">This Week</option>
                <option value="lastWeek">Last Week</option>
                <option value="thisMonth" selected>This Month</option>
                <option value="lastMonth">Last Month</option>
                <option value="thisYear">This Year</option>
                <option value="custom">Custom Range</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-2">Start Date</label>
              <input type="date" id="report-start-date" class="w-full px-3 py-2 border-2 border-slate-200 rounded-xl focus:border-gold-500 bg-white">
            </div>
            
            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-2">End Date</label>
              <input type="date" id="report-end-date" class="w-full px-3 py-2 border-2 border-slate-200 rounded-xl focus:border-gold-500 bg-white">
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-2">Customer</label>
              <select id="report-customer-filter" class="w-full px-3 py-2 border-2 border-slate-200 rounded-xl focus:border-gold-500 bg-white">
                <option value="">All Customers</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-2">Carrier</label>
              <select id="report-carrier-filter" class="w-full px-3 py-2 border-2 border-slate-200 rounded-xl focus:border-gold-500 bg-white">
                <option value="">All Carriers</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-2">Product</label>
              <select id="report-product-filter" class="w-full px-3 py-2 border-2 border-slate-200 rounded-xl focus:border-gold-500 bg-white">
                <option value="">All Products</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-2">Status</label>
              <select id="report-status-filter" class="w-full px-3 py-2 border-2 border-slate-200 rounded-xl focus:border-gold-500 bg-white">
                <option value="">All (excl. Void)</option>
                <option value="Open">Open</option>
                <option value="Closed">Closed</option>
                <option value="Exported">Exported</option>
                <option value="Void">Void</option>
              </select>
            </div>
          </div>
          
          <div class="flex justify-end">
            <button type="button" onclick="applyReportFilters()" class="bg-gold-500 hover:bg-gold-600 text-slate-900 font-semibold py-2.5 px-6 rounded-xl transition-all flex items-center gap-2">
              <span>üîç</span> Apply Filters
            </button>
          </div>
        </div>

        <!-- Loading State -->
        <div id="report-loading" class="hidden bg-white rounded-2xl shadow-md p-12 text-center">
          <div class="spinner-dark w-12 h-12 mx-auto mb-4" style="width: 48px; height: 48px; border-width: 4px;"></div>
          <p class="text-slate-600 font-medium">Loading report data...</p>
        </div>

        <!-- Report Results -->
        <div id="report-results" class="bg-white rounded-2xl shadow-md p-6">
          <div id="report-content">
            <div class="text-center text-slate-500 py-8">
              <p class="text-4xl mb-2">üìä</p>
              <p>Select filters and click "Apply Filters" to generate report</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== PRICING VIEW (Admin Only) ==================== -->
      <div id="view-pricing" class="view-content hidden p-4 md:p-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
          <div>
            <h2 class="text-2xl font-bold text-gray-900">üí∞ Customer Pricing Overview</h2>
            <p class="text-gray-600 mt-1">View customer rates, freight charges, and product assignments</p>
          </div>
          <div class="flex gap-2">
            <button onclick="refreshPricingData()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium">
              üîÑ Refresh
            </button>
          </div>
        </div>

        <!-- Pricing Summary Cards -->
        <div class="grid grid-cols-3 gap-4 mb-6" id="pricing-summary-cards">
          <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
            <div class="text-sm text-gray-500">Customers with Pricing</div>
            <div class="text-2xl font-bold text-gray-900" id="stat-customers-pricing">-</div>
          </div>
          <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
            <div class="text-sm text-gray-500">With Freight Rates</div>
            <div class="text-2xl font-bold text-gray-900" id="stat-customers-freight">-</div>
          </div>
          <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
            <div class="text-sm text-gray-500">Email Receipts On</div>
            <div class="text-2xl font-bold text-gray-900" id="stat-customers-email">-</div>
          </div>
        </div>
        <!-- Hidden stat for carriers (keeps JS from breaking) -->
        <div id="stat-carriers-rates" class="hidden">0</div>

        <!-- Customer Pricing Table -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
          <!-- Search Bar -->
          <div class="p-4 border-b border-gray-100">
            <input type="text" id="pricing-search" placeholder="Search customers..." 
              class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-gold-500 focus:border-gold-500"
              oninput="filterPricingTable()">
          </div>

          <!-- Customer Pricing Tab -->
          <div id="pricing-tab-customers" class="pricing-tab-content">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="text-left px-4 py-3 font-semibold text-gray-700">Customer</th>
                    <th class="text-right px-4 py-3 font-semibold text-gray-700">Pumice Rate</th>
                    <th class="text-right px-4 py-3 font-semibold text-gray-700">Freight <span class="text-xs font-normal text-gray-500">(charge/cost)</span></th>
                    <th class="text-center px-4 py-3 font-semibold text-gray-700">Products</th>
                    <th class="text-center px-4 py-3 font-semibold text-gray-700">Email</th>
                    <th class="text-center px-4 py-3 font-semibold text-gray-700">Actions</th>
                  </tr>
                </thead>
                <tbody id="customer-pricing-table" class="divide-y divide-gray-100">
                  <tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </main>

    <footer class="bg-slate-950 text-slate-400 py-6 mt-12">
      <div class="max-w-6xl mx-auto px-4 flex items-center justify-between text-sm flex-wrap gap-4">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 bg-gold-500 rounded-lg flex items-center justify-center">
            <span class="text-slate-900 font-bold text-xs">BP</span>
          </div>
          <div>
            <p class="text-slate-300 font-medium">Beaver Pumice</p>
            <p class="text-slate-500 text-xs">92777 HWY 97 N ‚Ä¢ Chemult, Oregon 97731</p>
          </div>
        </div>
        <p class="text-slate-500">Built by <span class="text-gold-400 font-medium">ResultantAI</span></p>
      </div>
    </footer>

  </div>

  <!-- ==================== MODALS ==================== -->
  
  <!-- Ticket Detail Modal -->
  <div id="ticket-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-auto">
      <div class="bg-gradient-to-r from-slate-900 to-slate-800 px-6 py-5 flex items-center justify-between sticky top-0">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-gold-500 rounded-xl flex items-center justify-center">
            <span class="text-slate-900 font-mono font-bold text-lg" id="modal-ticket-number-badge"></span>
          </div>
          <div>
            <div class="flex items-center gap-3">
              <h2 class="text-xl font-bold text-white">Ticket Details</h2>
              <span id="modal-status-badge" class="px-3 py-1 rounded-full text-xs font-bold uppercase"></span>
            </div>
            <p class="text-slate-400 text-sm" id="modal-ticket-date"></p>
          </div>
        </div>
        <button type="button" onclick="closeModal('ticket-modal')" class="text-slate-400 hover:text-white transition-colors p-2">‚úï</button>
      </div>
      
      <div class="p-6 space-y-6">
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-slate-50 rounded-xl p-4">
            <p class="text-xs text-slate-500 uppercase tracking-wide font-semibold mb-1">Customer</p>
            <p class="text-lg font-semibold text-slate-900" id="modal-customer"></p>
          </div>
          <div class="bg-slate-50 rounded-xl p-4">
            <p class="text-xs text-slate-500 uppercase tracking-wide font-semibold mb-1">Product</p>
            <p class="text-lg font-semibold text-slate-900" id="modal-product"></p>
          </div>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-slate-50 rounded-xl p-4">
            <p class="text-xs text-slate-500 uppercase tracking-wide font-semibold mb-1">Hauling For</p>
            <p class="text-lg font-semibold text-slate-900" id="modal-carrier"></p>
          </div>
          <div class="bg-slate-50 rounded-xl p-4">
            <p class="text-xs text-slate-500 uppercase tracking-wide font-semibold mb-1">Truck</p>
            <p class="text-lg font-semibold text-slate-900" id="modal-truck"></p>
          </div>
        </div>
        
        <div class="bg-gradient-to-br from-slate-100 to-slate-50 rounded-xl p-5 border border-slate-200">
          <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2"><span>‚öñÔ∏è</span> Weight Details</h3>
          <div class="grid grid-cols-5 gap-3">
            <div class="text-center">
              <p class="text-xs text-slate-500 uppercase">Gross</p>
              <p class="text-xl font-bold font-mono text-slate-900" id="modal-gross"></p>
              <p class="text-xs text-slate-400">lbs</p>
            </div>
            <div class="text-center">
              <p class="text-xs text-slate-500 uppercase">Tare</p>
              <p class="text-xl font-bold font-mono text-slate-900" id="modal-tare"></p>
              <p class="text-xs text-slate-400">lbs</p>
            </div>
            <div class="text-center bg-white rounded-lg p-2 shadow-sm">
              <p class="text-xs text-slate-500 uppercase">Net</p>
              <p class="text-xl font-bold font-mono text-slate-900" id="modal-net"></p>
              <p class="text-xs text-slate-400">lbs</p>
            </div>
            <div class="text-center bg-emerald-50 rounded-lg p-2 border border-emerald-100">
              <p class="text-xs text-emerald-600 uppercase">Tons</p>
              <p class="text-xl font-bold font-mono text-emerald-600" id="modal-tons"></p>
            </div>
            <div class="text-center bg-blue-50 rounded-lg p-2 border border-blue-100">
              <p class="text-xs text-blue-600 uppercase">Yards</p>
              <p class="text-xl font-bold font-mono text-blue-600" id="modal-yards"></p>
            </div>
          </div>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-slate-50 rounded-xl p-4">
            <p class="text-xs text-slate-500 uppercase tracking-wide font-semibold mb-1">PO Number</p>
            <p class="text-lg text-slate-900" id="modal-po">‚Äî</p>
          </div>
          <div class="bg-slate-50 rounded-xl p-4">
            <p class="text-xs text-slate-500 uppercase tracking-wide font-semibold mb-1">Note</p>
            <p class="text-lg text-slate-900" id="modal-note">‚Äî</p>
          </div>
        </div>
      </div>
      
      <div class="bg-slate-50 px-6 py-4 border-t sticky bottom-0">
        <!-- Admin Status Controls -->
        <div id="admin-status-controls" class="hidden mb-4 pb-4 border-b border-slate-200">
          <p class="text-xs text-slate-500 uppercase tracking-wide font-semibold mb-2">Change Status</p>
          <div id="status-buttons" class="flex gap-2 flex-wrap">
            <button type="button" id="btn-status-open" onclick="changeTicketStatus('Open')" class="status-btn px-3 py-1.5 rounded-lg text-sm font-semibold border-2 border-emerald-500 text-emerald-600 hover:bg-emerald-50 transition-all">Open</button>
            <button type="button" id="btn-status-hold" onclick="changeTicketStatus('Hold')" class="status-btn px-3 py-1.5 rounded-lg text-sm font-semibold border-2 border-amber-500 text-amber-600 hover:bg-amber-50 transition-all">Hold</button>
            <button type="button" id="btn-status-closed" onclick="changeTicketStatus('Closed')" class="status-btn px-3 py-1.5 rounded-lg text-sm font-semibold border-2 border-blue-500 text-blue-600 hover:bg-blue-50 transition-all">Closed</button>
            <button type="button" id="btn-status-void" onclick="changeTicketStatus('Void')" class="status-btn px-3 py-1.5 rounded-lg text-sm font-semibold border-2 border-red-500 text-red-600 hover:bg-red-50 transition-all">Void</button>
            <button type="button" id="btn-status-unvoid" onclick="changeTicketStatus('Open')" class="status-btn hidden px-3 py-1.5 rounded-lg text-sm font-semibold border-2 border-green-500 text-green-600 hover:bg-green-50 transition-all">‚Ü©Ô∏è Unvoid</button>
          </div>
          <p id="status-locked-msg" class="hidden text-sm text-red-600 mt-2 font-medium">üîí This ticket is locked and cannot be changed.</p>
        </div>
        
        <div class="flex items-center justify-between">
          <button type="button" onclick="closeModal('ticket-modal')" class="px-4 py-2 text-slate-600 hover:text-slate-900 font-medium transition-colors">‚Üê Back</button>
          <div class="flex items-center gap-2">
            <button type="button" onclick="deleteTicketFromModal()" id="delete-ticket-btn" class="hidden bg-red-100 hover:bg-red-200 text-red-700 font-semibold py-3 px-4 rounded-xl transition-all flex items-center gap-2">
              <span class="text-lg">üóëÔ∏è</span>Delete
            </button>
            <button type="button" onclick="editTicketFromModal()" id="edit-ticket-btn" class="hidden bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-3 px-4 rounded-xl transition-all flex items-center gap-2">
              <span class="text-lg">‚úèÔ∏è</span>Edit
            </button>
            <button type="button" onclick="emailTicketFromModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-xl transition-all flex items-center gap-2">
              <span class="text-xl">üìß</span>Email
            </button>
            <button type="button" onclick="printTicketFromModal()" class="print-btn-main bg-gradient-to-r from-gold-600 to-gold-500 hover:from-gold-700 hover:to-gold-600 text-slate-900 font-bold py-3 px-6 rounded-xl transition-all flex items-center gap-2">
              <span class="text-xl">üìÑ</span>Print Ticket
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Customer Modal -->
  <div id="add-customer-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-auto">
      <div class="bg-gradient-to-r from-slate-900 to-slate-800 px-6 py-5 flex items-center justify-between">
        <h2 class="text-xl font-bold text-white">‚ûï Add Customer</h2>
        <button type="button" onclick="closeModal('add-customer-modal')" class="text-slate-400 hover:text-white transition-colors p-2">‚úï</button>
      </div>
      <form id="add-customer-form" class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">Customer Name <span class="text-red-500">*</span></label>
          <input type="text" name="name" required class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">Email</label>
            <input type="email" name="email" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">Phone</label>
            <input type="tel" name="phone" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
          </div>
        </div>
        <!-- Bill To -->
        <div class="border-t border-slate-200 pt-3 mt-2">
          <h4 class="text-sm font-bold text-slate-800 mb-2">üì¨ Bill To</h4>
          <input type="email" name="billToEmail" placeholder="billing@company.com (for invoices)" class="w-full px-3 py-2 border-2 border-slate-200 rounded-lg focus:border-gold-500 mb-2 text-sm">
          <input type="text" name="billToAddress" placeholder="Street address" class="w-full px-3 py-2 border-2 border-slate-200 rounded-lg focus:border-gold-500 mb-2 text-sm">
          <div class="grid grid-cols-3 gap-2">
            <input type="text" name="billToCity" placeholder="City" class="w-full px-3 py-2 border-2 border-slate-200 rounded-lg focus:border-gold-500 text-sm">
            <input type="text" name="billToState" maxlength="2" placeholder="ST" class="w-full px-3 py-2 border-2 border-slate-200 rounded-lg focus:border-gold-500 text-sm">
            <input type="text" name="billToZip" placeholder="Zip" class="w-full px-3 py-2 border-2 border-slate-200 rounded-lg focus:border-gold-500 text-sm">
          </div>
        </div>
        
        <!-- Ship To Address -->
        <div class="border-t border-slate-200 pt-3 mt-2">
          <h4 class="text-sm font-bold text-slate-800 mb-2">üöö Ship To Address</h4>
          <input type="text" name="shipToAddress" placeholder="Street address (delivery)" class="w-full px-3 py-2 border-2 border-slate-200 rounded-lg focus:border-gold-500 mb-2 text-sm">
          <div class="grid grid-cols-3 gap-2">
            <input type="text" name="shipToCity" placeholder="City" class="w-full px-3 py-2 border-2 border-slate-200 rounded-lg focus:border-gold-500 text-sm">
            <input type="text" name="shipToState" maxlength="2" placeholder="ST" class="w-full px-3 py-2 border-2 border-slate-200 rounded-lg focus:border-gold-500 text-sm">
            <input type="text" name="shipToZip" placeholder="Zip" class="w-full px-3 py-2 border-2 border-slate-200 rounded-lg focus:border-gold-500 text-sm">
          </div>
        </div>
        
        <!-- Pricing Method (per yard or per ton) -->
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">Pricing Method <span class="text-red-500">*</span></label>
          <select name="pricingMethod" required class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500 bg-white">
            <option value="Per Yard" selected>Per Yard</option>
            <option value="Per Ton">Per Ton</option>
          </select>
          <p class="text-xs text-slate-500 mt-1">How to bill this customer for pumice</p>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">Price/Yard <span class="font-normal text-slate-400">($13 default)</span></label>
            <input type="number" name="priceYard" step="0.01" placeholder="13.00" value="13" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">Price/Ton</label>
            <input type="number" name="priceTon" step="0.01" placeholder="Optional" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
          </div>
        </div>
        
        <!-- Freight Settings -->
        <div class="border-t border-slate-200 pt-4 mt-2">
          <h4 class="text-sm font-bold text-slate-800 mb-3">üöö Freight Settings</h4>
          <!-- Customer Charge (what you bill) -->
          <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1">Charge Method</label>
              <select name="freightMethod" class="w-full px-3 py-2 border-2 border-slate-200 rounded-lg focus:border-blue-500 bg-white text-sm">
                <option value="">None</option>
                <option value="per_ton">Per Ton</option>
                <option value="per_yard">Per Yard</option>
                <option value="flat">Flat Fee</option>
                <option value="delivered">Delivered</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1">Charge Rate</label>
              <div class="relative">
                <span class="absolute left-2 top-2 text-slate-500 text-sm">$</span>
                <input type="number" name="freightRate" step="0.01" min="0" placeholder="0.00" class="w-full pl-6 pr-2 py-2 border-2 border-slate-200 rounded-lg focus:border-blue-500 bg-white text-sm">
              </div>
            </div>
          </div>
          <!-- Truck Cost (what you pay) -->
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1">Cost Method <span class="text-xs text-slate-400">(truck)</span></label>
              <select name="freightCostMethod" class="w-full px-3 py-2 border-2 border-slate-200 rounded-lg focus:border-blue-500 bg-white text-sm">
                <option value="">Same as Charge</option>
                <option value="per_ton">Per Ton</option>
                <option value="per_yard">Per Yard</option>
                <option value="flat">Flat Fee</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1">Cost Rate <span class="text-xs text-slate-400">(pay truck)</span></label>
              <div class="relative">
                <span class="absolute left-2 top-2 text-slate-500 text-sm">$</span>
                <input type="number" name="freightCost" step="0.01" min="0" placeholder="0.00" class="w-full pl-6 pr-2 py-2 border-2 border-slate-200 rounded-lg focus:border-blue-500 bg-white text-sm">
              </div>
            </div>
          </div>
        </div>
        
        <div class="pt-4 flex gap-3">
          <button type="button" onclick="closeModal('add-customer-modal')" class="flex-1 px-4 py-3 border-2 border-slate-200 text-slate-600 font-semibold rounded-xl hover:bg-slate-50 transition-all">Cancel</button>
          <button type="submit" id="add-customer-btn" class="flex-1 px-4 py-3 bg-gold-500 hover:bg-gold-600 text-slate-900 font-semibold rounded-xl transition-all flex items-center justify-center gap-2">
            <span id="add-customer-text">Add Customer</span>
            <span id="add-customer-spinner" class="spinner hidden"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Customer Modal -->
  <div id="edit-customer-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-auto">
      <div class="bg-gradient-to-r from-slate-900 to-slate-800 px-6 py-5 flex items-center justify-between">
        <h2 class="text-xl font-bold text-white">‚úèÔ∏è Edit Customer</h2>
        <button type="button" onclick="closeModal('edit-customer-modal')" class="text-slate-400 hover:text-white transition-colors p-2">‚úï</button>
      </div>
      <form id="edit-customer-form" class="p-6 space-y-4">
        <input type="hidden" name="id" id="edit-customer-id">
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">Customer Name <span class="text-red-500">*</span></label>
          <input type="text" name="name" id="edit-customer-name" required class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">Email</label>
            <input type="email" name="email" id="edit-customer-email" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">Phone</label>
            <input type="tel" name="phone" id="edit-customer-phone" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
          </div>
        </div>
        <!-- Bill To Address -->
        <div class="border-t-2 border-slate-100 pt-4 mt-2">
          <h4 class="text-sm font-bold text-slate-800 mb-2">üì¨ Bill To</h4>
          <div class="space-y-3">
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1">Bill To Email <span class="text-slate-400">(for invoices)</span></label>
              <input type="email" name="billToEmail" id="edit-customer-billToEmail" placeholder="billing@company.com" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
            </div>
            <input type="text" name="billToAddress" id="edit-customer-billToAddress" placeholder="Street address" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
            <div class="grid grid-cols-3 gap-3">
              <input type="text" name="billToCity" id="edit-customer-billToCity" placeholder="City" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
              <input type="text" name="billToState" id="edit-customer-billToState" maxlength="2" placeholder="State" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
              <input type="text" name="billToZip" id="edit-customer-billToZip" placeholder="Zip" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
            </div>
          </div>
        </div>
        
        <!-- Ship To Address -->
        <div class="border-t-2 border-slate-100 pt-4 mt-2">
          <h4 class="text-sm font-bold text-slate-800 mb-2">üöö Ship To Address <span class="font-normal text-slate-500">(delivery destination)</span></h4>
          <div class="space-y-3">
            <input type="text" name="shipToAddress" id="edit-customer-shipToAddress" placeholder="Street address" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
            <div class="grid grid-cols-3 gap-3">
              <input type="text" name="shipToCity" id="edit-customer-shipToCity" placeholder="City" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
              <input type="text" name="shipToState" id="edit-customer-shipToState" maxlength="2" placeholder="State" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
              <input type="text" name="shipToZip" id="edit-customer-shipToZip" placeholder="Zip" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
            </div>
          </div>
        </div>
        
        <!-- Pricing Method (per yard or per ton) -->
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">Pricing Method</label>
          <select name="pricingMethod" id="edit-customer-pricingMethod" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500 bg-white">
            <option value="">Not Set</option>
            <option value="Per Yard">Per Yard</option>
            <option value="Per Ton">Per Ton</option>
          </select>
          <p class="text-xs text-slate-500 mt-1">How to bill this customer for pumice</p>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">Price/Yard <span class="font-normal text-slate-400">($13 default)</span></label>
            <input type="number" name="priceYard" id="edit-customer-priceYard" step="0.01" placeholder="13.00" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">Price/Ton</label>
            <input type="number" name="priceTon" id="edit-customer-priceTon" step="0.01" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">Billing Notes <span class="font-normal text-slate-500">(special instructions for invoicing)</span></label>
          <textarea name="billingNotes" id="edit-customer-billingNotes" rows="2" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500" placeholder="e.g., Bill weekly, requires PO number, special discount applies..."></textarea>
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">Default Note <span class="font-normal text-slate-500">(appears on all tickets for this customer)</span></label>
          <textarea name="defaultNote" id="edit-customer-defaultNote" rows="2" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500" placeholder="e.g., Load to 80,000 lbs max"></textarea>
        </div>
        
        <!-- Freight Settings Section -->
        <div class="border-t-2 border-slate-100 pt-4 mt-2">
          <h4 class="text-sm font-bold text-slate-800 mb-2">üöö Freight Settings <span class="font-normal text-slate-500">(when BP arranges trucking)</span></h4>
          <!-- Customer Charge Row -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1">Charge Method <span class="text-slate-400">(bill customer)</span></label>
              <select name="freightMethod" id="edit-customer-freightMethod" class="w-full px-3 py-2 border-2 border-slate-200 rounded-lg focus:border-blue-500 bg-white text-sm">
                <option value="">None (Customer Pickup)</option>
                <option value="per_ton">Per Ton</option>
                <option value="per_yard">Per Yard</option>
                <option value="flat">Flat Fee (per load)</option>
                <option value="delivered">Delivered (all-in price)</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1">Charge Rate <span class="text-slate-400">($/unit)</span></label>
              <div class="relative">
                <span class="absolute left-3 top-2 text-slate-500 text-sm">$</span>
                <input type="number" name="freightRate" id="edit-customer-freightRate" step="0.01" min="0" placeholder="0.00" class="w-full pl-7 pr-3 py-2 border-2 border-slate-200 rounded-lg focus:border-blue-500 bg-white text-sm">
              </div>
            </div>
          </div>
          <!-- Truck Cost Row -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1">Cost Method <span class="text-slate-400">(pay truck)</span></label>
              <select name="freightCostMethod" id="edit-customer-freightCostMethod" class="w-full px-3 py-2 border-2 border-slate-200 rounded-lg focus:border-blue-500 bg-white text-sm">
                <option value="">Same as Charge Method</option>
                <option value="per_ton">Per Ton</option>
                <option value="per_yard">Per Yard</option>
                <option value="flat">Flat Fee (per load)</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1">Cost Rate <span class="text-slate-400">($/unit)</span></label>
              <div class="relative">
                <span class="absolute left-3 top-2 text-slate-500 text-sm">$</span>
                <input type="number" name="freightCost" id="edit-customer-freightCost" step="0.01" min="0" placeholder="0.00" class="w-full pl-7 pr-3 py-2 border-2 border-slate-200 rounded-lg focus:border-blue-500 bg-white text-sm">
              </div>
            </div>
          </div>
          <p class="text-xs text-slate-500 mt-2">üí° Freight auto-calculates on tickets. Use different methods to charge customer by yard but pay truck by ton.</p>
        </div>
        
        <!-- Allowed Products Section -->
        <div class="border-t-2 border-slate-100 pt-4 mt-2">
          <h4 class="text-sm font-bold text-slate-800 mb-2">üì¶ Allowed Products</h4>
          <p class="text-xs text-slate-500 mb-3">Only checked products will appear when creating tickets for this customer. Leave all unchecked to allow all products.</p>
          <div id="allowed-products-checkboxes" class="grid grid-cols-2 gap-2">
            <!-- Populated dynamically -->
          </div>
        </div>
        
        <!-- Email Settings Section -->
        <div class="border-t-2 border-slate-100 pt-4 mt-2">
          <h4 class="text-sm font-bold text-slate-800 mb-2">üìß Email Settings</h4>
          <div class="flex items-center justify-between bg-slate-50 rounded-xl p-4">
            <div>
              <div class="font-medium text-slate-900">Auto-Email Ticket Receipts</div>
              <div class="text-xs text-slate-500">Automatically email this customer when tickets are created</div>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" name="emailReceipts" id="edit-customer-emailReceipts" class="sr-only peer">
              <div class="w-11 h-6 bg-slate-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-gold-500/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
            </label>
          </div>
          <p class="text-xs text-slate-500 mt-2">üí° Requires an email address above. Tickets will be emailed to the main Email or Bill To Email.</p>
        </div>
        
        <div class="pt-4 flex gap-3">
          <button type="button" onclick="confirmDeleteCustomer()" class="px-4 py-3 border-2 border-red-200 text-red-600 font-semibold rounded-xl hover:bg-red-50 transition-all flex items-center justify-center gap-1">
            <span>üóëÔ∏è</span> Delete
          </button>
          <button type="button" onclick="closeModal('edit-customer-modal')" class="flex-1 px-4 py-3 border-2 border-slate-200 text-slate-600 font-semibold rounded-xl hover:bg-slate-50 transition-all">Cancel</button>
          <button type="submit" id="edit-customer-btn" class="flex-1 px-4 py-3 bg-gold-500 hover:bg-gold-600 text-slate-900 font-semibold rounded-xl transition-all flex items-center justify-center gap-2">
            <span id="edit-customer-text">Save Changes</span>
            <span id="edit-customer-spinner" class="spinner hidden"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-confirm-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full overflow-hidden">
      <div class="bg-red-600 px-6 py-5">
        <h2 class="text-xl font-bold text-white flex items-center gap-2">‚ö†Ô∏è Delete Customer</h2>
      </div>
      <div class="p-6">
        <p class="text-slate-700 mb-2">Are you sure you want to delete:</p>
        <p class="text-lg font-bold text-slate-900 mb-4" id="delete-customer-name"></p>
        <p class="text-sm text-slate-500 mb-6">This action cannot be undone. The customer will be permanently removed from the system.</p>
        <div class="flex gap-3">
          <button type="button" onclick="closeModal('delete-confirm-modal')" class="flex-1 px-4 py-3 border-2 border-slate-200 text-slate-600 font-semibold rounded-xl hover:bg-slate-50 transition-all">Cancel</button>
          <button type="button" onclick="executeDeleteCustomer()" id="delete-confirm-btn" class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-xl transition-all flex items-center justify-center gap-2">
            <span id="delete-btn-text">Delete Customer</span>
            <span id="delete-spinner" class="spinner hidden"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Upload Customers Modal -->
  <div id="upload-customers-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full">
      <div class="bg-gradient-to-r from-slate-900 to-slate-800 px-6 py-5 flex items-center justify-between">
        <h2 class="text-xl font-bold text-white">üì§ Upload Customers</h2>
        <button type="button" onclick="closeModal('upload-customers-modal')" class="text-slate-400 hover:text-white transition-colors p-2">‚úï</button>
      </div>
      <div class="p-6">
        <div id="upload-zone" class="upload-zone rounded-xl p-8 text-center cursor-pointer" onclick="document.getElementById('csv-file-input').click()">
          <div class="text-4xl mb-3">üìÑ</div>
          <p class="font-semibold text-slate-700">Drop CSV file here or click to browse</p>
          <p class="text-sm text-slate-500 mt-1">Duplicates will be automatically skipped</p>
          <input type="file" id="csv-file-input" accept=".csv" class="hidden">
        </div>
        
        <div id="upload-preview" class="hidden mt-4">
          <div class="bg-slate-50 rounded-xl p-4">
            <p class="font-semibold text-slate-900">üìÑ <span id="upload-filename"></span></p>
            <p class="text-sm text-slate-500 mt-1"><span id="upload-count">0</span> customers found</p>
            <p class="text-sm text-emerald-600 mt-1"><span id="upload-new-count">0</span> new, <span id="upload-skip-count">0</span> duplicates will be skipped</p>
          </div>
          <div class="mt-4 flex gap-3">
            <button type="button" onclick="cancelUpload()" class="flex-1 px-4 py-3 border-2 border-slate-200 text-slate-600 font-semibold rounded-xl hover:bg-slate-50 transition-all">Cancel</button>
            <button type="button" onclick="confirmUpload()" id="upload-confirm-btn" class="flex-1 px-4 py-3 bg-gold-500 hover:bg-gold-600 text-slate-900 font-semibold rounded-xl transition-all flex items-center justify-center gap-2">
              <span id="upload-btn-text">Import Customers</span>
              <span id="upload-spinner" class="spinner hidden"></span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Carrier Modal -->
  <div id="add-carrier-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-auto">
      <div class="bg-gradient-to-r from-slate-900 to-slate-800 px-6 py-5 flex items-center justify-between">
        <h2 class="text-xl font-bold text-white">üöõ Add Carrier</h2>
        <button type="button" onclick="closeModal('add-carrier-modal')" class="text-slate-400 hover:text-white transition-colors p-2">‚úï</button>
      </div>
      <form id="add-carrier-form" class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">Carrier Name <span class="text-red-500">*</span></label>
          <input type="text" name="carrierName" required placeholder="e.g., ABC Transport" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">Contact Phone</label>
            <input type="tel" name="carrierPhone" placeholder="541-555-1234" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">Contact Email</label>
            <input type="email" name="carrierEmail" placeholder="dispatch@carrier.com" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
          </div>
        </div>
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">Street Address</label>
          <input type="text" name="carrierAddress" placeholder="123 Main St" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
        </div>
        <div class="grid grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">City</label>
            <input type="text" name="carrierCity" placeholder="City" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">State</label>
            <input type="text" name="carrierState" maxlength="2" placeholder="OR" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">Zip</label>
            <input type="text" name="carrierZip" placeholder="97701" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
          </div>
        </div>
        <div class="pt-4 flex gap-3">
          <button type="button" onclick="closeModal('add-carrier-modal')" class="flex-1 px-4 py-3 border-2 border-slate-200 text-slate-600 font-semibold rounded-xl hover:bg-slate-50 transition-all">Cancel</button>
          <button type="submit" class="flex-1 px-4 py-3 bg-gold-500 hover:bg-gold-600 text-slate-900 font-semibold rounded-xl transition-all">Add Carrier</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Carrier Modal -->
  <div id="edit-carrier-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full">
      <div class="bg-gradient-to-r from-slate-900 to-slate-800 px-6 py-5 flex items-center justify-between">
        <h2 class="text-xl font-bold text-white">‚úèÔ∏è Edit Carrier</h2>
        <button type="button" onclick="closeModal('edit-carrier-modal')" class="text-slate-400 hover:text-white transition-colors p-2">‚úï</button>
      </div>
      <form id="edit-carrier-form" class="p-6 space-y-4">
        <input type="hidden" name="carrierId" id="edit-carrier-id">
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">Carrier Name <span class="text-red-500">*</span></label>
          <input type="text" name="carrierName" id="edit-carrier-name" required class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">Contact Phone</label>
            <input type="tel" name="carrierPhone" id="edit-carrier-phone" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">Contact Email</label>
            <input type="email" name="carrierEmail" id="edit-carrier-email" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
          </div>
        </div>
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">Street Address</label>
          <input type="text" name="carrierAddress" id="edit-carrier-address" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
        </div>
        <div class="grid grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">City</label>
            <input type="text" name="carrierCity" id="edit-carrier-city" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">State</label>
            <input type="text" name="carrierState" id="edit-carrier-state" maxlength="2" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">Zip</label>
            <input type="text" name="carrierZip" id="edit-carrier-zip" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
          </div>
        </div>
        <div class="pt-4 flex gap-3">
          <button type="button" onclick="confirmDeleteCarrier()" class="px-4 py-3 border-2 border-red-200 text-red-600 font-semibold rounded-xl hover:bg-red-50 transition-all">üóëÔ∏è Delete</button>
          <button type="button" onclick="closeModal('edit-carrier-modal')" class="flex-1 px-4 py-3 border-2 border-slate-200 text-slate-600 font-semibold rounded-xl hover:bg-slate-50 transition-all">Cancel</button>
          <button type="submit" class="flex-1 px-4 py-3 bg-gold-500 hover:bg-gold-600 text-slate-900 font-semibold rounded-xl transition-all">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Truck Modal -->
  <div id="add-truck-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full">
      <div class="bg-gradient-to-r from-slate-900 to-slate-800 px-6 py-5 flex items-center justify-between">
        <h2 class="text-xl font-bold text-white">üöö Add Truck</h2>
        <button type="button" onclick="closeModal('add-truck-modal')" class="text-slate-400 hover:text-white transition-colors p-2">‚úï</button>
      </div>
      <form id="add-truck-form" class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">Truck ID <span class="text-red-500">*</span></label>
          <input type="text" name="truckId" required placeholder="e.g., 24 Double J" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
          <p class="text-xs text-slate-400 mt-1">Unique identifier for this truck</p>
        </div>
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">Carrier</label>
          <select name="truckCarrier" id="add-truck-carrier" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
            <option value="">-- Select Carrier --</option>
          </select>
        </div>
        <div class="pt-4 flex gap-3">
          <button type="button" onclick="closeModal('add-truck-modal')" class="flex-1 px-4 py-3 border-2 border-slate-200 text-slate-600 font-semibold rounded-xl hover:bg-slate-50 transition-all">Cancel</button>
          <button type="submit" class="flex-1 px-4 py-3 bg-gold-500 hover:bg-gold-600 text-slate-900 font-semibold rounded-xl transition-all">Add Truck</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Truck Modal -->
  <div id="edit-truck-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full">
      <div class="bg-gradient-to-r from-slate-900 to-slate-800 px-6 py-5 flex items-center justify-between">
        <h2 class="text-xl font-bold text-white">‚úèÔ∏è Edit Truck</h2>
        <button type="button" onclick="closeModal('edit-truck-modal')" class="text-slate-400 hover:text-white transition-colors p-2">‚úï</button>
      </div>
      <form id="edit-truck-form" class="p-6 space-y-4">
        <input type="hidden" name="truckIndex" id="edit-truck-index">
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">Truck ID <span class="text-red-500">*</span></label>
          <input type="text" name="truckId" id="edit-truck-id" required class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
        </div>
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">Carrier</label>
          <select name="truckCarrier" id="edit-truck-carrier" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
            <option value="">-- Select Carrier --</option>
          </select>
        </div>
        <div class="pt-4 flex gap-3">
          <button type="button" onclick="confirmDeleteTruck()" class="px-4 py-3 border-2 border-red-200 text-red-600 font-semibold rounded-xl hover:bg-red-50 transition-all">üóëÔ∏è Delete</button>
          <button type="button" onclick="closeModal('edit-truck-modal')" class="flex-1 px-4 py-3 border-2 border-slate-200 text-slate-600 font-semibold rounded-xl hover:bg-slate-50 transition-all">Cancel</button>
          <button type="submit" class="flex-1 px-4 py-3 bg-gold-500 hover:bg-gold-600 text-slate-900 font-semibold rounded-xl transition-all">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add User Modal -->
  <div id="add-user-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full">
      <div class="bg-gradient-to-r from-slate-900 to-slate-800 px-6 py-5 flex items-center justify-between">
        <h2 class="text-xl font-bold text-white">‚ûï Add User</h2>
        <button type="button" onclick="closeModal('add-user-modal')" class="text-slate-400 hover:text-white transition-colors p-2">‚úï</button>
      </div>
      <form id="add-user-form" class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">Name <span class="text-red-500">*</span></label>
          <input type="text" name="userName" required class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
        </div>
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">Role <span class="text-red-500">*</span></label>
          <select name="userRole" required class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
            <option value="user">üë∑ Operator</option>
            <option value="finance">üí∞ Finance</option>
            <option value="admin">üëë Admin</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">PIN (4 digits) <span class="text-red-500">*</span></label>
          <input type="text" name="userPin" required maxlength="4" pattern="[0-9]{4}" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500 font-mono text-center tracking-widest text-xl">
        </div>
        <div class="pt-4 flex gap-3">
          <button type="button" onclick="closeModal('add-user-modal')" class="flex-1 px-4 py-3 border-2 border-slate-200 text-slate-600 font-semibold rounded-xl hover:bg-slate-50 transition-all">Cancel</button>
          <button type="submit" class="flex-1 px-4 py-3 bg-gold-500 hover:bg-gold-600 text-slate-900 font-semibold rounded-xl transition-all">Add User</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div id="edit-user-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full">
      <div class="bg-gradient-to-r from-slate-900 to-slate-800 px-6 py-5 flex items-center justify-between">
        <h2 class="text-xl font-bold text-white">‚úèÔ∏è Edit User</h2>
        <button type="button" onclick="closeModal('edit-user-modal')" class="text-slate-400 hover:text-white transition-colors p-2">‚úï</button>
      </div>
      <form id="edit-user-form" class="p-6 space-y-4">
        <input type="hidden" id="edit-user-id">
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">Name <span class="text-red-500">*</span></label>
          <input type="text" id="edit-user-name" required class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
        </div>
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">Role <span class="text-red-500">*</span></label>
          <select id="edit-user-role" required class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
            <option value="user">üë∑ Operator</option>
            <option value="finance">üí∞ Finance</option>
            <option value="admin">üëë Admin</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">PIN (4 digits) <span class="text-red-500">*</span></label>
          <input type="text" id="edit-user-pin" required maxlength="4" pattern="[0-9]{4}" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500 font-mono text-center tracking-widest text-xl">
        </div>
        <div class="pt-4 flex gap-3">
          <button type="button" onclick="deleteUser()" class="px-4 py-3 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-xl transition-all">üóëÔ∏è Delete</button>
          <button type="button" onclick="closeModal('edit-user-modal')" class="flex-1 px-4 py-3 border-2 border-slate-200 text-slate-600 font-semibold rounded-xl hover:bg-slate-50 transition-all">Cancel</button>
          <button type="submit" class="flex-1 px-4 py-3 bg-gold-500 hover:bg-gold-600 text-slate-900 font-semibold rounded-xl transition-all">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Product Modal -->
  <div id="edit-product-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full">
      <div class="bg-gradient-to-r from-slate-900 to-slate-800 px-6 py-5 flex items-center justify-between">
        <h2 class="text-xl font-bold text-white">üì¶ Edit Product</h2>
        <button type="button" onclick="closeModal('edit-product-modal')" class="text-slate-400 hover:text-white transition-colors p-2">‚úï</button>
      </div>
      <form id="edit-product-form" class="p-6 space-y-4">
        <input type="hidden" name="productId">
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">Product Name <span class="text-red-500">*</span></label>
          <input type="text" name="productName" required class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500 bg-slate-100" readonly>
        </div>
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">Lbs per Yard <span class="text-red-500">*</span></label>
          <input type="number" name="productWeight" required min="1" step="1" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
          <p class="text-xs text-slate-500 mt-1">Weight in pounds per cubic yard (for yard calculations)</p>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">Default $/Yard</label>
            <div class="relative">
              <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">$</span>
              <input type="number" name="productPriceYard" min="0" step="0.01" class="w-full pl-7 pr-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
            </div>
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">Default $/Ton</label>
            <div class="relative">
              <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">$</span>
              <input type="number" name="productPriceTon" min="0" step="0.01" class="w-full pl-7 pr-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500">
            </div>
          </div>
        </div>
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">QuickBooks Item Code</label>
          <input type="text" name="productQBCode" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-gold-500" placeholder="e.g., PUMICE-38MIN">
          <p class="text-xs text-slate-500 mt-1">Used in QuickBooks exports</p>
        </div>
        <div id="product-airtable-warning" class="hidden bg-amber-50 border border-amber-200 rounded-lg p-3">
          <p class="text-sm text-amber-800">‚ö†Ô∏è This product is not linked to Airtable. Changes will only be saved locally.</p>
        </div>
        <div class="pt-4 flex gap-3">
          <button type="button" onclick="closeModal('edit-product-modal')" class="flex-1 px-4 py-3 border-2 border-slate-200 text-slate-600 font-semibold rounded-xl hover:bg-slate-50 transition-all">Cancel</button>
          <button type="submit" id="save-product-btn" class="flex-1 px-4 py-3 bg-gold-500 hover:bg-gold-600 text-slate-900 font-semibold rounded-xl transition-all">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast Container -->
  <!-- Edit Ticket Modal (Admin Only) -->
  <div id="edit-ticket-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-auto">
      <div class="bg-gradient-to-r from-slate-900 to-slate-800 px-6 py-5 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gold-500 rounded-lg flex items-center justify-center">
            <span class="text-slate-900 text-xl">‚úèÔ∏è</span>
          </div>
          <div>
            <h2 class="text-xl font-bold text-white">Edit Ticket #<span id="edit-ticket-number"></span></h2>
            <p class="text-slate-400 text-sm">Admin edit mode</p>
          </div>
        </div>
        <button type="button" onclick="closeModal('edit-ticket-modal')" class="text-slate-400 hover:text-white transition-colors p-2">‚úï</button>
      </div>
      <form id="edit-ticket-form" class="p-6 space-y-5">
        <input type="hidden" id="edit-ticket-id">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Customer</label>
            <select id="edit-ticket-customer" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-gold-500 text-lg bg-white">
              <option value="">Select customer...</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Hauling For</label>
            <select id="edit-ticket-carrier" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-gold-500 text-lg bg-white">
              <option value="">Select carrier...</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Truck</label>
            <input type="text" id="edit-ticket-truck" placeholder="e.g., 12 Mike S or Double J #4" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-gold-500 text-lg">
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Product</label>
            <select id="edit-ticket-product" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-gold-500 text-lg bg-white">
              <option value="">Select product...</option>
            </select>
          </div>
        </div>

        <div class="bg-slate-50 rounded-xl p-5 border border-slate-200">
          <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 bg-slate-200 rounded-lg flex items-center justify-center text-lg">‚öñÔ∏è</span>
            Scale Weights
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-2">Tare Weight (lbs)</label>
              <input type="number" id="edit-ticket-tare" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-gold-500 text-lg font-mono bg-white">
            </div>
            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-2">Gross Weight (lbs)</label>
              <input type="number" id="edit-ticket-gross" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-gold-500 text-lg font-mono bg-white">
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">PO Number</label>
            <input type="text" id="edit-ticket-po" placeholder="Customer PO #" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-gold-500 bg-white">
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Ticket Note</label>
            <input type="text" id="edit-ticket-note" placeholder="Special instructions..." class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-gold-500 bg-white">
          </div>
        </div>

        <!-- Freight Section (Edit Modal) -->
        <div class="mt-4 p-4 bg-blue-50 border-2 border-blue-200 rounded-xl">
          <div class="flex items-center gap-2 mb-3">
            <span class="text-blue-600 text-lg">üöö</span>
            <h4 class="font-semibold text-blue-800">Freight</h4>
          </div>
          <div class="grid grid-cols-3 gap-4">
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1">Cost (pay carrier)</label>
              <div class="relative">
                <span class="absolute left-3 top-2.5 text-slate-500 text-sm">$</span>
                <input type="number" id="edit-ticket-freight-cost" placeholder="0.00" step="0.01" min="0" class="w-full pl-7 pr-3 py-2 border-2 border-slate-200 rounded-lg focus:border-blue-500 bg-white text-sm" oninput="calculateEditFreightMargin()">
              </div>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1">Charge (bill customer)</label>
              <div class="relative">
                <span class="absolute left-3 top-2.5 text-slate-500 text-sm">$</span>
                <input type="number" id="edit-ticket-freight-charge" placeholder="0.00" step="0.01" min="0" class="w-full pl-7 pr-3 py-2 border-2 border-slate-200 rounded-lg focus:border-blue-500 bg-white text-sm" oninput="calculateEditFreightMargin()">
              </div>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1">Margin (profit)</label>
              <div class="relative">
                <span class="absolute left-3 top-2.5 text-slate-500 text-sm">$</span>
                <input type="text" id="edit-ticket-freight-margin" readonly class="w-full pl-7 pr-3 py-2 border-2 border-green-200 rounded-lg bg-green-50 text-green-700 font-semibold text-sm">
              </div>
            </div>
          </div>
        </div>

        <div class="pt-4 flex gap-3">
          <button type="button" onclick="closeModal('edit-ticket-modal')" class="flex-1 px-4 py-3 border-2 border-slate-200 text-slate-600 font-semibold rounded-xl hover:bg-slate-50 transition-all">Cancel</button>
          <button type="submit" class="flex-1 px-4 py-3 bg-gold-500 hover:bg-gold-600 text-slate-900 font-bold rounded-xl transition-all">üíæ Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- QuickBooks Export Modal (Phase 2) -->
  <div id="quickbooks-export-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50" onclick="closeModal('quickbooks-export-modal')"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden relative">
        <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-5">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
              <span class="text-white text-xl">üíº</span>
            </div>
            <div>
              <h2 class="text-xl font-bold text-white">QuickBooks Export</h2>
              <p class="text-blue-200 text-sm">Generate IIF file for QuickBooks Desktop</p>
            </div>
          </div>
        </div>
        
        <div class="p-6 space-y-4">
          <div class="bg-blue-50 rounded-xl p-4 border border-blue-200">
            <p class="text-blue-800 font-medium">
              <span class="text-2xl mr-2">üé´</span>
              <span id="qb-export-count">0</span> tickets selected for export
            </p>
          </div>
          
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Invoice Date</label>
            <input type="date" id="qb-invoice-date" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 bg-white">
          </div>
          
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Starting Invoice Number</label>
            <input type="number" id="qb-starting-invoice" value="10" min="1" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 bg-white font-mono">
          </div>
          
          <div class="space-y-3">
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="qb-group-by-customer" checked class="w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
              <span class="text-sm text-slate-700">Group tickets by customer (one invoice per customer)</span>
            </label>
            
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="qb-mark-exported" checked class="w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
              <span class="text-sm text-slate-700">Mark tickets as "Exported" after download</span>
            </label>
          </div>
          
          <div class="bg-amber-50 rounded-xl p-4 border border-amber-200">
            <p class="text-amber-800 text-sm">
              <strong>Note:</strong> The IIF file will download automatically. Import it into QuickBooks Desktop via File ‚Üí Utilities ‚Üí Import ‚Üí IIF Files.
            </p>
          </div>
        </div>
        
        <div class="border-t border-slate-200 px-6 py-4 bg-slate-50 flex gap-3 justify-end">
          <button type="button" onclick="closeModal('quickbooks-export-modal')" class="px-4 py-2 text-slate-600 hover:text-slate-800 font-medium">
            Cancel
          </button>
          <button type="button" id="qb-export-btn" onclick="executeQuickBooksExport()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-6 rounded-xl transition-all flex items-center gap-2">
            <span>üì•</span> Download IIF File
          </button>
        </div>
      </div>
    </div>
  </div>


  <div id="toast-container"></div>

  <script>
    // ==================== CONFIGURATION ====================
    const CONFIG = {
      API_BASE: '', // Same origin - uses relative paths
      PRINT_URL: 'https://beaver-pumice-ticket-viewer.netlify.app',
      CUSTOMERS_TABLE_ID: 'tblAQKBdGWHeLz1WO'
    };

    // ==================== DATA ====================
    let PRODUCTS = [
      { id: 'prod_1', airtableId: null, name: '1 x 3/8', lbsPerYard: 1215 },
      { id: 'prod_2', airtableId: null, name: '1/4 x minus', lbsPerYard: 1485 },
      { id: 'prod_3', airtableId: null, name: '3/8 x 1/16', lbsPerYard: 1080 },
      { id: 'prod_4', airtableId: null, name: '3/8 x minus', lbsPerYard: 1350 },
      { id: 'prod_5', airtableId: null, name: '3/8 x 1/4', lbsPerYard: 1026 },
    ];

    // Customers loaded from Airtable
    let CUSTOMERS = [];

    let CARRIERS = [];

    let TRUCKS = [];

    let tickets = [];

    let USERS = [
      { id: 'admin', name: 'Lucas', role: 'admin', pin: '1234', icon: 'üëë', label: 'Administrator' },
      { id: 'admin2', name: 'Brent', role: 'admin', pin: '5678', icon: 'üëë', label: 'Administrator' },
      { id: 'finance', name: 'Jesse', role: 'admin', pin: '1357', icon: 'üí∞', label: 'Finance/Admin' },
      { id: 'user', name: 'Doug', role: 'user', pin: '0000', icon: 'üë∑', label: 'Operator' }
    ];

    let currentUser = null;
    let currentTicket = null;
    let lastCreatedTicket = null;
    let customerViewMode = 'cards';
    let pendingCSVData = null;
    let airtableConnected = false;

    // ==================== API FUNCTIONS ====================
    async function loadCustomersFromAirtable(showFeedback = false) {
      try {
        const response = await fetch('/api/customers');
        if (!response.ok) throw new Error('Failed to fetch customers');
        
        const data = await response.json();
        if (data.success && data.customers) {
          CUSTOMERS = data.customers;
          airtableConnected = true;
          console.log(`Loaded ${CUSTOMERS.length} customers from Airtable`);
          
          // Update UI if we're already logged in
          if (currentUser) {
            populateDropdowns();
            renderCustomers();
            updateStats();
          }
          
          if (showFeedback) {
            showToast(`Loaded ${CUSTOMERS.length} customers from Airtable`);
          }
          return true;
        }
        return false;
      } catch (error) {
        console.error('Error loading customers:', error);
        airtableConnected = false;
        if (showFeedback) {
          showToast('Failed to load customers: ' + error.message, 'error');
        }
        return false;
      }
    }

    async function reloadCustomers() {
      showToast('Reloading customers...', 'info');
      await loadCustomersFromAirtable(true);
    }

    async function addCustomerToAirtable(customer) {
      try {
        const response = await fetch('/api/customers/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(customer)
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to add customer');
        }
        
        const data = await response.json();
        if (data.success && data.customer) {
          return data.customer;
        }
        throw new Error('Invalid response');
      } catch (error) {
        console.error('Error adding customer:', error);
        throw error;
      }
    }

    async function updateCustomerInAirtable(customer) {
      try {
        const response = await fetch('/api/customers/update', {
          method: 'POST', // Using POST for broader compatibility
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(customer)
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to update customer');
        }
        
        const data = await response.json();
        if (data.success && data.customer) {
          // Attach warning if present
          if (data.warning) {
            data.customer._warning = data.warning;
          }
          return data.customer;
        }
        throw new Error('Invalid response');
      } catch (error) {
        console.error('Error updating customer:', error);
        throw error;
      }
    }

    async function importCustomersToAirtable(customers) {
      try {
        const response = await fetch('/api/customers/import', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ customers, skipDuplicates: true })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to import customers');
        }
        
        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Error importing customers:', error);
        throw error;
      }
    }

    async function deleteCustomerFromAirtable(customerId) {
      try {
        const response = await fetch('/api/customers/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: customerId })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to delete customer');
        }
        
        const data = await response.json();
        if (data.success) {
          return true;
        }
        throw new Error('Invalid response');
      } catch (error) {
        console.error('Error deleting customer:', error);
        throw error;
      }
    }

    // Products API Functions
    async function loadProductsFromAirtable(showFeedback = false) {
      try {
        const response = await fetch('/api/products');
        if (!response.ok) {
          if (response.status === 500) {
            console.log('Products table not configured - using defaults');
            return false;
          }
          throw new Error('Failed to fetch products');
        }
        
        const data = await response.json();
        if (data.success && data.products && data.products.length > 0) {
          PRODUCTS = data.products.map((p, index) => ({
            id: `prod_${index + 1}`,
            airtableId: p.id,
            name: p.name,
            lbsPerYard: p.lbsPerYard,
            priceYard: p.priceYard,
            priceTon: p.priceTon,
            qbCode: p.qbCode || ''
          }));
          console.log(`Loaded ${PRODUCTS.length} products from Airtable`);
          
          // Update UI
          if (currentUser) {
            populateDropdowns();
            renderSettings();
          }
          
          if (showFeedback) {
            showToast(`Loaded ${PRODUCTS.length} products from Airtable`);
          }
          return true;
        }
        return false;
      } catch (error) {
        console.error('Error loading products:', error);
        if (showFeedback) {
          showToast('Using default products (Airtable not configured)', 'info');
        }
        return false;
      }
    }

    async function updateProductInAirtable(product) {
      try {
        if (!product.airtableId) {
          throw new Error('Product not linked to Airtable');
        }
        
        const response = await fetch('/api/products/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: product.airtableId,
            name: product.name,
            lbsPerYard: product.lbsPerYard,
            priceYard: product.priceYard,
            priceTon: product.priceTon,
            qbCode: product.qbCode
          })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to update product');
        }
        
        const data = await response.json();
        if (data.success) {
          return data.product;
        }
        throw new Error('Invalid response');
      } catch (error) {
        console.error('Error updating product:', error);
        throw error;
      }
    }

    // ==================== TOAST NOTIFICATIONS ====================
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    // ==================== LOGIN ====================
    const loginUserSelect = document.getElementById('login-user');
    const loginPinInput = document.getElementById('login-pin');
    const loginBtn = document.getElementById('login-btn');
    const loginBtnText = document.getElementById('login-btn-text');
    const passwordField = document.getElementById('password-field');
    const loginError = document.getElementById('login-error');

    loginUserSelect.addEventListener('change', function() {
      loginError.classList.add('hidden');
      if (this.value) {
        passwordField.classList.remove('hidden');
        loginBtn.disabled = false;
        loginBtn.className = 'w-full bg-gradient-to-r from-gold-600 to-gold-500 hover:from-gold-700 hover:to-gold-600 text-slate-900 font-bold py-4 px-6 rounded-xl text-lg cursor-pointer transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2';
        loginBtnText.textContent = 'Sign In';
        setTimeout(() => loginPinInput.focus(), 100);
      } else {
        passwordField.classList.add('hidden');
        loginBtn.disabled = true;
        loginBtn.className = 'w-full bg-slate-200 text-slate-400 font-bold py-4 px-6 rounded-xl text-lg cursor-not-allowed transition-all flex items-center justify-center gap-2';
        loginBtnText.textContent = 'Select a role to continue';
      }
    });

    loginPinInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        handleLogin();
      }
    });

    loginBtn.addEventListener('click', function(e) {
      e.preventDefault();
      handleLogin();
    });

    function handleLogin() {
      const userType = loginUserSelect.value;
      const pin = loginPinInput.value;
      
      if (!userType) {
        showLoginError('Please select a role');
        return;
      }
      
      if (!pin) {
        showLoginError('Please enter your PIN');
        return;
      }
      
      const user = USERS.find(u => u.id === userType);
      if (!user || pin !== user.pin) {
        showLoginError('Incorrect PIN. Please try again.');
        loginPinInput.value = '';
        loginPinInput.focus();
        return;
      }
      
      currentUser = { ...user };
      
      // Set role class on body for CSS visibility rules
      document.body.classList.remove('role-admin', 'role-finance', 'role-operator');
      document.body.classList.add(`role-${user.role}`);
      
      const loginKey = `bp_login_count_${userType}`;
      const loginCount = parseInt(localStorage.getItem(loginKey) || '0') + 1;
      localStorage.setItem(loginKey, loginCount.toString());
      
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('login-screen').classList.remove('flex');
      document.getElementById('main-app').classList.remove('hidden');
      
      setupUserInterface();
      
      if (loginCount <= 3) {
        setTimeout(() => showTutorial(user.role, loginCount), 500);
      }
    }

    function showLoginError(msg) {
      loginError.textContent = msg;
      loginError.classList.remove('hidden');
    }

    function logout() {
      currentUser = null;
      document.body.classList.remove('role-admin', 'role-finance', 'role-operator');
      document.getElementById('main-app').classList.add('hidden');
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('login-screen').classList.add('flex');
      loginUserSelect.value = '';
      loginPinInput.value = '';
      passwordField.classList.add('hidden');
      loginBtn.disabled = true;
      loginBtn.className = 'w-full bg-slate-200 text-slate-400 font-bold py-4 px-6 rounded-xl text-lg cursor-not-allowed transition-all flex items-center justify-center gap-2';
      loginBtnText.textContent = 'Select a role to continue';
      loginError.classList.add('hidden');
    }

    // ==================== TUTORIAL ====================
    const TUTORIALS = {
      admin: [
        { icon: 'üëã', title: 'Welcome, Admin!', text: 'This is your Dashboard where you can see all quarry stats at a glance. You have full access to manage customers, trucks, pricing, and settings.' },
        { icon: '‚ûï', title: 'Create Tickets', text: 'Click "New Ticket" to create a new load ticket. You\'ll enter customer, truck, product, and weight info.' },
        { icon: 'üë•', title: 'Manage Customers', text: 'View customers as cards or list, add new customers, upload CSV files, and edit existing customer information.' },
        { icon: 'üìä', title: 'Reports & QuickBooks', text: 'Use Reports to export data, generate PDFs, and create QuickBooks IIF files for billing.' },
        { icon: 'üìö', title: 'Training & Help', text: 'Find training guides in Settings ‚Üí Help & Training. There\'s an Admin Guide, Operator Guide, and printable cheat sheet for the scale house.' },
        { icon: '‚ùì', title: 'Need Help?', text: 'Click the ? button (bottom-right) anytime for quick access to guides and support. You can also email support@resultantai.com.' }
      ],
      user: [
        { icon: 'üëã', title: 'Welcome, Operator!', text: 'Your main job is creating and printing tickets. Let\'s show you how it works!' },
        { icon: '‚ûï', title: 'Create New Ticket', text: 'Tap the big gold button to start a new load entry whenever a truck arrives.' },
        { icon: 'üñ®Ô∏è', title: 'Print Tickets', text: 'After creating a ticket, click the Print button to get a physical copy.' },
        { icon: 'üìö', title: 'Training & Help', text: 'Scroll down on your home screen to find Help & Training with step-by-step guides. You can also print a cheat sheet to post at the scale!' },
        { icon: '‚ùì', title: 'Need Help?', text: 'Click the ? button (bottom-right corner) anytime. If something\'s not working, call the office or email support@resultantai.com.' }
      ]
    };

    let tutorialStep = 0;
    let tutorialRole = null;

    function showTutorial(role, loginCount) {
      tutorialRole = role;
      tutorialStep = 0;
      
      const modal = document.getElementById('tutorial-modal');
      modal.classList.remove('hidden');
      
      if (loginCount === 1) {
        renderTutorialStep();
      } else {
        document.getElementById('tutorial-box').innerHTML = `
          <div class="text-center">
            <div class="w-16 h-16 bg-gold-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <span class="text-3xl">üëã</span>
            </div>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Welcome back!</h3>
            <p class="text-slate-600 mb-6">Need a refresher on how things work?</p>
            <div class="flex gap-3 justify-center">
              <button type="button" onclick="closeTutorial()" class="px-4 py-2 text-slate-600 hover:text-slate-900 font-medium">No thanks</button>
              <button type="button" onclick="startFullTutorial()" class="bg-gold-500 hover:bg-gold-600 text-slate-900 font-semibold py-2 px-5 rounded-xl transition-all">Show me</button>
            </div>
          </div>
        `;
      }
    }

    function startFullTutorial() {
      tutorialStep = 0;
      document.getElementById('tutorial-box').innerHTML = `
        <div class="flex items-start gap-4">
          <div class="w-14 h-14 bg-gold-100 rounded-xl flex items-center justify-center flex-shrink-0">
            <span id="tutorial-icon" class="text-3xl">üëã</span>
          </div>
          <div class="flex-1">
            <p class="text-xs text-gold-600 font-semibold uppercase tracking-wide mb-1">
              Step <span id="tutorial-step-num">1</span> of <span id="tutorial-step-total">4</span>
            </p>
            <h3 id="tutorial-title" class="text-xl font-bold text-slate-900 mb-2">Welcome!</h3>
            <p id="tutorial-text" class="text-slate-600 leading-relaxed"></p>
          </div>
        </div>
        <div class="flex items-center justify-between mt-6 pt-4 border-t border-slate-100">
          <button type="button" onclick="closeTutorial()" class="text-slate-400 hover:text-slate-600 text-sm font-medium transition-colors px-3 py-2">
            Skip tutorial
          </button>
          <button type="button" onclick="nextTutorialStep()" class="bg-gold-500 hover:bg-gold-600 text-slate-900 font-semibold py-2.5 px-6 rounded-xl transition-all">
            Next ‚Üí
          </button>
        </div>
      `;
      renderTutorialStep();
    }

    function renderTutorialStep() {
      const steps = TUTORIALS[tutorialRole];
      if (!steps || tutorialStep >= steps.length) {
        closeTutorial();
        return;
      }
      
      const step = steps[tutorialStep];
      
      const iconEl = document.getElementById('tutorial-icon');
      const stepNumEl = document.getElementById('tutorial-step-num');
      const stepTotalEl = document.getElementById('tutorial-step-total');
      const titleEl = document.getElementById('tutorial-title');
      const textEl = document.getElementById('tutorial-text');
      const nextBtn = document.querySelector('#tutorial-box button[onclick="nextTutorialStep()"]');
      
      if (iconEl) iconEl.textContent = step.icon;
      if (stepNumEl) stepNumEl.textContent = tutorialStep + 1;
      if (stepTotalEl) stepTotalEl.textContent = steps.length;
      if (titleEl) titleEl.textContent = step.title;
      if (textEl) textEl.textContent = step.text;
      if (nextBtn) {
        nextBtn.textContent = tutorialStep === steps.length - 1 ? 'Get Started! üéâ' : 'Next ‚Üí';
      }
    }

    function nextTutorialStep() {
      tutorialStep++;
      if (tutorialStep >= TUTORIALS[tutorialRole].length) {
        closeTutorial();
      } else {
        renderTutorialStep();
      }
    }

    function closeTutorial() {
      document.getElementById('tutorial-modal').classList.add('hidden');
      tutorialRole = null;
      tutorialStep = 0;
    }

    function resetTutorial() {
      localStorage.removeItem('bp_login_count_admin');
      localStorage.removeItem('bp_login_count_user');
      showToast('Tutorial reset! It will show again on next login.');
    }

    // ==================== UI SETUP ====================
    function setupUserInterface() {
      document.getElementById('user-name').textContent = currentUser.name;
      document.getElementById('user-role-display').textContent = currentUser.label;
      document.getElementById('user-icon').textContent = currentUser.icon;
      
      const badge = document.getElementById('user-badge');
      const roleClass = currentUser.role === 'admin' ? 'badge-role-admin' 
        : currentUser.role === 'finance' ? 'badge-role-finance' 
        : 'badge-role-user';
      badge.className = roleClass + ' w-10 h-10 rounded-full flex items-center justify-center';
      
      setupNavigation();
      
      const isAdmin = currentUser.role === 'admin';
      document.getElementById('customer-admin-actions').classList.toggle('hidden', !isAdmin);
      document.getElementById('trucks-admin-actions').classList.toggle('hidden', !isAdmin);
      
      goHome();
      
      const hour = new Date().getHours();
      const greeting = hour < 12 ? 'morning' : hour < 17 ? 'afternoon' : 'evening';
      const greetingEl = document.getElementById('greeting-time');
      if (greetingEl) greetingEl.textContent = greeting;
      
      populateDropdowns();
      updateStats();
      renderRecentActivity();
      renderTicketsTable();
    }

    function goHome() {
      if (currentUser?.role === 'admin') {
        showView('dashboard');
      } else if (currentUser?.role === 'finance') {
        showView('tickets');
      } else {
        showView('operator-home');
      }
    }

    function setupNavigation() {
      const nav = document.getElementById('main-nav');
      
      if (currentUser.role === 'admin') {
        nav.innerHTML = `
          <button type="button" onclick="showView('dashboard')" id="nav-dashboard" class="nav-btn px-5 py-4 text-sm font-semibold bg-gold-500 text-slate-900 rounded-t-lg whitespace-nowrap">
            <span class="mr-1">üìä</span><span class="hidden sm:inline">Dashboard</span>
          </button>
          <button type="button" onclick="showView('new-ticket')" id="nav-new-ticket" class="nav-btn px-5 py-4 text-sm font-semibold text-slate-400 hover:bg-slate-800 hover:text-white rounded-t-lg whitespace-nowrap">
            <span class="mr-1">‚ûï</span><span class="hidden sm:inline">New Ticket</span>
          </button>
          <button type="button" onclick="showView('tickets')" id="nav-tickets" class="nav-btn px-5 py-4 text-sm font-semibold text-slate-400 hover:bg-slate-800 hover:text-white rounded-t-lg whitespace-nowrap">
            <span class="mr-1">üìã</span><span class="hidden sm:inline">Tickets</span>
          </button>
          <button type="button" onclick="showView('customers')" id="nav-customers" class="nav-btn px-5 py-4 text-sm font-semibold text-slate-400 hover:bg-slate-800 hover:text-white rounded-t-lg whitespace-nowrap">
            <span class="mr-1">üë•</span><span class="hidden sm:inline">Customers</span>
          </button>
          <button type="button" onclick="showView('trucks')" id="nav-trucks" class="nav-btn px-5 py-4 text-sm font-semibold text-slate-400 hover:bg-slate-800 hover:text-white rounded-t-lg whitespace-nowrap">
            <span class="mr-1">üöõ</span><span class="hidden sm:inline">Carriers</span>
          </button>
          <button type="button" onclick="showView('reports')" id="nav-reports" class="nav-btn px-5 py-4 text-sm font-semibold text-slate-400 hover:bg-slate-800 hover:text-white rounded-t-lg whitespace-nowrap">
            <span class="mr-1">üìà</span><span class="hidden sm:inline">Reports</span>
          </button>
          <button type="button" onclick="showView('pricing')" id="nav-pricing" class="nav-btn px-5 py-4 text-sm font-semibold text-slate-400 hover:bg-slate-800 hover:text-white rounded-t-lg whitespace-nowrap">
            <span class="mr-1">üí∞</span><span class="hidden sm:inline">Pricing</span>
          </button>
          <button type="button" onclick="showView('settings')" id="nav-settings" class="nav-btn px-5 py-4 text-sm font-semibold text-slate-400 hover:bg-slate-800 hover:text-white rounded-t-lg whitespace-nowrap">
            <span class="mr-1">‚öôÔ∏è</span><span class="hidden sm:inline">Settings</span>
          </button>
          <a href="/incidents-dashboard.html" class="nav-btn px-5 py-4 text-sm font-semibold text-slate-400 hover:bg-slate-800 hover:text-white rounded-t-lg whitespace-nowrap flex items-center">
            <span class="mr-1">ü©∫</span><span class="hidden sm:inline">System Health</span>
          </a>
        `;
      } else if (currentUser.role === 'finance') {
        // Finance role: Tickets (Hold‚ÜíClosed) + Reports (QB Export)
        nav.innerHTML = `
          <button type="button" onclick="showView('tickets')" id="nav-tickets" class="nav-btn px-5 py-4 text-sm font-semibold bg-gold-500 text-slate-900 rounded-t-lg whitespace-nowrap">
            <span class="mr-1">üìã</span><span class="hidden sm:inline">Tickets</span>
          </button>
          <button type="button" onclick="showView('reports')" id="nav-reports" class="nav-btn px-5 py-4 text-sm font-semibold text-slate-400 hover:bg-slate-800 hover:text-white rounded-t-lg whitespace-nowrap">
            <span class="mr-1">üìà</span><span class="hidden sm:inline">Reports & Export</span>
          </button>
          <a href="/incidents-dashboard.html" class="nav-btn px-5 py-4 text-sm font-semibold text-slate-400 hover:bg-slate-800 hover:text-white rounded-t-lg whitespace-nowrap flex items-center">
            <span class="mr-1">ü©∫</span><span class="hidden sm:inline">System Health</span>
          </a>
        `;
      } else {
        nav.innerHTML = `
          <button type="button" onclick="showView('operator-home')" id="nav-operator-home" class="nav-btn px-5 py-4 text-sm font-semibold bg-gold-500 text-slate-900 rounded-t-lg whitespace-nowrap">
            <span class="mr-1">üè†</span><span class="hidden sm:inline">Home</span>
          </button>
          <button type="button" onclick="showView('new-ticket')" id="nav-new-ticket" class="nav-btn px-5 py-4 text-sm font-semibold text-slate-400 hover:bg-slate-800 hover:text-white rounded-t-lg whitespace-nowrap">
            <span class="mr-1">‚ûï</span><span class="hidden sm:inline">New Ticket</span>
          </button>
          <button type="button" onclick="showView('tickets')" id="nav-tickets" class="nav-btn px-5 py-4 text-sm font-semibold text-slate-400 hover:bg-slate-800 hover:text-white rounded-t-lg whitespace-nowrap">
            <span class="mr-1">üìã</span><span class="hidden sm:inline">Tickets</span>
          </button>
          <button type="button" onclick="showView('customers')" id="nav-customers" class="nav-btn px-5 py-4 text-sm font-semibold text-slate-400 hover:bg-slate-800 hover:text-white rounded-t-lg whitespace-nowrap">
            <span class="mr-1">üë•</span><span class="hidden sm:inline">Customers</span>
          </button>
          <button type="button" onclick="showView('trucks')" id="nav-trucks" class="nav-btn px-5 py-4 text-sm font-semibold text-slate-400 hover:bg-slate-800 hover:text-white rounded-t-lg whitespace-nowrap">
            <span class="mr-1">üöõ</span><span class="hidden sm:inline">Carriers</span>
          </button>
        `;
      }
    }

    function showView(viewId) {
      document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
      document.querySelectorAll('.nav-btn').forEach(b => {
        b.classList.remove('bg-gold-500', 'text-slate-900');
        b.classList.add('text-slate-400', 'hover:bg-slate-800', 'hover:text-white');
      });
      
      const view = document.getElementById('view-' + viewId);
      if (view) view.classList.remove('hidden');
      
      const navBtn = document.getElementById('nav-' + viewId);
      if (navBtn) {
        navBtn.classList.add('bg-gold-500', 'text-slate-900');
        navBtn.classList.remove('text-slate-400', 'hover:bg-slate-800', 'hover:text-white');
      }
      
      if (viewId === 'customers') renderCustomers();
      if (viewId === 'trucks') renderTrucksAndCarriers();
      if (viewId === 'settings') renderSettings();
      if (viewId === 'reports') initReportsView();
      if (viewId === 'pricing') {
        // Ensure main data arrays are loaded for edit modals
        if (CUSTOMERS.length === 0) loadCustomersFromAirtable();
        if (CARRIERS.length === 0) loadCarriersFromAirtable();
        if (PRODUCTS.length === 0) loadProductsFromAirtable();
        initPricingView();
      }
    }

    // ==================== CALCULATIONS ====================
    function getProductWeight(productName) {
      const product = PRODUCTS.find(p => p.name === productName);
      // Return default 1350 if product not found OR if lbsPerYard is 0/undefined
      return (product && product.lbsPerYard > 0) ? product.lbsPerYard : 1350;
    }

    function calcTons(gross, tare) { return ((gross - tare) / 2000).toFixed(2); }
    function calcYards(gross, tare, product) { 
      const yards = (gross - tare) / getProductWeight(product);
      return isFinite(yards) ? yards.toFixed(2) : '0.00';
    }
    
    // v69: Calculate $ amount based on customer pricing method (per ton vs per yard)
    function calcAmount(ticket, customer) {
      if (!customer) {
        customer = CUSTOMERS.find(c => c.id === ticket.customerId || c.name === ticket.customer);
      }
      
      const tons = parseFloat(calcTons(ticket.gross, ticket.tare)) || 0;
      const yards = parseFloat(calcYards(ticket.gross, ticket.tare, ticket.product)) || 0;
      
      // Determine billing method from customer settings
      const method = (customer?.pricingMethod || '').toLowerCase();
      const billByTon = method.includes('ton') || (customer?.priceTon && !customer?.priceYard);
      
      let amount;
      if (billByTon && customer?.priceTon) {
        // Bill by tons at customer's ton rate
        amount = tons * customer.priceTon;
      } else if (customer?.priceYard) {
        // Bill by yards at customer's yard rate
        amount = yards * customer.priceYard;
      } else {
        // Default: yards at $13
        amount = yards * 13;
      }
      
      return Math.round(amount * 100) / 100; // Round to 2 decimals
    }

    function updateStats() {
      // Exclude voided tickets from stats
      const activeTickets = tickets.filter(t => t.status !== 'Void');
      
      document.getElementById('stat-tickets').textContent = activeTickets.length;
      document.getElementById('stat-tons').textContent = activeTickets.reduce((sum, t) => sum + (t.gross - t.tare) / 2000, 0).toFixed(1);
      const totalYards = activeTickets.reduce((sum, t) => {
        const yards = (t.gross - t.tare) / getProductWeight(t.product);
        return sum + (isFinite(yards) ? yards : 0);
      }, 0);
      document.getElementById('stat-yards').textContent = totalYards.toFixed(1);
      document.getElementById('stat-customers').textContent = CUSTOMERS.length;
    }

    // ==================== DROPDOWNS ====================
    function populateDropdowns() {
      const customerSelect = document.getElementById('ticket-customer');
      customerSelect.innerHTML = '<option value="">Select customer...</option>';
      CUSTOMERS.sort((a, b) => a.name.localeCompare(b.name)).forEach(c => {
        // Store allowed products as JSON in data attribute
        const allowedProducts = JSON.stringify(c.allowedProducts || []);
        customerSelect.innerHTML += `<option value="${c.name}" data-airtableid="${c.airtableId || c.id}" data-allowed-products='${allowedProducts}'>${c.name}</option>`;
      });
      
      // Add customer change listener for product filtering
      customerSelect.removeEventListener('change', handleCustomerChange);
      customerSelect.addEventListener('change', handleCustomerChange);

      const carrierSelect = document.getElementById('ticket-carrier');
      carrierSelect.innerHTML = '<option value="">Select carrier...</option>';
      CARRIERS.forEach(c => {
        carrierSelect.innerHTML += `<option value="${c.name}" data-airtableid="${c.airtableId || c.id}">${c.name}</option>`;
      });

      // Truck is now a text field, no dropdown needed

      // Populate all products initially
      populateProductDropdown();
    }
    
    // Populate product dropdown (optionally filtered by allowed product IDs)
    function populateProductDropdown(allowedProductIds = null) {
      const productSelect = document.getElementById('ticket-product');
      const filterNotice = document.getElementById('product-filter-notice');
      const previousValue = productSelect.value;
      
      productSelect.innerHTML = '<option value="">Select product...</option>';
      
      let productsToShow = PRODUCTS;
      let isFiltered = false;
      
      // Filter products if customer has restrictions
      if (allowedProductIds && allowedProductIds.length > 0) {
        productsToShow = PRODUCTS.filter(p => 
          allowedProductIds.includes(p.airtableId) || allowedProductIds.includes(p.id)
        );
        isFiltered = true;
        
        // If only one product allowed, show a friendly message
        if (productsToShow.length === 1) {
          console.log(`Customer restricted to single product: ${productsToShow[0].name}`);
        }
      }
      
      // Show/hide filter notice
      if (filterNotice) {
        if (isFiltered && productsToShow.length < PRODUCTS.length) {
          filterNotice.classList.remove('hidden');
          filterNotice.innerHTML = `<span class="inline-flex items-center gap-1">‚úì Showing ${productsToShow.length} of ${PRODUCTS.length} products for this customer</span>`;
        } else {
          filterNotice.classList.add('hidden');
        }
      }
      
      productsToShow.forEach(p => {
        productSelect.innerHTML += `<option value="${p.name}" data-airtableid="${p.airtableId || p.id}" data-lbs="${p.lbsPerYard}">${p.name}</option>`;
      });
      
      // Auto-select if only one product is available
      if (productsToShow.length === 1) {
        productSelect.value = productsToShow[0].name;
        productSelect.dispatchEvent(new Event('change')); // Trigger calculations
        showToast(`Auto-selected: ${productsToShow[0].name}`, 'info');
      } else if (previousValue && productsToShow.find(p => p.name === previousValue)) {
        // Restore previous selection if still valid
        productSelect.value = previousValue;
      }
      
      return productsToShow.length;
    }
    
    // Handle customer selection change - filter products
    function handleCustomerChange(e) {
      const selectedOption = e.target.selectedOptions[0];
      const defaultNoteContainer = document.getElementById('customer-default-note-container');
      const defaultNoteDisplay = document.getElementById('customer-default-note-display');
      
      if (!selectedOption || !selectedOption.value) {
        // No customer selected - show all products, hide default note, clear freight
        populateProductDropdown();
        if (defaultNoteContainer) defaultNoteContainer.classList.add('hidden');
        clearFreightFields();
        return;
      }
      
      // Get the customer record to find default note and freight settings
      const customerId = selectedOption.getAttribute('data-airtableid');
      const customer = CUSTOMERS.find(c => (c.airtableId || c.id) === customerId);
      
      // Show/hide default note
      if (customer && customer.defaultNote && defaultNoteContainer && defaultNoteDisplay) {
        defaultNoteDisplay.textContent = customer.defaultNote;
        defaultNoteContainer.classList.remove('hidden');
      } else if (defaultNoteContainer) {
        defaultNoteContainer.classList.add('hidden');
      }
      
      // Auto-populate freight settings from customer profile
      applyCustomerFreightSettings(customer);
      
      // Get allowed products from data attribute
      let allowedProducts = [];
      try {
        const allowedProductsJson = selectedOption.getAttribute('data-allowed-products');
        allowedProducts = allowedProductsJson ? JSON.parse(allowedProductsJson) : [];
      } catch (err) {
        console.error('Error parsing allowed products:', err);
        allowedProducts = [];
      }
      
      // Filter product dropdown
      const productCount = populateProductDropdown(allowedProducts.length > 0 ? allowedProducts : null);
      
      // Log for debugging
      const customerName = selectedOption.text;
      if (allowedProducts.length > 0) {
        console.log(`Customer "${customerName}" restricted to ${allowedProducts.length} product(s)`);
      } else {
        console.log(`Customer "${customerName}" has no product restrictions - showing all ${productCount} products`);
      }
    }
    
    // Clear freight fields on new ticket form
    function clearFreightFields() {
      const freightCostField = document.getElementById('ticket-freight-cost');
      const freightChargeField = document.getElementById('ticket-freight-charge');
      const freightMarginField = document.getElementById('ticket-freight-margin');
      const freightSection = document.getElementById('freight-section');
      
      if (freightCostField) freightCostField.value = '';
      if (freightChargeField) freightChargeField.value = '';
      if (freightMarginField) freightMarginField.value = '';
      if (freightSection) freightSection.classList.add('hidden');
    }
    
    // Apply customer freight settings to ticket form
    function applyCustomerFreightSettings(customer) {
      const freightCostField = document.getElementById('ticket-freight-cost');
      const freightChargeField = document.getElementById('ticket-freight-charge');
      const freightSection = document.getElementById('freight-section');
      
      // v71: Normalize freight method to handle both 'per_ton' and 'Per Ton' formats
      const normalizeMethod = (m) => (m || '').toLowerCase().replace(/\s+/g, '_').replace('per_', '');
      const isDelivered = (m) => normalizeMethod(m) === 'delivered';
      const hasFreight = customer && customer.freightMethod && customer.freightMethod !== '' && !isDelivered(customer.freightMethod);
      
      if (!hasFreight) {
        // No freight or delivered pricing - hide/clear freight section
        clearFreightFields();
        if (freightSection) freightSection.classList.add('hidden');
        return;
      }
      
      // Show freight section
      if (freightSection) freightSection.classList.remove('hidden');
      
      // Helper to format method for display
      const formatMethod = (method) => {
        if (!method) return '';
        const norm = normalizeMethod(method);
        if (norm === 'ton') return 'Ton';
        if (norm === 'yard') return 'Yard';
        if (norm === 'flat' || norm === 'fee') return 'Flat';
        return method;
      };
      const isFlatFee = (method) => {
        const norm = normalizeMethod(method);
        return norm === 'flat' || norm === 'fee';
      };
      
      // Update the freight section header to show method and rate
      const headerSpan = freightSection?.querySelector('.text-xs.bg-blue-100');
      if (headerSpan) {
        const methodLabel = 'Per ' + formatMethod(customer.freightMethod);
        const rateInfo = isFlatFee(customer.freightMethod) 
          ? `Flat: $${customer.freightRate || 0}` 
          : `$${customer.freightRate || 0}/${formatMethod(customer.freightMethod)}`;
        headerSpan.textContent = `${methodLabel} - ${rateInfo}`;
      }
      
      // Determine cost method (may differ from charge method)
      const costMethod = customer.freightCostMethod || customer.freightMethod;
      const costMethodLabel = 'Per ' + formatMethod(costMethod);
      
      // DON'T prefill the fields with rates - leave empty so calculated totals are used
      // The placeholders show the rate for reference
      if (freightCostField) {
        freightCostField.value = '';
        // Show cost method in placeholder if different from charge method
        if (costMethod !== customer.freightMethod) {
          freightCostField.placeholder = isFlatFee(costMethod) 
            ? `Flat: $${customer.freightCost || 0} (${costMethodLabel})` 
            : `$${customer.freightCost || 0}/${formatMethod(costMethod)}`;
        } else {
          freightCostField.placeholder = isFlatFee(customer.freightMethod) 
            ? `Flat: $${customer.freightCost || 0}` 
            : `$${customer.freightCost || 0}/${formatMethod(customer.freightMethod)}`;
        }
      }
      
      if (freightChargeField) {
        freightChargeField.value = '';
        freightChargeField.placeholder = isFlatFee(customer.freightMethod) 
          ? `Flat: $${customer.freightRate || 0}` 
          : `$${customer.freightRate || 0}/${formatMethod(customer.freightMethod)}`;
      }
      
      // Calculate and display margin
      calculateFreightMargin();
      
      // Store freight method and rates for calculation at save time
      if (freightSection) {
        freightSection.setAttribute('data-freight-method', customer.freightMethod);
        freightSection.setAttribute('data-freight-rate', customer.freightRate || 0);
        freightSection.setAttribute('data-freight-cost-method', costMethod);
        freightSection.setAttribute('data-freight-cost', customer.freightCost || 0);
      }
      
      console.log(`Freight settings applied: ChargeMethod=${customer.freightMethod}, Rate=$${customer.freightRate}/unit, CostMethod=${costMethod}, Cost=$${customer.freightCost}/unit`);
    }

    // ==================== RENDER FUNCTIONS ====================
    function renderRecentActivity() {
      ['recent-activity', 'operator-recent-activity'].forEach(containerId => {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        if (tickets.length === 0) {
          container.innerHTML = `<div class="text-center py-8 text-slate-500"><p class="text-lg">No tickets yet</p></div>`;
          return;
        }
        
        container.innerHTML = tickets.slice(0, 5).map(t => {
          // Format date nicely
          const dateStr = t.date ? new Date(t.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
          const isExported = t.status === 'Closed' && t.exportedToQB;
          const exportedBadge = isExported ? '<span class="ml-2 px-1.5 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-700">QB</span>' : '';
          return `
          <div class="activity-card flex items-center justify-between p-4 bg-slate-50 rounded-xl" onclick="openTicketModal('${t.id}')">
            <div class="flex items-center gap-4">
              <div class="w-14 h-14 bg-gradient-to-br from-gold-100 to-gold-200 rounded-xl flex items-center justify-center border border-gold-200">
                <span class="font-mono font-bold text-gold-700 text-sm">#${t.number}</span>
              </div>
              <div>
                <p class="font-semibold text-slate-900">${t.customer || '(No customer)'}${exportedBadge}</p>
                <p class="text-sm text-slate-500">${t.product} ‚Ä¢ ${t.carrier}</p>
              </div>
            </div>
            <div class="flex items-center gap-4">
              <div class="text-right">
                <p class="font-mono font-bold text-slate-900">${calcTons(t.gross, t.tare)} <span class="text-sm font-normal text-slate-500">tons</span></p>
                <p class="text-sm text-slate-500">${dateStr}</p>
              </div>
              <button type="button" onclick="event.stopPropagation(); printTicket('${t.id}')" class="bg-gold-500 hover:bg-gold-600 text-slate-900 font-semibold py-2 px-3 rounded-lg text-sm transition-all">üñ®Ô∏è</button>
            </div>
          </div>
        `}).join('');
      });
    }

    function renderTicketsTable() {
      const container = document.getElementById('tickets-table');
      const searchInput = document.getElementById('ticket-search');
      const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
      
      const filteredTickets = tickets.filter(t => 
        (t.customer || '').toLowerCase().includes(searchTerm) ||
        (t.product || '').toLowerCase().includes(searchTerm) ||
        (t.carrier || '').toLowerCase().includes(searchTerm) ||
        t.number.toString().includes(searchTerm) ||
        (t.status || '').toLowerCase().includes(searchTerm)
      );
      
      if (filteredTickets.length === 0) {
        container.innerHTML = `<tr><td colspan="7" class="px-6 py-12 text-center text-slate-500"><p class="text-lg">No tickets found</p></td></tr>`;
        document.getElementById('ticket-count').textContent = 0;
        return;
      }
      
      container.innerHTML = filteredTickets.map((t, idx) => {
        const status = getDisplayStatus(t); // Shows "Exported" for closed+exported tickets
        const isVoid = t.status === 'Void';
        const rowClass = isVoid ? 'opacity-50' : '';
        const strikeClass = isVoid ? 'line-through' : '';
        const statusBadge = getStatusBadgeHtml(status);
        const dateStr = t.date ? new Date(t.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
        
        // v69: Calculate $ amount using customer's pricing method (per ton or per yard)
        const amount = calcAmount(t).toFixed(2);
        
        return `
        <tr class="ticket-row ${idx % 2 === 0 ? 'bg-white' : 'bg-slate-50/50'} ${rowClass}" onclick="openTicketModal('${t.id}')">
          <td class="px-6 py-4">
            <div class="flex items-center gap-2">
              <div class="w-10 h-10 bg-gold-100 rounded-lg flex items-center justify-center">
                <span class="font-mono font-bold text-gold-700 text-xs ${strikeClass}">${t.number}</span>
              </div>
              ${statusBadge}
            </div>
          </td>
          <td class="px-6 py-4 text-slate-600 text-sm hidden sm:table-cell">${dateStr}</td>
          <td class="px-6 py-4"><p class="font-semibold text-slate-900 ${strikeClass}">${t.customer || '(No customer)'}</p></td>
          <td class="px-6 py-4 hidden md:table-cell"><span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-slate-200 text-slate-700">${t.product}</span></td>
          <td class="px-6 py-4 text-slate-600 hidden lg:table-cell"><p class="font-medium">${t.carrier}</p></td>
          <td class="px-6 py-4 text-right"><p class="font-mono font-bold text-slate-900">${calcTons(t.gross, t.tare)}</p></td>
          <td class="px-6 py-4 text-right font-mono font-semibold text-slate-900 hidden sm:table-cell">${calcYards(t.gross, t.tare, t.product)}</td>
          <td class="px-6 py-4 text-right font-mono font-bold text-emerald-600 hidden sm:table-cell amount-column">$${parseFloat(amount).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
          <td class="px-6 py-4 text-center">
            <button type="button" onclick="event.stopPropagation(); printTicket('${t.id}')" class="bg-gold-500 hover:bg-gold-600 text-slate-900 font-semibold py-2 px-3 rounded-lg text-sm transition-all">üñ®Ô∏è</button>
          </td>
        </tr>
      `}).join('');
      document.getElementById('ticket-count').textContent = filteredTickets.length;
    }
    
    function getStatusBadgeHtml(status) {
      const colors = {
        'Open': 'bg-emerald-100 text-emerald-700',
        'Hold': 'bg-amber-100 text-amber-700',
        'Closed': 'bg-blue-100 text-blue-700',
        'Exported': 'bg-purple-100 text-purple-700',
        'Void': 'bg-red-100 text-red-700'
      };
      // Always show status badge
      return `<span class="px-2 py-0.5 rounded text-xs font-semibold ${colors[status] || colors['Open']}">${status}</span>`;
    }

    document.getElementById('ticket-search')?.addEventListener('input', renderTicketsTable);

    // ==================== CUSTOMERS ====================
    function setCustomerView(mode) {
      customerViewMode = mode;
      const cardsBtn = document.getElementById('view-cards-btn');
      const listBtn = document.getElementById('view-list-btn');
      const cardsView = document.getElementById('customers-cards-view');
      const listView = document.getElementById('customers-list-view');
      
      if (mode === 'cards') {
        cardsBtn.className = 'px-3 py-1.5 rounded-md text-sm font-medium bg-gold-500 text-slate-900';
        listBtn.className = 'px-3 py-1.5 rounded-md text-sm font-medium text-slate-400 hover:text-white';
        cardsView.classList.remove('hidden');
        listView.classList.add('hidden');
      } else {
        listBtn.className = 'px-3 py-1.5 rounded-md text-sm font-medium bg-gold-500 text-slate-900';
        cardsBtn.className = 'px-3 py-1.5 rounded-md text-sm font-medium text-slate-400 hover:text-white';
        listView.classList.remove('hidden');
        cardsView.classList.add('hidden');
      }
      renderCustomers();
    }

    function renderCustomers() {
      const searchInput = document.getElementById('customer-search');
      const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
      
      const filtered = CUSTOMERS.filter(c => 
        c.name.toLowerCase().includes(searchTerm) ||
        (c.city || '').toLowerCase().includes(searchTerm) ||
        (c.email || '').toLowerCase().includes(searchTerm)
      ).sort((a, b) => a.name.localeCompare(b.name));
      
      document.getElementById('customer-count').textContent = CUSTOMERS.length;
      const isAdmin = currentUser?.role === 'admin';
      
      const cardsContainer = document.getElementById('customers-cards-view');
      cardsContainer.innerHTML = filtered.map(c => `
        <div class="bg-slate-50 rounded-xl p-4 hover:bg-slate-100 transition-colors">
          <div class="flex items-start justify-between mb-3">
            <div class="w-10 h-10 bg-gold-100 rounded-lg flex items-center justify-center">
              <span class="text-gold-700 font-bold">${c.name.charAt(0)}</span>
            </div>
            ${c.priceYard ? `<span class="text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-700">$${c.priceYard}/yd</span>` : 
              c.priceTon ? `<span class="text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700">$${c.priceTon}/ton</span>` : 
              `<span class="text-xs px-2 py-1 rounded-full bg-slate-200 text-slate-600">$13/yd</span>`}
          </div>
          <p class="font-semibold text-slate-900">${c.name}</p>
          <p class="text-sm text-slate-500 mt-1">${[c.city, c.state].filter(Boolean).join(', ') || 'No location'}</p>
          ${c.phone ? `<p class="text-sm text-slate-500">${c.phone}</p>` : ''}
          ${isAdmin ? `
          <div class="mt-3 pt-3 border-t border-slate-200">
            <button type="button" onclick="openEditCustomerModal('${c.id}')" class="text-gold-600 hover:text-gold-700 text-sm font-semibold">Edit</button>
          </div>
          ` : ''}
        </div>
      `).join('');
      
      const tableBody = document.getElementById('customers-table-body');
      tableBody.innerHTML = filtered.map((c, idx) => `
        <tr class="${idx % 2 === 0 ? 'bg-white' : 'bg-slate-50/50'}">
          <td class="px-4 py-3 font-semibold text-slate-900">${c.name}</td>
          <td class="px-4 py-3 text-slate-600 hidden md:table-cell">${[c.city, c.state].filter(Boolean).join(', ') || '‚Äî'}</td>
          <td class="px-4 py-3 text-slate-600 hidden lg:table-cell">${c.phone || '‚Äî'}</td>
          <td class="px-4 py-3">
            ${c.priceYard ? `<span class="text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-700">$${c.priceYard}/yd</span>` : 
              c.priceTon ? `<span class="text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700">$${c.priceTon}/ton</span>` : 
              `<span class="text-xs px-2 py-1 rounded-full bg-slate-200 text-slate-600">$13/yd</span>`}
          </td>
          <td class="px-4 py-3 text-center">
            ${isAdmin ? `<button type="button" onclick="openEditCustomerModal('${c.id}')" class="text-gold-600 hover:text-gold-700 text-sm font-semibold">Edit</button>` : '‚Äî'}
          </td>
        </tr>
      `).join('');
    }

    document.getElementById('customer-search')?.addEventListener('input', renderCustomers);

    // ==================== CARRIERS ====================
    function renderTrucksAndCarriers() {
      document.getElementById('carrier-count').textContent = CARRIERS.length;
      const isAdmin = currentUser?.role === 'admin';
      
      // Sort carriers alphabetically
      const sortedCarriers = [...CARRIERS].sort((a, b) => a.name.localeCompare(b.name));
      
      document.getElementById('carriers-list').innerHTML = sortedCarriers.map(c => {
        // Build contact/location info
        const contactInfo = c.phone || c.email || '';
        const locationInfo = [c.city, c.state].filter(Boolean).join(', ');
        const subText = contactInfo && locationInfo ? `${contactInfo} ‚Ä¢ ${locationInfo}` : contactInfo || locationInfo || 'No contact info';
        
        return `
        <div class="bg-slate-50 rounded-xl p-4 hover:bg-slate-100 transition-colors flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center"><span class="text-blue-600 text-lg">üöö</span></div>
            <div>
              <p class="font-semibold text-slate-900">${c.name}</p>
              <p class="text-xs text-slate-500">${subText}</p>
            </div>
          </div>
          ${isAdmin ? `<button type="button" onclick="openEditCarrierModal('${c.id}')" class="text-gold-600 hover:text-gold-700 text-xs font-semibold">Edit</button>` : ''}
        </div>
      `}).join('');
    }

    // ==================== SETTINGS ====================
    function renderSettings() {
      document.getElementById('products-settings').innerHTML = PRODUCTS.map(p => `
        <div class="bg-slate-50 rounded-xl p-4 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gold-100 rounded-lg flex items-center justify-center"><span class="text-gold-700 font-bold text-sm">üì¶</span></div>
            <div><p class="font-semibold text-slate-900">${p.name}</p><p class="text-xs text-slate-500">${p.lbsPerYard.toLocaleString()} lbs/yard</p></div>
          </div>
          <button type="button" onclick="openEditProductModal('${p.id}')" class="text-gold-600 hover:text-gold-700 text-sm font-semibold">Edit</button>
        </div>
      `).join('');
      
      document.getElementById('users-list').innerHTML = USERS.map(u => `
        <div class="bg-slate-50 rounded-xl p-4 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="${u.role === 'admin' ? 'badge-role-admin' : u.role === 'finance' ? 'badge-role-finance' : 'badge-role-user'} w-10 h-10 rounded-full flex items-center justify-center"><span class="text-white">${u.icon}</span></div>
            <div>
              <p class="font-semibold text-slate-900">${u.name}</p>
              <p class="text-xs text-slate-500">${u.label} ‚Ä¢ PIN: ${u.pin}</p>
            </div>
          </div>
          <button type="button" onclick="openEditUserModal('${u.id}')" class="text-gold-600 hover:text-gold-700 text-sm font-semibold">Edit</button>
        </div>
      `).join('');
      
      // Update Airtable status
      const statusEl = document.getElementById('airtable-status');
      if (airtableConnected) {
        statusEl.className = 'text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full flex items-center gap-1';
        statusEl.innerHTML = '<span class="w-2 h-2 bg-emerald-500 rounded-full"></span> Connected';
      } else {
        statusEl.className = 'text-xs bg-red-100 text-red-700 px-2 py-1 rounded-full flex items-center gap-1';
        statusEl.innerHTML = '<span class="w-2 h-2 bg-red-500 rounded-full"></span> Offline';
      }
    }

    // ==================== MODALS ====================
    function openModal(id) {
      document.getElementById(id).classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeModal(id) {
      document.getElementById(id).classList.add('hidden');
      document.body.style.overflow = '';
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        ['ticket-modal', 'edit-ticket-modal', 'add-customer-modal', 'edit-customer-modal', 'delete-confirm-modal', 'upload-customers-modal', 'add-carrier-modal', 'edit-carrier-modal', 'add-truck-modal', 'edit-truck-modal', 'edit-product-modal', 'add-user-modal', 'edit-user-modal', 'tutorial-modal', 'quickbooks-export-modal'].forEach(id => {
          document.getElementById(id)?.classList.add('hidden');
        });
        document.body.style.overflow = '';
      }
    });

    // Ticket Modal
    function openTicketModal(ticketId) {
      currentTicket = tickets.find(t => t.id === ticketId);
      if (!currentTicket) return;
      const net = currentTicket.gross - currentTicket.tare;
      
      document.getElementById('modal-ticket-number-badge').textContent = '#' + currentTicket.number;
      document.getElementById('modal-ticket-date').textContent = currentTicket.date;
      document.getElementById('modal-customer').textContent = currentTicket.customer || '(No customer)';
      document.getElementById('modal-product').textContent = currentTicket.product;
      document.getElementById('modal-carrier').textContent = currentTicket.carrier;
      document.getElementById('modal-truck').textContent = currentTicket.truck || '‚Äî';
      document.getElementById('modal-gross').textContent = currentTicket.gross.toLocaleString();
      document.getElementById('modal-tare').textContent = currentTicket.tare.toLocaleString();
      document.getElementById('modal-net').textContent = net.toLocaleString();
      document.getElementById('modal-tons').textContent = calcTons(currentTicket.gross, currentTicket.tare);
      document.getElementById('modal-yards').textContent = calcYards(currentTicket.gross, currentTicket.tare, currentTicket.product);
      document.getElementById('modal-po').textContent = currentTicket.po || '‚Äî';
      document.getElementById('modal-note').textContent = currentTicket.note || '‚Äî';
      
      // Update status badge
      const statusBadge = document.getElementById('modal-status-badge');
      const status = currentTicket.status || 'Open';
      const displayStatus = getDisplayStatus(currentTicket); // Shows "Exported" for closed+exported
      statusBadge.textContent = displayStatus;
      statusBadge.className = 'px-3 py-1 rounded-full text-xs font-bold uppercase ' + getStatusBadgeClass(displayStatus);
      
      // Show edit button and status controls based on role
      const editBtn = document.getElementById('edit-ticket-btn');
      const deleteBtn = document.getElementById('delete-ticket-btn');
      const statusControls = document.getElementById('admin-status-controls');
      
      // Only lock if explicitly Closed or Void (not for Open, Hold, or undefined)
      const isLocked = (status === 'Closed' || status === 'Void') && status !== undefined;
      console.log('Ticket status:', status, 'isLocked:', isLocked, 'exportedToQB:', currentTicket.exportedToQB);
      
      if (currentUser?.role === 'admin') {
        // Edit button - show for Open/Hold tickets, hide for Closed/Void
        if (!isLocked) {
          editBtn?.classList.remove('hidden');
          editBtn?.classList.add('flex');
        } else {
          editBtn?.classList.add('hidden');
          editBtn?.classList.remove('flex');
        }
        // Delete button - removed per Lucas request (void only, keep records)
        // Status controls - always show container, buttons controlled by updateStatusButtons
        statusControls?.classList.remove('hidden');
        updateStatusButtons(status || 'Open', currentTicket.exportedToQB);
      } else if (currentUser?.role === 'finance') {
        // Finance can only see status controls, not edit/delete
        editBtn?.classList.add('hidden');
        editBtn?.classList.remove('flex');
        deleteBtn?.classList.add('hidden');
        deleteBtn?.classList.remove('flex');
        statusControls?.classList.remove('hidden');
        updateStatusButtons(status || 'Open', currentTicket.exportedToQB);
      } else if (currentUser?.role === 'user') {
        // Operator (Doug) can void/unvoid but not edit/delete
        editBtn?.classList.add('hidden');
        editBtn?.classList.remove('flex');
        deleteBtn?.classList.add('hidden');
        deleteBtn?.classList.remove('flex');
        statusControls?.classList.remove('hidden');
        updateStatusButtons(status || 'Open', currentTicket.exportedToQB);
      } else {
        editBtn?.classList.add('hidden');
        editBtn?.classList.remove('flex');
        deleteBtn?.classList.add('hidden');
        deleteBtn?.classList.remove('flex');
        statusControls?.classList.add('hidden');
      }
      
      openModal('ticket-modal');
    }
    
    function getStatusBadgeClass(status) {
      switch (status) {
        case 'Open': return 'bg-emerald-500 text-white';
        case 'Hold': return 'bg-amber-500 text-white';
        case 'Closed': return 'bg-blue-500 text-white';
        case 'Exported': return 'bg-purple-500 text-white';
        case 'Void': return 'bg-red-500 text-white';
        default: return 'bg-emerald-500 text-white';
      }
    }
    
    // Get display status (shows "Exported" for closed+exported tickets)
    function getDisplayStatus(ticket) {
      if (ticket.status === 'Closed' && ticket.exportedToQB) {
        return 'Exported';
      }
      return ticket.status || 'Open';
    }
    
    // Update status button visibility based on current ticket status
    function updateStatusButtons(currentStatus, isExported = false) {
      const btnOpen = document.getElementById('btn-status-open');
      const btnHold = document.getElementById('btn-status-hold');
      const btnClosed = document.getElementById('btn-status-closed');
      const btnVoid = document.getElementById('btn-status-void');
      const btnUnvoid = document.getElementById('btn-status-unvoid');
      const statusButtons = document.getElementById('status-buttons');
      const lockedMsg = document.getElementById('status-locked-msg');
      
      const role = currentUser?.role;
      const isAdmin = role === 'admin';
      const isFinance = role === 'finance';
      const isOperator = role === 'user';
      
      // Reset all buttons
      [btnOpen, btnHold, btnClosed, btnVoid, btnUnvoid].forEach(btn => {
        if (btn) {
          btn.classList.add('hidden');
          btn.disabled = false;
        }
      });
      statusButtons?.classList.remove('hidden');
      lockedMsg?.classList.add('hidden');
      
      // STATUS WORKFLOW RULES:
      // - Admin: Full control - can change any status, void, and unvoid
      // - Operator: Can void and unvoid tickets
      // - Finance: Can ONLY change Hold ‚Üí Closed
      // - Exported to QB ‚Üí LOCKED for everyone
      
      // EXPORTED TO QB: Locked for everyone
      if (isExported) {
        statusButtons?.classList.add('hidden');
        lockedMsg?.classList.remove('hidden');
        lockedMsg.textContent = 'üîí This ticket has been exported to QuickBooks and cannot be changed.';
        return;
      }
      
      // FINANCE ROLE: Can close Hold tickets AND unvoid voided tickets
      if (isFinance) {
        if (currentStatus === 'Void') {
          // Finance can unvoid
          btnUnvoid?.classList.remove('hidden');
        } else if (currentStatus === 'Hold') {
          btnClosed?.classList.remove('hidden');
        } else {
          statusButtons?.classList.add('hidden');
          lockedMsg?.classList.remove('hidden');
          lockedMsg.textContent = currentStatus === 'Closed' 
            ? 'üîí This ticket is locked.' 
            : 'üí∞ Finance users can only close tickets that are on Hold.';
        }
        return;
      }
      
      // OPERATOR ROLE: Can only void (not unvoid)
      if (isOperator) {
        if (currentStatus === 'Void') {
          // Operator cannot unvoid - show locked message
          statusButtons?.classList.add('hidden');
          lockedMsg?.classList.remove('hidden');
          lockedMsg.textContent = 'üîí Contact Lucas or Jesse to unvoid this ticket.';
        } else if (currentStatus !== 'Closed') {
          // Show Void button for non-closed tickets
          btnVoid?.classList.remove('hidden');
        } else {
          // Closed tickets - locked for operator
          statusButtons?.classList.add('hidden');
          lockedMsg?.classList.remove('hidden');
          lockedMsg.textContent = 'üîí Closed tickets cannot be changed.';
        }
        return;
      }
      
      // ADMIN ROLE: Full control
      if (isAdmin) {
        if (currentStatus === 'Void') {
          // Show Unvoid button only
          btnUnvoid?.classList.remove('hidden');
        } else if (currentStatus === 'Closed') {
          // Closed tickets cannot be reopened
          statusButtons?.classList.add('hidden');
          lockedMsg?.classList.remove('hidden');
          lockedMsg.textContent = 'üîí Closed tickets cannot be reopened.';
        } else {
          // Open or Hold - show all except current status and Unvoid
          if (currentStatus !== 'Open') btnOpen?.classList.remove('hidden');
          if (currentStatus !== 'Hold') btnHold?.classList.remove('hidden');
          btnClosed?.classList.remove('hidden');
          btnVoid?.classList.remove('hidden');
        }
        return;
      }
    }
    
    async function changeTicketStatus(newStatus) {
      // Role-based access control
      const role = currentUser?.role;
      const isAdmin = role === 'admin';
      const isFinance = role === 'finance';
      const isOperator = role === 'user';
      
      if (!currentTicket) {
        console.log('changeTicketStatus blocked - no currentTicket');
        return;
      }
      
      const currentStatus = currentTicket.status || 'Open';
      
      // Check role permissions
      // Admin: Full control (void, unvoid, all status changes)
      // Finance: Can close Hold tickets AND unvoid voided tickets
      // Operator: Can void only (not unvoid)
      
      if (isOperator) {
        // Operator can only void (any non-closed ‚Üí Void)
        const isVoiding = newStatus === 'Void' && currentStatus !== 'Closed';
        if (!isVoiding) {
          showToast('Operators can only void tickets. Contact Lucas or Jesse to unvoid.', 'error');
          return;
        }
      } else if (isFinance) {
        // Finance can close Hold tickets OR unvoid voided tickets
        const isClosingHold = currentStatus === 'Hold' && newStatus === 'Closed';
        const isUnvoiding = currentStatus === 'Void' && newStatus === 'Open';
        if (!isClosingHold && !isUnvoiding) {
          showToast('Finance users can close Hold tickets or unvoid voided tickets', 'error');
          return;
        }
      } else if (!isAdmin) {
        console.log('changeTicketStatus blocked - role:', role);
        return;
      }
      
      // Enforce workflow rules
      if (currentTicket.exportedToQB) {
        showToast('Tickets exported to QuickBooks cannot be changed', 'error');
        return;
      }
      
      if (currentStatus === 'Closed') {
        showToast('Closed tickets cannot be changed', 'error');
        return;
      }
      
      // Allow unvoiding for Admin and Finance only
      if (currentStatus === 'Void' && newStatus !== 'Open') {
        showToast('Voided tickets can only be unvoided (changed to Open)', 'error');
        return;
      }
      
      let confirmMsg;
      if (newStatus === 'Void') {
        confirmMsg = 'Are you sure you want to VOID this ticket?\n\nThe ticket will be excluded from reports and totals.\nYou can unvoid it later if needed.';
      } else if (currentStatus === 'Void' && newStatus === 'Open') {
        confirmMsg = 'Unvoid this ticket and set status to Open?\n\nThe ticket will be included in reports and totals again.';
      } else if (newStatus === 'Closed') {
        confirmMsg = 'Close this ticket?\n\nOnce closed, the ticket cannot be reopened.';
      } else {
        confirmMsg = `Change ticket status to "${newStatus}"?`;
      }
      
      if (!confirm(confirmMsg)) return;
      
      try {
        const ticketId = currentTicket.id || currentTicket.airtableId;
        console.log('=== STATUS UPDATE DEBUG ===');
        console.log('Ticket ID:', ticketId);
        console.log('Current Status:', currentStatus);
        console.log('New Status:', newStatus);
        console.log('Full currentTicket:', JSON.stringify(currentTicket, null, 2));
        
        const requestBody = {
          id: ticketId,
          status: newStatus,
          previousStatus: currentStatus  // v2.2: Pass previous status for auto-email logic
        };
        console.log('Request body:', JSON.stringify(requestBody));
        
        const response = await fetch('/api/tickets/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });
        
        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', JSON.stringify(data, null, 2));
        
        if (data.success) {
          currentTicket.status = newStatus;
          
          // Update badge in modal
          const statusBadge = document.getElementById('modal-status-badge');
          statusBadge.textContent = newStatus;
          statusBadge.className = 'px-3 py-1 rounded-full text-xs font-bold uppercase ' + getStatusBadgeClass(newStatus);
          
          // Update status buttons visibility
          updateStatusButtons(newStatus, currentTicket.exportedToQB);
          
          // Refresh ticket list
          await loadTicketsFromAirtable();
          
          // v2.2: Show appropriate toast based on email status
          if (data.emailSent) {
            showToast(`Ticket #${currentTicket.number} closed and emailed to ${data.emailTo}!`, 'success');
          } else if (data.emailError) {
            showToast(`Ticket #${currentTicket.number} ${newStatus.toLowerCase()}, but email failed: ${data.emailError}`, 'warning');
          } else {
            showToast(`Ticket #${currentTicket.number} marked as ${newStatus}`);
          }
        } else {
          // Show detailed error if available
          const errorMsg = data.details?.error?.message || data.error || 'Failed to update status';
          console.error('Status update failed:', errorMsg, data);
          throw new Error(errorMsg);
        }
      } catch (error) {
        console.error('Error updating status:', error);
        showToast('Failed to update ticket status: ' + error.message, 'error');
      }
    }

    // Delete ticket (admin only)
    async function deleteTicketFromModal() {
      if (!currentTicket || currentUser?.role !== 'admin') return;
      
      const confirmMsg = `Are you sure you want to PERMANENTLY DELETE ticket #${currentTicket.number}?\n\nThis action cannot be undone.`;
      
      if (!confirm(confirmMsg)) return;
      
      // Double confirm for safety
      if (!confirm(`FINAL CONFIRMATION: Delete ticket #${currentTicket.number}?`)) return;
      
      try {
        console.log('Deleting ticket:', currentTicket.id);
        
        const response = await fetch(`/api/tickets/delete?id=${currentTicket.id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        console.log('Delete response:', data);
        
        if (data.success) {
          // Remove from local array
          const idx = tickets.findIndex(t => t.id === currentTicket.id);
          if (idx > -1) tickets.splice(idx, 1);
          
          // Close modal and refresh
          closeModal('ticket-modal');
          renderTicketsTable();
          renderRecentActivity();
          updateStats();
          
          showToast(`Ticket #${currentTicket.number} deleted successfully`);
          currentTicket = null;
        } else {
          throw new Error(data.error || 'Failed to delete ticket');
        }
      } catch (error) {
        console.error('Error deleting ticket:', error);
        showToast('Failed to delete ticket: ' + error.message, 'error');
      }
    }

    // Add Customer Modal
    function openAddCustomerModal() {
      document.getElementById('add-customer-form').reset();
      openModal('add-customer-modal');
    }

    document.getElementById('add-customer-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const btn = document.getElementById('add-customer-btn');
      const textEl = document.getElementById('add-customer-text');
      const spinnerEl = document.getElementById('add-customer-spinner');
      
      btn.disabled = true;
      textEl.textContent = 'Adding...';
      spinnerEl.classList.remove('hidden');
      
      const formData = new FormData(this);
      const customerData = {
        name: formData.get('name'),
        email: formData.get('email') || '',
        phone: formData.get('phone') || '',
        // Bill To (for invoicing)
        billToEmail: formData.get('billToEmail') || '',
        billToAddress: formData.get('billToAddress') || '',
        billToCity: formData.get('billToCity') || '',
        billToState: formData.get('billToState') || '',
        billToZip: formData.get('billToZip') || '',
        // Ship To Address
        shipToAddress: formData.get('shipToAddress') || '',
        shipToCity: formData.get('shipToCity') || '',
        shipToState: formData.get('shipToState') || '',
        shipToZip: formData.get('shipToZip') || '',
        pricingMethod: formData.get('pricingMethod') || 'Per Yard',
        priceYard: parseFloat(formData.get('priceYard')) || null,
        priceTon: parseFloat(formData.get('priceTon')) || null,
        freightMethod: formData.get('freightMethod') || '',
        freightCostMethod: formData.get('freightCostMethod') || '',
        freightRate: parseFloat(formData.get('freightRate')) || null,
        freightCost: parseFloat(formData.get('freightCost')) || null,
      };
      
      try {
        const newCustomer = await addCustomerToAirtable(customerData);
        CUSTOMERS.push(newCustomer);
        
        closeModal('add-customer-modal');
        populateDropdowns();
        renderCustomers();
        updateStats();
        showToast(`Customer "${newCustomer.name}" added successfully!`);
        
      } catch (error) {
        showToast('Failed to add customer: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        textEl.textContent = 'Add Customer';
        spinnerEl.classList.add('hidden');
      }
    });

    // Edit Customer Modal
    function openEditCustomerModal(customerId) {
      const customer = CUSTOMERS.find(c => c.id === customerId);
      if (!customer) return;
      
      document.getElementById('edit-customer-id').value = customer.id;
      document.getElementById('edit-customer-name').value = customer.name;
      document.getElementById('edit-customer-email').value = customer.email || '';
      document.getElementById('edit-customer-phone').value = customer.phone || '';
      
      // Bill To (for invoicing)
      document.getElementById('edit-customer-billToEmail').value = customer.billToEmail || '';
      document.getElementById('edit-customer-billToAddress').value = customer.billToAddress || customer.address1 || '';
      document.getElementById('edit-customer-billToCity').value = customer.billToCity || customer.city || '';
      document.getElementById('edit-customer-billToState').value = customer.billToState || customer.state || '';
      document.getElementById('edit-customer-billToZip').value = customer.billToZip || customer.zip || '';
      
      // Ship To Address
      document.getElementById('edit-customer-shipToAddress').value = customer.shipToAddress || '';
      document.getElementById('edit-customer-shipToCity').value = customer.shipToCity || '';
      document.getElementById('edit-customer-shipToState').value = customer.shipToState || '';
      document.getElementById('edit-customer-shipToZip').value = customer.shipToZip || '';
      
      document.getElementById('edit-customer-pricingMethod').value = customer.pricingMethod || 'Per Yard';
      document.getElementById('edit-customer-priceYard').value = customer.priceYard || '';
      document.getElementById('edit-customer-priceTon').value = customer.priceTon || '';
      document.getElementById('edit-customer-defaultNote').value = customer.defaultNote || '';
      document.getElementById('edit-customer-billingNotes').value = customer.billingNotes || '';
      
      // Freight settings
      document.getElementById('edit-customer-freightMethod').value = customer.freightMethod || '';
      document.getElementById('edit-customer-freightRate').value = customer.freightRate || '';
      document.getElementById('edit-customer-freightCostMethod').value = customer.freightCostMethod || '';
      document.getElementById('edit-customer-freightCost').value = customer.freightCost || '';
      
      // Email settings
      document.getElementById('edit-customer-emailReceipts').checked = customer.emailReceipts || false;
      
      // Populate product checkboxes
      const allowedProducts = customer.allowedProducts || [];
      const checkboxContainer = document.getElementById('allowed-products-checkboxes');
      checkboxContainer.innerHTML = PRODUCTS.filter(p => p.airtableId).map(p => {
        const isChecked = allowedProducts.includes(p.airtableId) ? 'checked' : '';
        return `
          <label class="flex items-center gap-2 p-2 rounded-lg hover:bg-slate-50 cursor-pointer">
            <input type="checkbox" name="allowedProducts" value="${p.airtableId}" ${isChecked} class="w-4 h-4 text-gold-500 rounded border-slate-300 focus:ring-gold-500">
            <span class="text-sm font-medium text-slate-700">${p.name}</span>
          </label>
        `;
      }).join('');
      
      openModal('edit-customer-modal');
    }

    document.getElementById('edit-customer-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const btn = document.getElementById('edit-customer-btn');
      const textEl = document.getElementById('edit-customer-text');
      const spinnerEl = document.getElementById('edit-customer-spinner');
      
      btn.disabled = true;
      textEl.textContent = 'Saving...';
      spinnerEl.classList.remove('hidden');
      
      const formData = new FormData(this);
      
      // Get selected product IDs from checkboxes
      const allowedProducts = [];
      document.querySelectorAll('#allowed-products-checkboxes input[type="checkbox"]:checked').forEach(cb => {
        allowedProducts.push(cb.value);
      });
      
      const customerData = {
        id: formData.get('id'),
        name: formData.get('name'),
        email: formData.get('email') || '',
        phone: formData.get('phone') || '',
        // Bill To (for invoicing)
        billToEmail: formData.get('billToEmail') || '',
        billToAddress: formData.get('billToAddress') || '',
        billToCity: formData.get('billToCity') || '',
        billToState: formData.get('billToState') || '',
        billToZip: formData.get('billToZip') || '',
        // Ship To Address
        shipToAddress: formData.get('shipToAddress') || '',
        shipToCity: formData.get('shipToCity') || '',
        shipToState: formData.get('shipToState') || '',
        shipToZip: formData.get('shipToZip') || '',
        pricingMethod: formData.get('pricingMethod') || 'Per Yard',
        priceYard: parseFloat(formData.get('priceYard')) || null,
        priceTon: parseFloat(formData.get('priceTon')) || null,
        defaultNote: formData.get('defaultNote') || '',
        billingNotes: formData.get('billingNotes') || '',
        freightMethod: formData.get('freightMethod') || '',
        freightCostMethod: formData.get('freightCostMethod') || '',
        freightRate: parseFloat(formData.get('freightRate')) || null,
        freightCost: parseFloat(formData.get('freightCost')) || null,
        allowedProducts: allowedProducts,
        // Email settings
        emailReceipts: document.getElementById('edit-customer-emailReceipts').checked,
      };
      
      try {
        const updatedCustomer = await updateCustomerInAirtable(customerData);
        
        // Preserve allowedProducts from what we submitted if server doesn't return it
        if (!updatedCustomer.allowedProducts || updatedCustomer.allowedProducts.length === 0) {
          updatedCustomer.allowedProducts = allowedProducts;
        }
        
        const idx = CUSTOMERS.findIndex(c => c.id === customerData.id);
        if (idx !== -1) {
          CUSTOMERS[idx] = { ...CUSTOMERS[idx], ...updatedCustomer };
        }
        
        closeModal('edit-customer-modal');
        populateDropdowns();
        renderCustomers();
        
        // Show warning if billing fields weren't saved
        if (updatedCustomer._warning) {
          showToast(updatedCustomer._warning, 'warning');
        }
        showToast(`Customer "${updatedCustomer.name}" updated successfully!`);
        
      } catch (error) {
        showToast('Failed to update customer: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        textEl.textContent = 'Save Changes';
        spinnerEl.classList.add('hidden');
      }
    });

    // Delete Customer - Confirmation
    let customerToDelete = null;

    function confirmDeleteCustomer() {
      const customerId = document.getElementById('edit-customer-id').value;
      const customer = CUSTOMERS.find(c => c.id === customerId);
      if (!customer) return;
      
      customerToDelete = customer;
      document.getElementById('delete-customer-name').textContent = customer.name;
      openModal('delete-confirm-modal');
    }

    async function executeDeleteCustomer() {
      if (!customerToDelete) return;
      
      const btn = document.getElementById('delete-confirm-btn');
      const textEl = document.getElementById('delete-btn-text');
      const spinnerEl = document.getElementById('delete-spinner');
      
      btn.disabled = true;
      textEl.textContent = 'Deleting...';
      spinnerEl.classList.remove('hidden');
      
      try {
        await deleteCustomerFromAirtable(customerToDelete.id);
        
        // Remove from local array
        const idx = CUSTOMERS.findIndex(c => c.id === customerToDelete.id);
        if (idx !== -1) {
          CUSTOMERS.splice(idx, 1);
        }
        
        const deletedName = customerToDelete.name;
        customerToDelete = null;
        
        closeModal('delete-confirm-modal');
        closeModal('edit-customer-modal');
        populateDropdowns();
        renderCustomers();
        updateStats();
        showToast(`Customer "${deletedName}" deleted successfully!`);
        
      } catch (error) {
        showToast('Failed to delete customer: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        textEl.textContent = 'Delete Customer';
        spinnerEl.classList.add('hidden');
      }
    }

    // Upload Customers Modal
    function openUploadCustomersModal() {
      pendingCSVData = null;
      document.getElementById('csv-file-input').value = '';
      document.getElementById('upload-preview').classList.add('hidden');
      document.getElementById('upload-zone').classList.remove('hidden');
      openModal('upload-customers-modal');
    }

    document.getElementById('csv-file-input').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(event) {
        const csv = event.target.result;
        const lines = csv.split('\n').filter(line => line.trim());
        
        const customers = [];
        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(',');
          if (values[0] && values[0].trim()) {
            customers.push({
              name: values[0]?.trim() || '',
              address1: values[1]?.trim() || '',
              email: values[2]?.trim() || '',
              address2: values[3]?.trim() || '',
              city: values[4]?.trim() || '',
              state: values[5]?.trim() || '',
              zip: values[6]?.trim() || '',
              phone: values[7]?.trim() || '',
              mobilePhone: values[8]?.trim() || '',
              priceYard: parseFloat(values[9]?.replace(/[$\s]/g, '')) || null,
              priceTon: parseFloat(values[10]?.replace(/[$\s]/g, '')) || null,
            });
          }
        }
        
        const existingNames = CUSTOMERS.map(c => c.name.toLowerCase());
        const newCustomers = customers.filter(c => !existingNames.includes(c.name.toLowerCase()));
        const duplicates = customers.length - newCustomers.length;
        
        pendingCSVData = newCustomers;
        
        document.getElementById('upload-filename').textContent = file.name;
        document.getElementById('upload-count').textContent = customers.length;
        document.getElementById('upload-new-count').textContent = newCustomers.length;
        document.getElementById('upload-skip-count').textContent = duplicates;
        document.getElementById('upload-zone').classList.add('hidden');
        document.getElementById('upload-preview').classList.remove('hidden');
      };
      reader.readAsText(file);
    });

    function cancelUpload() {
      pendingCSVData = null;
      closeModal('upload-customers-modal');
    }

    async function confirmUpload() {
      if (!pendingCSVData || pendingCSVData.length === 0) {
        showToast('No new customers to import', 'error');
        return;
      }
      
      const btn = document.getElementById('upload-confirm-btn');
      const textEl = document.getElementById('upload-btn-text');
      const spinnerEl = document.getElementById('upload-spinner');
      
      btn.disabled = true;
      textEl.textContent = 'Importing...';
      spinnerEl.classList.remove('hidden');
      
      try {
        const result = await importCustomersToAirtable(pendingCSVData);
        
        // Reload customers from Airtable to get the new records with IDs
        await loadCustomersFromAirtable();
        
        pendingCSVData = null;
        closeModal('upload-customers-modal');
        populateDropdowns();
        renderCustomers();
        updateStats();
        
        showToast(result.message || `Imported ${result.imported} customers!`);
        
      } catch (error) {
        showToast('Failed to import: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        textEl.textContent = 'Import Customers';
        spinnerEl.classList.add('hidden');
      }
    }

    // Drag and drop for upload zone
    const uploadZone = document.getElementById('upload-zone');
    if (uploadZone) {
      uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
      });
      uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover');
      });
      uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file && file.name.endsWith('.csv')) {
          document.getElementById('csv-file-input').files = e.dataTransfer.files;
          document.getElementById('csv-file-input').dispatchEvent(new Event('change'));
        }
      });
    }

    // ==================== CARRIER MANAGEMENT ====================
    function openAddCarrierModal() { 
      document.getElementById('add-carrier-form').reset();
      openModal('add-carrier-modal'); 
    }

    function openEditCarrierModal(carrierId) {
      const carrier = CARRIERS.find(c => c.id === carrierId || String(c.id) === String(carrierId));
      if (!carrier) {
        console.error('Carrier not found:', carrierId);
        showToast('Carrier not found', 'error');
        return;
      }
      
      document.getElementById('edit-carrier-id').value = carrier.id;
      document.getElementById('edit-carrier-name').value = carrier.name;
      document.getElementById('edit-carrier-phone').value = carrier.phone || '';
      document.getElementById('edit-carrier-email').value = carrier.email || '';
      document.getElementById('edit-carrier-address').value = carrier.address || '';
      document.getElementById('edit-carrier-city').value = carrier.city || '';
      document.getElementById('edit-carrier-state').value = carrier.state || '';
      document.getElementById('edit-carrier-zip').value = carrier.zip || '';
      openModal('edit-carrier-modal');
    }

    document.getElementById('add-carrier-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      
      try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Adding...';
        
        const carrierData = {
          name: formData.get('carrierName').trim(),
          phone: formData.get('carrierPhone')?.trim() || '',
          email: formData.get('carrierEmail')?.trim() || '',
          address: formData.get('carrierAddress')?.trim() || '',
          city: formData.get('carrierCity')?.trim() || '',
          state: formData.get('carrierState')?.trim() || '',
          zip: formData.get('carrierZip')?.trim() || ''
        };
        
        const response = await fetch('/api/carriers/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(carrierData)
        });
        
        const result = await response.json();
        
        if (!response.ok || !result.success) {
          throw new Error(result.error || 'Failed to add carrier');
        }
        
        // Add to local array with Airtable ID
        CARRIERS.push(result.carrier);
        closeModal('add-carrier-modal');
        this.reset();
        populateDropdowns();
        renderTrucksAndCarriers();
        showToast(`Carrier "${result.carrier.name}" added successfully!`);
        
      } catch (error) {
        console.error('Error adding carrier:', error);
        showToast(error.message || 'Failed to add carrier', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });

    document.getElementById('edit-carrier-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      const carrierId = formData.get('carrierId');
      
      try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Saving...';
        
        const carrierData = {
          id: carrierId,
          name: formData.get('carrierName').trim(),
          phone: formData.get('carrierPhone')?.trim() || '',
          email: formData.get('carrierEmail')?.trim() || '',
          address: formData.get('carrierAddress')?.trim() || '',
          city: formData.get('carrierCity')?.trim() || '',
          state: formData.get('carrierState')?.trim() || '',
          zip: formData.get('carrierZip')?.trim() || ''
        };
        
        const response = await fetch('/api/carriers/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(carrierData)
        });
        
        const result = await response.json();
        
        if (!response.ok || !result.success) {
          throw new Error(result.error || 'Failed to update carrier');
        }
        
        // Update local array
        const idx = CARRIERS.findIndex(c => c.id === carrierId || String(c.id) === carrierId);
        if (idx !== -1) {
          CARRIERS[idx] = result.carrier;
        }
        
        closeModal('edit-carrier-modal');
        populateDropdowns();
        renderTrucksAndCarriers();
        showToast(`Carrier "${result.carrier.name}" updated successfully!`);
        
      } catch (error) {
        console.error('Error updating carrier:', error);
        showToast(error.message || 'Failed to update carrier', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });

    function confirmDeleteCarrier() {
      const carrierId = document.getElementById('edit-carrier-id').value;
      const carrier = CARRIERS.find(c => c.id === carrierId || String(c.id) === carrierId);
      if (!carrier) return;
      
      if (confirm(`Are you sure you want to delete "${carrier.name}"?`)) {
        const idx = CARRIERS.findIndex(c => c.id === carrierId || String(c.id) === carrierId);
        if (idx !== -1) {
          CARRIERS.splice(idx, 1);
          closeModal('edit-carrier-modal');
          populateDropdowns();
          renderTrucksAndCarriers();
          showToast(`Carrier deleted successfully!`);
        }
      }
    }

    // ==================== TRUCK MANAGEMENT ====================
    function openAddTruckModal() { 
      document.getElementById('add-truck-form').reset();
      // Populate carrier dropdown
      const select = document.getElementById('add-truck-carrier');
      select.innerHTML = '<option value="">-- Select Carrier --</option>';
      CARRIERS.forEach(c => {
        select.innerHTML += `<option value="${c.name}">${c.name}</option>`;
      });
      openModal('add-truck-modal'); 
    }

    function openEditTruckModal(truckId) {
      const truck = TRUCKS.find(t => t.id === truckId);
      if (!truck) return;
      
      document.getElementById('edit-truck-index').value = truck.id;
      document.getElementById('edit-truck-id').value = truck.truckId;
      
      // Populate carrier dropdown
      const select = document.getElementById('edit-truck-carrier');
      select.innerHTML = '<option value="">-- Select Carrier --</option>';
      CARRIERS.forEach(c => {
        select.innerHTML += `<option value="${c.name}" ${truck.carrier === c.name ? 'selected' : ''}>${c.name}</option>`;
      });
      
      openModal('edit-truck-modal');
    }

    // Note: add-truck-form handler is defined in API DATA LOADING section above

    document.getElementById('edit-truck-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const truckId = parseInt(formData.get('truckIndex'));
      const idx = TRUCKS.findIndex(t => t.id === truckId);
      
      if (idx !== -1) {
        TRUCKS[idx].truckId = formData.get('truckId').trim();
        TRUCKS[idx].carrier = formData.get('truckCarrier') || '';
        
        closeModal('edit-truck-modal');
        populateDropdowns();
        renderSettings();
        showToast(`Truck "${TRUCKS[idx].truckId}" updated successfully!`);
      }
    });

    function confirmDeleteTruck() {
      const truckId = parseInt(document.getElementById('edit-truck-index').value);
      const truck = TRUCKS.find(t => t.id === truckId);
      if (!truck) return;
      
      if (confirm(`Are you sure you want to delete "${truck.truckId}"?`)) {
        const idx = TRUCKS.findIndex(t => t.id === truckId);
        if (idx !== -1) {
          TRUCKS.splice(idx, 1);
          closeModal('edit-truck-modal');
          populateDropdowns();
          renderSettings();
          showToast(`Truck deleted successfully!`);
        }
      }
    }

    // ==================== PRODUCT MANAGEMENT ====================
    let editingProductId = null;

    function openEditProductModal(productId) {
      const product = PRODUCTS.find(p => p.id === productId);
      if (!product) return;
      
      editingProductId = productId;
      
      const form = document.getElementById('edit-product-form');
      form.querySelector('[name="productId"]').value = productId;
      form.querySelector('[name="productName"]').value = product.name;
      form.querySelector('[name="productWeight"]').value = product.lbsPerYard || '';
      form.querySelector('[name="productPriceYard"]').value = product.priceYard || '';
      form.querySelector('[name="productPriceTon"]').value = product.priceTon || '';
      form.querySelector('[name="productQBCode"]').value = product.qbCode || '';
      
      // Show warning if not linked to Airtable
      const warning = document.getElementById('product-airtable-warning');
      if (!product.airtableId) {
        warning.classList.remove('hidden');
      } else {
        warning.classList.add('hidden');
      }
      
      openModal('edit-product-modal');
    }

    document.getElementById('edit-product-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const productId = this.querySelector('[name="productId"]').value;
      const product = PRODUCTS.find(p => p.id === productId);
      if (!product) return;
      
      const newWeight = parseInt(this.querySelector('[name="productWeight"]').value) || 0;
      const newPriceYard = parseFloat(this.querySelector('[name="productPriceYard"]').value) || null;
      const newPriceTon = parseFloat(this.querySelector('[name="productPriceTon"]').value) || null;
      const newQBCode = this.querySelector('[name="productQBCode"]').value.trim() || '';
      
      const btn = document.getElementById('save-product-btn');
      const originalText = btn.textContent;
      
      btn.textContent = 'Saving...';
      btn.disabled = true;
      
      try {
        // Update local data
        product.lbsPerYard = newWeight;
        product.priceYard = newPriceYard;
        product.priceTon = newPriceTon;
        product.qbCode = newQBCode;
        
        // Try to save to Airtable if linked
        if (product.airtableId) {
          await updateProductInAirtable(product);
          showToast(`Product "${product.name}" updated in Airtable!`);
        } else {
          showToast(`Product "${product.name}" updated locally`);
        }
        
        closeModal('edit-product-modal');
        populateDropdowns();
        renderSettings();
        // Refresh pricing view if it's active
        if (typeof initPricingView === 'function' && document.getElementById('pricing')?.classList.contains('hidden') === false) {
          initPricingView();
        }
        
      } catch (error) {
        showToast('Failed to save: ' + error.message, 'error');
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    });

    // Add User Modal
    function openAddUserModal() { 
      document.getElementById('add-user-form').reset();
      openModal('add-user-modal'); 
    }

    document.getElementById('add-user-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const role = formData.get('userRole');
      const newUser = {
        id: 'user_' + Date.now(),
        name: formData.get('userName'),
        role: role,
        pin: formData.get('userPin'),
        icon: role === 'admin' ? 'üëë' : role === 'finance' ? 'üí∞' : 'üë∑',
        label: role === 'admin' ? 'Administrator' : role === 'finance' ? 'Finance' : 'Operator'
      };
      
      USERS.push(newUser);
      saveUsersToStorage();
      closeModal('add-user-modal');
      renderSettings();
      
      const loginSelect = document.getElementById('login-user');
      loginSelect.innerHTML = '<option value="">Select your role...</option>';
      USERS.forEach(u => {
        loginSelect.innerHTML += `<option value="${u.id}">${u.icon} ${u.name} (${u.label})</option>`;
      });
      
      showToast(`User "${newUser.name}" added successfully!`);
    });

    // Edit User Modal
    function openEditUserModal(userId) {
      const user = USERS.find(u => u.id === userId);
      if (!user) return;
      
      document.getElementById('edit-user-id').value = user.id;
      document.getElementById('edit-user-name').value = user.name;
      document.getElementById('edit-user-role').value = user.role;
      document.getElementById('edit-user-pin').value = user.pin;
      
      openModal('edit-user-modal');
    }

    document.getElementById('edit-user-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const userId = document.getElementById('edit-user-id').value;
      const user = USERS.find(u => u.id === userId);
      if (!user) return;
      
      const newRole = document.getElementById('edit-user-role').value;
      
      user.name = document.getElementById('edit-user-name').value;
      user.role = newRole;
      user.pin = document.getElementById('edit-user-pin').value;
      user.icon = newRole === 'admin' ? 'üëë' : newRole === 'finance' ? 'üí∞' : 'üë∑';
      user.label = newRole === 'admin' ? 'Administrator' : newRole === 'finance' ? 'Finance' : 'Operator';
      
      saveUsersToStorage();
      closeModal('edit-user-modal');
      renderSettings();
      updateLoginDropdown();
      
      showToast(`User "${user.name}" updated successfully!`);
    });

    function deleteUser() {
      const userId = document.getElementById('edit-user-id').value;
      const user = USERS.find(u => u.id === userId);
      if (!user) return;
      
      // Prevent deleting the last admin
      const adminCount = USERS.filter(u => u.role === 'admin').length;
      if (user.role === 'admin' && adminCount <= 1) {
        showToast('Cannot delete the last administrator!', 'error');
        return;
      }
      
      // Prevent deleting yourself
      if (currentUser && currentUser.id === userId) {
        showToast('Cannot delete yourself while logged in!', 'error');
        return;
      }
      
      if (!confirm(`Are you sure you want to delete "${user.name}"? This cannot be undone.`)) {
        return;
      }
      
      USERS = USERS.filter(u => u.id !== userId);
      saveUsersToStorage();
      closeModal('edit-user-modal');
      renderSettings();
      updateLoginDropdown();
      
      showToast(`User "${user.name}" deleted successfully!`);
    }

    function updateLoginDropdown() {
      const loginSelect = document.getElementById('login-user');
      loginSelect.innerHTML = '<option value="">Select your role...</option>';
      USERS.forEach(u => {
        loginSelect.innerHTML += `<option value="${u.id}">${u.icon} ${u.name} (${u.label})</option>`;
      });
    }

    function saveUsersToStorage() {
      localStorage.setItem('beaverPumiceUsers', JSON.stringify(USERS));
    }

    function loadUsersFromStorage() {
      const stored = localStorage.getItem('beaverPumiceUsers');
      if (stored) {
        try {
          const storedUsers = JSON.parse(stored);
          
          // v70: Default users with correct roles - these ALWAYS override cached values
          const defaultUsers = [
            { id: 'admin', name: 'Lucas', role: 'admin', pin: '1234', icon: 'üëë', label: 'Administrator' },
            { id: 'admin2', name: 'Brent', role: 'admin', pin: '5678', icon: 'üëë', label: 'Administrator' },
            { id: 'finance', name: 'Jesse', role: 'admin', pin: '1357', icon: 'üí∞', label: 'Finance/Admin' },
            { id: 'user', name: 'Doug', role: 'user', pin: '0000', icon: 'üë∑', label: 'Operator' }
          ];
          
          // Merge: keep custom users from storage, but ensure defaults exist
          USERS = [...storedUsers];
          defaultUsers.forEach(defaultUser => {
            const existingIndex = USERS.findIndex(u => u.id === defaultUser.id);
            if (existingIndex >= 0) {
              // v70: FORCE update default users' roles from code (overrides localStorage)
              USERS[existingIndex].role = defaultUser.role;
              USERS[existingIndex].icon = defaultUser.icon;
              USERS[existingIndex].label = defaultUser.label;
              USERS[existingIndex].pin = defaultUser.pin;
            } else {
              USERS.push(defaultUser);
            }
          });
          
        } catch (e) {
          console.error('Failed to load users from storage:', e);
        }
      }
    }

    // ==================== PRINT & EMAIL ====================
    function printTicket(ticketId) {
      const ticket = tickets.find(t => t.id === ticketId || t.airtableId === ticketId);
      if (!ticket) {
        showToast('Ticket not found', 'error');
        return;
      }
      // Use printUrl if available, otherwise construct from airtableId
      const url = ticket.printUrl || `/ticket-viewer.html?id=${ticket.airtableId || ticket.id}`;
      console.log('printTicket opening:', url);
      window.open(url, '_blank');
    }

    function emailTicket(ticketId) {
      const ticket = tickets.find(t => t.id === ticketId || t.airtableId === ticketId);
      if (!ticket) {
        showToast('Could not find ticket to email', 'error');
        return;
      }
      openEmailForTicket(ticket);
    }

    function printTicketFromModal() { 
      console.log('printTicketFromModal called, currentTicket:', currentTicket);
      if (currentTicket) {
        const url = currentTicket.printUrl || `/ticket-viewer.html?id=${currentTicket.airtableId || currentTicket.id}`;
        window.open(url, '_blank');
      } else {
        showToast('No ticket selected', 'error');
      }
    }
    
    function printNewTicket() { 
      console.log('printNewTicket called, lastCreatedTicket:', lastCreatedTicket);
      if (lastCreatedTicket) {
        const url = lastCreatedTicket.printUrl || `/ticket-viewer.html?id=${lastCreatedTicket.airtableId || lastCreatedTicket.id}`;
        console.log('Opening print URL:', url);
        window.open(url, '_blank');
      } else {
        console.log('No lastCreatedTicket available');
        showToast('No ticket to print', 'error');
      }
    }
    
    function emailTicketFromModal() { 
      console.log('emailTicketFromModal called, currentTicket:', currentTicket);
      if (currentTicket) {
        openEmailForTicket(currentTicket); 
      } else {
        showToast('No ticket selected', 'error');
      }
    }
    
    function copyNewTicket() { 
      console.log('copyNewTicket called, lastCreatedTicket:', lastCreatedTicket);
      if (lastCreatedTicket) {
        copyTicketDetailsToClipboard(lastCreatedTicket);
      } else {
        showToast('No ticket to copy', 'error');
      }
    }
    
    function openEmailForTicket(ticket) {
      // Show email prompt
      const customer = CUSTOMERS.find(c => c.id === ticket.customerId || c.name === ticket.customer);
      const defaultEmail = customer?.email || customer?.billToEmail || '';
      
      const recipientEmail = prompt('Enter email address to send ticket to:', defaultEmail);
      
      if (!recipientEmail) {
        return; // User cancelled
      }
      
      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(recipientEmail)) {
        showToast('Invalid email address', 'error');
        return;
      }
      
      // Show sending indicator
      showToast('Sending email...', 'info');
      
      // Prepare ticket data for email - use same calculation as main UI
      const net = (ticket.gross || 0) - (ticket.tare || 0);
      const tons = (net / 2000).toFixed(2);
      const product = PRODUCTS.find(p => p.id === ticket.productId || p.name === ticket.product);
      const lbsPerYard = (product && product.lbsPerYard > 0) ? product.lbsPerYard : 1350;
      const yards = (net / lbsPerYard).toFixed(2); // Same formula as calcYards()
      
      const ticketData = {
        ticketNumber: ticket.number,
        date: ticket.date,
        time: '',
        customerName: ticket.customer,
        productName: ticket.product,
        grossWeight: ticket.gross || 0,
        tareWeight: ticket.tare || 0,
        netWeight: net,
        netTons: parseFloat(tons),
        netYards: parseFloat(yards),
        carrierName: ticket.carrier || '',
        truckId: ticket.truck || '',
        notes: ticket.note || ''
      };
      
      // Call email API
      fetch('/api/email/send-ticket', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ticket: ticketData,
          customer: customer || {},
          sendTo: recipientEmail
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast(`Email sent to ${recipientEmail}!`, 'success');
        } else {
          showToast(data.error || 'Failed to send email', 'error');
        }
      })
      .catch(error => {
        console.error('Email send error:', error);
        showToast('Failed to send email: ' + error.message, 'error');
      });
    }
    
    function copyTicketToClipboard() {
      if (currentTicket) {
        copyTicketDetailsToClipboard(currentTicket);
      } else if (lastCreatedTicket) {
        copyTicketDetailsToClipboard(lastCreatedTicket);
      } else {
        showToast('No ticket to copy', 'error');
      }
    }
    
    function copyTicketDetailsToClipboard(ticket) {
      console.log('copyTicketDetailsToClipboard called:', ticket);
      const net = (ticket.gross || 0) - (ticket.tare || 0);
      const tons = (net / 2000).toFixed(2);
      
      const text = 
`Beaver Pumice Weight Ticket #${ticket.number}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Customer: ${ticket.customer || 'N/A'}
Product: ${ticket.product || 'N/A'}
Hauling For: ${ticket.carrier || '‚Äî'}
Truck: ${ticket.truck || '‚Äî'}

WEIGHTS
Tare: ${(ticket.tare || 0).toLocaleString()} lbs
Gross: ${(ticket.gross || 0).toLocaleString()} lbs
Net: ${net.toLocaleString()} lbs
Tons: ${tons}

View/Print Ticket:
${ticket.printUrl || window.location.origin + '/ticket-viewer.html?id=' + ticket.id}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Beaver Pumice ‚Ä¢ Chemult, Oregon
92777 HWY 97 N ‚Ä¢ (541) 365-2288`;

      navigator.clipboard.writeText(text).then(() => {
        showToast('Ticket details copied to clipboard!');
      }).catch(err => {
        console.error('Failed to copy:', err);
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast('Ticket details copied to clipboard!');
      });
    }

    // v2.2-HOTFIX: Auto-send ticket email on creation (if customer has auto-email enabled)
    async function sendTicketEmail(ticketId, ticket, customer, recipientEmail) {
      console.log('sendTicketEmail called:', { ticketId, ticketNumber: ticket.number, recipientEmail });

      try {
        const netWeight = ticket.netLbs || ((ticket.gross || 0) - (ticket.tare || 0));
        const netTons = ticket.netTons || (netWeight / 2000);

        // v2.2-HOTFIX: Calculate netYards if Airtable didn't provide it
        // This fixes the 0.00 CY issue Grant reported
        let netYards = ticket.netYards || 0;

        if (!netYards || netYards === 0) {
          console.warn('‚ö†Ô∏è netYards missing from Airtable, calculating fallback');
          // Get product to find lbs/yard conversion
          const product = PRODUCTS.find(p =>
            p.id === ticket.productId ||
            p.airtableId === ticket.productId ||
            p.name === ticket.product
          );
          const lbsPerYard = (product && product.lbsPerYard > 0) ? product.lbsPerYard : 1350;
          netYards = netWeight / lbsPerYard;
          console.log(`üìê Calculated netYards: ${netWeight} lbs √∑ ${lbsPerYard} lbs/yd = ${netYards.toFixed(2)} yards`);
        }

        // Prepare ticket data for email - use data from Airtable (already calculated)
        const ticketData = {
          ticketNumber: ticket.number,
          date: ticket.date || new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }),
          time: '',
          customerName: ticket.customer || customer?.name || '',
          productName: ticket.product || '',
          grossWeight: ticket.gross || 0,
          tareWeight: ticket.tare || 0,
          netWeight: netWeight,
          netTons: netTons,
          netYards: netYards,  // v2.2-HOTFIX: Use calculated or Airtable value
          carrierName: ticket.carrier || '',
          truckId: ticket.truck || '',
          notes: ticket.note || ticket.customerNote || ''
        };

        console.log('üìß Email ticket data:', ticketData);
        console.log('‚úÖ netYards for email:', ticketData.netYards.toFixed(2), 'CY');

        // Call email API
        const response = await fetch('/api/email/send-ticket', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ticket: ticketData,
            customer: customer || {},
            sendTo: recipientEmail
          })
        });

        const data = await response.json();

        if (data.success) {
          console.log(`‚úÖ Email sent successfully to ${recipientEmail}`);
          return { sent: true };
        } else {
          console.error('Email send failed:', data.error);
          return { sent: false, reason: data.error || 'Unknown error' };
        }
      } catch (error) {
        console.error('Email send exception:', error);
        return { sent: false, reason: error.message };
      }
    }

    function hideSuccessBanner() { document.getElementById('success-banner').classList.add('hidden'); }

    // ==================== EDIT TICKET (Admin Only) ====================
    function editTicketFromModal() {
      console.log('editTicketFromModal called');
      console.log('currentTicket:', currentTicket);
      console.log('currentUser:', currentUser);
      
      if (!currentTicket) {
        console.error('No currentTicket set');
        showToast('No ticket selected', 'error');
        return;
      }
      if (currentUser?.role !== 'admin') {
        console.error('User is not admin');
        showToast('Admin access required', 'error');
        return;
      }
      
      openEditTicketModal(currentTicket.id);
    }

    function openEditTicketModal(ticketId) {
      console.log('openEditTicketModal called with ticketId:', ticketId);
      const ticket = tickets.find(t => t.id === ticketId);
      console.log('Found ticket:', ticket);
      
      if (!ticket) {
        console.error('Ticket not found in tickets array');
        showToast('Ticket not found', 'error');
        return;
      }
      
      document.getElementById('edit-ticket-id').value = ticket.id;
      document.getElementById('edit-ticket-number').textContent = ticket.number;
      document.getElementById('edit-ticket-gross').value = ticket.gross || '';
      document.getElementById('edit-ticket-tare').value = ticket.tare || '';
      document.getElementById('edit-ticket-po').value = ticket.po || '';
      document.getElementById('edit-ticket-note').value = ticket.note || '';
      
      // Populate freight fields
      document.getElementById('edit-ticket-freight-cost').value = ticket.freightCost || '';
      document.getElementById('edit-ticket-freight-charge').value = ticket.freightCharge || '';
      calculateEditFreightMargin();
      
      // Populate dropdowns
      populateEditTicketDropdowns(ticket);
      
      closeModal('ticket-modal');
      openModal('edit-ticket-modal');
    }

    function populateEditTicketDropdowns(ticket) {
      // Customer dropdown
      const customerSelect = document.getElementById('edit-ticket-customer');
      customerSelect.innerHTML = '<option value="">Select customer...</option>';
      CUSTOMERS.forEach(c => {
        const selected = (c.name === ticket.customer || c.id === ticket.customerId) ? 'selected' : '';
        const allowedProducts = JSON.stringify(c.allowedProducts || []);
        customerSelect.innerHTML += `<option value="${c.id}" data-allowed-products='${allowedProducts}' ${selected}>${c.name}</option>`;
      });
      
      // Add customer change listener for edit modal
      customerSelect.removeEventListener('change', handleEditCustomerChange);
      customerSelect.addEventListener('change', handleEditCustomerChange);
      
      // Carrier dropdown
      const carrierSelect = document.getElementById('edit-ticket-carrier');
      carrierSelect.innerHTML = '<option value="">Select carrier...</option>';
      CARRIERS.forEach(c => {
        const selected = (c.name === ticket.carrier || c.id === ticket.carrierId) ? 'selected' : '';
        carrierSelect.innerHTML += `<option value="${c.id}" ${selected}>${c.name}</option>`;
      });
      
      // Truck text input (no longer a dropdown)
      const truckInput = document.getElementById('edit-ticket-truck');
      truckInput.value = ticket.truck || '';
      
      // Product dropdown - filter based on selected customer's allowed products
      populateEditProductDropdown(ticket.product, ticket.productId);
    }
    
    // Populate edit modal product dropdown (optionally filtered)
    function populateEditProductDropdown(currentProductName = null, currentProductId = null) {
      const customerSelect = document.getElementById('edit-ticket-customer');
      const productSelect = document.getElementById('edit-ticket-product');
      
      // Get allowed products from selected customer
      let allowedProducts = [];
      const selectedOption = customerSelect.selectedOptions[0];
      if (selectedOption && selectedOption.value) {
        try {
          const allowedProductsJson = selectedOption.getAttribute('data-allowed-products');
          allowedProducts = allowedProductsJson ? JSON.parse(allowedProductsJson) : [];
        } catch (err) {
          allowedProducts = [];
        }
      }
      
      productSelect.innerHTML = '<option value="">Select product...</option>';
      
      let productsToShow = PRODUCTS;
      if (allowedProducts.length > 0) {
        productsToShow = PRODUCTS.filter(p => 
          allowedProducts.includes(p.id) || allowedProducts.includes(p.airtableId)
        );
      }
      
      productsToShow.forEach(p => {
        const productId = p.id || p.airtableId;
        const selected = (p.name === currentProductName || productId === currentProductId) ? 'selected' : '';
        productSelect.innerHTML += `<option value="${productId}" ${selected}>${p.name}</option>`;
      });
      
      // Auto-select if only one product
      if (productsToShow.length === 1 && !currentProductName && !currentProductId) {
        productSelect.value = productsToShow[0].id || productsToShow[0].airtableId;
      }
    }
    
    // Handle customer change in edit modal
    function handleEditCustomerChange(e) {
      populateEditProductDropdown();
    }

    document.getElementById('edit-ticket-form')?.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const ticketId = document.getElementById('edit-ticket-id').value;
      const ticket = tickets.find(t => t.id === ticketId);
      if (!ticket) return;
      
      const updateData = {
        id: ticketId,
        customerId: document.getElementById('edit-ticket-customer').value,
        carrierId: document.getElementById('edit-ticket-carrier').value,
        truck: document.getElementById('edit-ticket-truck').value.trim(), // Truck is now text
        productId: document.getElementById('edit-ticket-product').value,
        gross: parseInt(document.getElementById('edit-ticket-gross').value) || 0,
        tare: parseInt(document.getElementById('edit-ticket-tare').value) || 0,
        po: document.getElementById('edit-ticket-po').value,
        note: document.getElementById('edit-ticket-note').value,
        freightCost: parseFloat(document.getElementById('edit-ticket-freight-cost').value) || 0,
        freightCharge: parseFloat(document.getElementById('edit-ticket-freight-charge').value) || 0
      };
      
      try {
        const response = await fetch('/api/tickets/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updateData)
        });
        
        if (!response.ok) throw new Error('Failed to update ticket');
        
        const result = await response.json();
        
        // Update local ticket data - include IDs so re-render works correctly
        Object.assign(ticket, {
          customerId: updateData.customerId,  // v69: Fix - update the ID too
          customer: document.getElementById('edit-ticket-customer').selectedOptions[0]?.text || '',
          carrierId: updateData.carrierId,    // v69: Fix - update the ID too
          carrier: document.getElementById('edit-ticket-carrier').selectedOptions[0]?.text || '',
          productId: updateData.productId,    // v69: Fix - update the ID too
          truck: document.getElementById('edit-ticket-truck').value.trim(), // Truck is now text
          product: document.getElementById('edit-ticket-product').selectedOptions[0]?.text || '',
          gross: updateData.gross,
          tare: updateData.tare,
          po: updateData.po,
          note: updateData.note,
          freightCost: updateData.freightCost,
          freightCharge: updateData.freightCharge,
          freightMargin: updateData.freightCharge - updateData.freightCost
        });
        
        closeModal('edit-ticket-modal');
        renderTicketsTable();
        showToast(`Ticket #${ticket.number} updated successfully!`);
        
      } catch (error) {
        console.error('Error updating ticket:', error);
        showToast('Failed to update ticket: ' + error.message, 'error');
      }
    });

    // ==================== TICKET FORM ====================
    // Note: Tare weight is NOT auto-filled because it varies each time due to fuel weight
    
    const grossInput = document.getElementById('ticket-gross');
    const tareInput = document.getElementById('ticket-tare');
    const productSelect = document.getElementById('ticket-product');
    const customerSelectForCalc = document.getElementById('ticket-customer');

    function updateCalcs() {
      const gross = parseInt(grossInput?.value) || 0;
      const tare = parseInt(tareInput?.value) || 0;
      const product = productSelect?.value;
      
      if (gross && tare) {
        const net = gross - tare;
        const tons = net / 2000;
        const yards = product ? parseFloat(calcYards(gross, tare, product)) : 0;
        
        document.getElementById('calc-net').textContent = net.toLocaleString();
        document.getElementById('calc-tons').textContent = tons.toFixed(2);
        document.getElementById('calc-yards').textContent = product ? yards.toFixed(2) : '‚Äî';
        
        // v69: Calculate $ amount based on customer's pricing method
        const customerId = customerSelectForCalc?.selectedOptions[0]?.dataset.airtableid;
        const customer = CUSTOMERS.find(c => (c.airtableId || c.id) === customerId);
        
        let amount = 0;
        let rateInfo = '‚Äî';
        
        if (customer) {
          const method = (customer.pricingMethod || '').toLowerCase();
          const billByTon = method.includes('ton') || (customer.priceTon && !customer.priceYard);
          
          if (billByTon && customer.priceTon) {
            amount = tons * customer.priceTon;
            rateInfo = `$${customer.priceTon}/ton`;
          } else if (customer.priceYard) {
            amount = yards * customer.priceYard;
            rateInfo = `$${customer.priceYard}/yard`;
          } else {
            amount = yards * 13;
            rateInfo = '$13/yard (default)';
          }
        } else {
          amount = yards * 13;
          rateInfo = 'Select customer';
        }
        
        document.getElementById('calc-amount').textContent = '$' + amount.toFixed(2);
        document.getElementById('calc-rate-info').textContent = rateInfo;
        document.getElementById('calculations').classList.remove('hidden');
      } else {
        document.getElementById('calculations').classList.add('hidden');
      }
    }

    grossInput?.addEventListener('input', updateCalcs);
    tareInput?.addEventListener('input', updateCalcs);
    productSelect?.addEventListener('change', updateCalcs);
    customerSelectForCalc?.addEventListener('change', updateCalcs); // v69: Recalc when customer changes

    // ==================== FREIGHT MARGIN CALCULATION ====================
    function calculateFreightMargin() {
      const cost = parseFloat(document.getElementById('ticket-freight-cost')?.value) || 0;
      const charge = parseFloat(document.getElementById('ticket-freight-charge')?.value) || 0;
      const margin = charge - cost;
      const marginField = document.getElementById('ticket-freight-margin');
      if (marginField) {
        marginField.value = margin.toFixed(2);
        marginField.classList.toggle('text-green-700', margin >= 0);
        marginField.classList.toggle('text-red-600', margin < 0);
        marginField.classList.toggle('bg-green-50', margin >= 0);
        marginField.classList.toggle('bg-red-50', margin < 0);
      }
    }
    
    function calculateEditFreightMargin() {
      const cost = parseFloat(document.getElementById('edit-ticket-freight-cost')?.value) || 0;
      const charge = parseFloat(document.getElementById('edit-ticket-freight-charge')?.value) || 0;
      const margin = charge - cost;
      const marginField = document.getElementById('edit-ticket-freight-margin');
      if (marginField) {
        marginField.value = margin.toFixed(2);
        marginField.classList.toggle('text-green-700', margin >= 0);
        marginField.classList.toggle('text-red-600', margin < 0);
        marginField.classList.toggle('bg-green-50', margin >= 0);
        marginField.classList.toggle('bg-red-50', margin < 0);
      }
    }

    document.getElementById('ticket-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // Show loading state
      const submitBtn = document.getElementById('submit-ticket-btn');
      const submitText = document.getElementById('submit-text');
      const submitSpinner = document.getElementById('submit-spinner');
      submitBtn.disabled = true;
      submitText.textContent = 'Creating...';
      submitSpinner?.classList.remove('hidden');
      
      try {
        // Get selected options with their Airtable IDs
        const customerSelect = document.getElementById('ticket-customer');
        const carrierSelect = document.getElementById('ticket-carrier');
        const truckInput = document.getElementById('ticket-truck');
        const productSelect = document.getElementById('ticket-product');
        
        // Get customer's default note
        const customerId = customerSelect.selectedOptions[0]?.dataset.airtableid;
        const customer = CUSTOMERS.find(c => (c.airtableId || c.id) === customerId);
        const customerDefaultNote = customer?.defaultNote || '';
        
        // Calculate weights
        const gross = parseInt(document.getElementById('ticket-gross').value) || 0;
        const tare = parseInt(document.getElementById('ticket-tare').value) || 0;
        const netLbs = gross - tare;
        const netTons = netLbs / 2000;
        
        // Get product for yard calculation
        const productOption = productSelect.selectedOptions[0];
        const lbsPerYard = parseFloat(productOption?.dataset.lbs) || 2700;
        const netYards = netLbs / lbsPerYard;
        
        // Calculate freight totals based on customer settings
        // IMPORTANT: Freight Charge (customer billing) and Freight Cost (truck payment) can use DIFFERENT methods
        // e.g., Charge customer per yard, pay truck per ton
        let freightCostTotal = 0;
        let freightChargeTotal = 0;
        
        // v71: Normalize freight method to handle both 'per_ton' and 'Per Ton' formats
        const normalizeMethod = (m) => (m || '').toLowerCase().replace(/\s+/g, '_').replace('per_', '');
        const isPerTon = (m) => normalizeMethod(m) === 'ton';
        const isPerYard = (m) => normalizeMethod(m) === 'yard';
        const isFlat = (m) => normalizeMethod(m) === 'flat' || normalizeMethod(m) === 'fee';
        const isDelivered = (m) => normalizeMethod(m) === 'delivered';
        
        if (customer && customer.freightMethod && !isDelivered(customer.freightMethod)) {
          const freightCostPerUnit = parseFloat(customer.freightCost) || 0;
          const freightRatePerUnit = parseFloat(customer.freightRate) || 0;
          
          // Calculate CHARGE (what customer pays) using freightMethod
          if (isPerTon(customer.freightMethod)) {
            freightChargeTotal = freightRatePerUnit * netTons;
          } else if (isPerYard(customer.freightMethod)) {
            freightChargeTotal = freightRatePerUnit * netYards;
          } else if (isFlat(customer.freightMethod)) {
            freightChargeTotal = freightRatePerUnit;
          }
          
          // Calculate COST (what we pay truck) using freightCostMethod (falls back to freightMethod if not set)
          const costMethod = customer.freightCostMethod || customer.freightMethod;
          if (isPerTon(costMethod)) {
            freightCostTotal = freightCostPerUnit * netTons;
          } else if (isPerYard(costMethod)) {
            freightCostTotal = freightCostPerUnit * netYards;
          } else if (isFlat(costMethod)) {
            freightCostTotal = freightCostPerUnit;
          }
          
          console.log(`Freight calculated: ChargeMethod=${customer.freightMethod}, CostMethod=${costMethod}, Tons=${netTons.toFixed(2)}, Yards=${netYards.toFixed(2)}, Cost=$${freightCostTotal.toFixed(2)}, Charge=$${freightChargeTotal.toFixed(2)}`);
        }
        
        // Allow manual override from freight fields if user entered values
        // Fields are empty by default, so any value means user entered it
        const manualCost = parseFloat(document.getElementById('ticket-freight-cost')?.value) || 0;
        const manualCharge = parseFloat(document.getElementById('ticket-freight-charge')?.value) || 0;
        
        if (manualCharge > 0) {
          freightChargeTotal = manualCharge;
          console.log(`Using manual freight charge: $${manualCharge}`);
        }
        if (manualCost > 0) {
          freightCostTotal = manualCost;
          console.log(`Using manual freight cost: $${manualCost}`);
        }
        
        // v2.1: Calculate Pumice Charge (product charge) based on customer pricing
        // This ensures customer-specific pricing is used instead of relying on Airtable formulas
        let pumiceCharge = 0;
        let pricePerUnit = 0;
        let pricingMethod = '';
        
        if (customer) {
          pricingMethod = (customer.pricingMethod || '').toLowerCase();
          const billByTon = pricingMethod.includes('ton');
          
          if (billByTon && customer.priceTon) {
            pricePerUnit = parseFloat(customer.priceTon) || 0;
            pumiceCharge = netTons * pricePerUnit;
            console.log(`Pumice Charge (Per Ton): ${netTons.toFixed(2)} tons √ó $${pricePerUnit}/ton = $${pumiceCharge.toFixed(2)}`);
          } else if (customer.priceYard) {
            pricePerUnit = parseFloat(customer.priceYard) || 0;
            pumiceCharge = netYards * pricePerUnit;
            console.log(`Pumice Charge (Per Yard): ${netYards.toFixed(2)} yards √ó $${pricePerUnit}/yard = $${pumiceCharge.toFixed(2)}`);
          } else {
            // Fallback to $13/yard default if no customer pricing set
            pricePerUnit = 13;
            pumiceCharge = netYards * pricePerUnit;
            console.warn(`‚ö†Ô∏è No customer pricing found, using default: ${netYards.toFixed(2)} yards √ó $13/yard = $${pumiceCharge.toFixed(2)}`);
          }
        } else {
          // No customer selected - use default
          pricePerUnit = 13;
          pumiceCharge = netYards * pricePerUnit;
          console.warn(`‚ö†Ô∏è No customer selected, using default: $${pumiceCharge.toFixed(2)}`);
        }
        
        // Round to 2 decimal places
        pumiceCharge = Math.round(pumiceCharge * 100) / 100;
        
        const ticketData = {
          customerId: customerSelect.selectedOptions[0]?.dataset.airtableid || customerSelect.value,
          carrierId: carrierSelect.selectedOptions[0]?.dataset.airtableid || carrierSelect.value,
          truck: truckInput.value.trim(), // Truck is now a text field
          productId: productSelect.selectedOptions[0]?.dataset.airtableid || productSelect.value,
          gross: gross,
          tare: tare,
          po: document.getElementById('ticket-po').value || '',
          note: document.getElementById('ticket-note').value || '',
          customerNote: customerDefaultNote, // Customer's default note
          freightCost: freightCostTotal,
          freightCharge: freightChargeTotal,
          // v2.1: Send calculated pricing to Airtable instead of relying on formulas
          pumiceCharge: pumiceCharge,
          pricePerUnit: pricePerUnit,
          pricingMethod: customer?.pricingMethod || 'Per Yard'
        };
        
        // Call API to create ticket in Airtable
        const response = await fetch('/api/tickets/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(ticketData)
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to create ticket');
        }
        
        const result = await response.json();

        // v2.2-HOTFIX: Use complete ticket data from API response
        // API now returns the full ticket with calculated values from Airtable
        // This prevents intermittent print issues where values were different
        const newTicket = result.ticket || {
          // Fallback to constructed ticket if API doesn't return full data (old version)
          id: result.id,
          airtableId: result.id,
          number: result.ticketNumber || (tickets.length > 0 ? Math.max(...tickets.map(t => t.number)) + 1 : 4744),
          customer: customerSelect.selectedOptions[0]?.text || '',
          customerId: ticketData.customerId,
          carrier: carrierSelect.selectedOptions[0]?.text || '',
          carrierId: ticketData.carrierId,
          truck: truckInput.value.trim(),
          product: productSelect.selectedOptions[0]?.text || '',
          productId: ticketData.productId,
          gross: ticketData.gross,
          tare: ticketData.tare,
          po: ticketData.po,
          note: ticketData.note,
          customerNote: ticketData.customerNote,
          freightCost: ticketData.freightCost,
          freightCharge: ticketData.freightCharge,
          freightMargin: ticketData.freightCharge - ticketData.freightCost,
          date: new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }),
          printUrl: result.printUrl
        };

        tickets.unshift(newTicket);
        lastCreatedTicket = newTicket;

        console.log('‚úÖ Ticket created with verified values from Airtable:', {
          number: newTicket.number,
          netTons: newTicket.netTons,
          netYards: newTicket.netYards,
          pumiceCharge: newTicket.pumiceCharge,
          freightCharge: newTicket.freightCharge
        });
        
        // Try to send email notification (non-blocking)
        // v70: Use email OR contactEmail - whichever has a value
        // v2.2-HOTFIX: Don't send emails for voided tickets
        try {
          const customer = CUSTOMERS.find(c =>
            c.airtableId === ticketData.customerId || c.id === ticketData.customerId
          );
          const customerEmail = customer?.contactEmail || customer?.email || customer?.billToEmail;
          const ticketStatus = newTicket.status || 'Open';

          // Don't send email if ticket is voided
          if (ticketStatus === 'Void') {
            console.log('Email not sent: Ticket is voided');
          } else if (customer && customer.emailReceipts && customerEmail) {
            console.log('Sending ticket email to:', customerEmail);
            sendTicketEmail(newTicket.id, newTicket, customer, customerEmail).then(result => {
              if (result.sent) {
                console.log('Email sent successfully');
              } else {
                console.log('Email not sent:', result.reason);
              }
            }).catch(err => console.error('Email error:', err));
          } else {
            console.log('Email not sent:', !customer ? 'no customer' : !customer.emailReceipts ? 'Email Receipts not enabled' : 'no email address');
          }
        } catch (emailError) {
          console.error('Email setup error (non-fatal):', emailError);
        }
        
        updateStats();
        renderRecentActivity();
        renderTicketsTable();
        
        document.getElementById('new-ticket-number').textContent = newTicket.number;
        document.getElementById('success-banner').classList.remove('hidden');
        
        this.reset();
        document.getElementById('calculations').classList.add('hidden');
        document.getElementById('customer-default-note-container').classList.add('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
      } catch (error) {
        console.error('Error creating ticket:', error);
        
        // Show more detailed error info
        let errorMsg = error.message || 'Unknown error';
        if (error.message.includes('Failed to fetch')) {
          errorMsg = 'Network error - check internet connection';
        } else if (error.message.includes('Airtable')) {
          errorMsg = error.message; // Show Airtable-specific error
        }
        
        showToast('Failed to create ticket: ' + errorMsg, 'error');
        
        // Log to console for debugging
        console.error('Full error details:', {
          message: error.message,
          stack: error.stack
        });
      } finally {
        // Reset button state
        submitBtn.disabled = false;
        submitText.textContent = '‚úì CREATE TICKET';
        submitSpinner?.classList.add('hidden');
      }
    });

    function refreshData() {
      renderTicketsTable();
      renderRecentActivity();
      updateStats();
    }

    // ==================== API DATA LOADING ====================
    async function loadCarriersFromAirtable(showFeedback = false) {
      try {
        const response = await fetch('/api/carriers');
        if (!response.ok) throw new Error('Failed to fetch carriers');
        
        const data = await response.json();
        if (data.success && data.carriers) {
          CARRIERS = data.carriers;
          console.log(`Loaded ${CARRIERS.length} carriers from Airtable`);
          
          if (currentUser) {
            populateDropdowns();
            renderCarriersAndTrucks();
          }
          
          if (showFeedback) {
            showToast(`Loaded ${CARRIERS.length} carriers from Airtable`);
          }
          return true;
        }
        return false;
      } catch (error) {
        console.error('Error loading carriers:', error);
        if (showFeedback) {
          showToast('Failed to load carriers: ' + error.message, 'error');
        }
        return false;
      }
    }

    async function loadTrucksFromAirtable(showFeedback = false) {
      try {
        const response = await fetch('/api/trucks');
        if (!response.ok) throw new Error('Failed to fetch trucks');
        
        const data = await response.json();
        if (data.success && data.trucks) {
          TRUCKS = data.trucks.map(t => ({
            ...t,
            id: t.airtableId || t.id
          }));
          console.log(`Loaded ${TRUCKS.length} trucks from Airtable`);
          
          if (currentUser) {
            populateDropdowns();
            renderCarriersAndTrucks();
          }
          
          if (showFeedback) {
            showToast(`Loaded ${TRUCKS.length} trucks from Airtable`);
          }
          return true;
        }
        return false;
      } catch (error) {
        console.error('Error loading trucks:', error);
        if (showFeedback) {
          showToast('Failed to load trucks: ' + error.message, 'error');
        }
        return false;
      }
    }

    async function loadTicketsFromAirtable(showFeedback = false) {
      try {
        const response = await fetch('/api/tickets');
        if (!response.ok) throw new Error('Failed to fetch tickets');
        
        const data = await response.json();
        if (data.success && data.tickets) {
          tickets = data.tickets.map(t => ({
            ...t,
            id: t.airtableId || t.id
          }));
          console.log(`Loaded ${tickets.length} tickets from Airtable`);
          
          if (currentUser) {
            renderTicketsTable();
            renderRecentActivity();
            updateStats();
          }
          
          if (showFeedback) {
            showToast(`Loaded ${tickets.length} tickets from Airtable`);
          }
          return true;
        }
        return false;
      } catch (error) {
        console.error('Error loading tickets:', error);
        if (showFeedback) {
          showToast('Failed to load tickets: ' + error.message, 'error');
        }
        return false;
      }
    }

    // Update add-truck form to call API
    document.getElementById('add-truck-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      
      // Get carrier ID from selected option
      const carrierSelect = document.getElementById('add-truck-carrier');
      const selectedCarrier = CARRIERS.find(c => c.name === formData.get('truckCarrier'));
      
      const truckData = {
        truckId: formData.get('truckId').trim(),
        carrierId: selectedCarrier?.airtableId || selectedCarrier?.id || ''
      };
      
      try {
        const response = await fetch('/api/trucks/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(truckData)
        });
        
        if (!response.ok) throw new Error('Failed to add truck');
        
        const result = await response.json();
        
        // Add to local array
        const newTruck = {
          id: result.id,
          airtableId: result.id,
          truckId: truckData.truckId,
          carrier: formData.get('truckCarrier') || '',
          carrierId: truckData.carrierId
        };
        
        TRUCKS.push(newTruck);
        closeModal('add-truck-modal');
        populateDropdowns();
        renderCarriersAndTrucks();
        showToast(`Truck "${newTruck.truckId}" added successfully!`);
        
      } catch (error) {
        console.error('Error adding truck:', error);
        showToast('Failed to add truck: ' + error.message, 'error');
      }
    });

    // ==================== INIT ====================
    async function init() {
      // Load users from localStorage
      loadUsersFromStorage();
      updateLoginDropdown();
      
      // Try to load customers from Airtable
      const success = await loadCustomersFromAirtable();
      
      // Try to load products from Airtable (optional - falls back to defaults)
      await loadProductsFromAirtable();
      
      // Load carriers and trucks from Airtable
      await loadCarriersFromAirtable();
      await loadTrucksFromAirtable();
      
      // Load tickets from Airtable
      await loadTicketsFromAirtable();
      
      // Hide loading screen
      document.getElementById('loading-screen').classList.add('hidden');
      
      // Show login screen
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('login-screen').classList.add('flex');
      
      if (!success) {
        console.warn('Could not load customers from Airtable. Using offline mode.');
        // Add some demo customers for offline mode
        CUSTOMERS = [
          { id: 'demo1', name: '4 Corners Organics', email: 'organics4corners@hotmail.com', phone: '360-431-3231', city: 'Castle Rock', state: 'WA', priceYard: 13.00 },
          { id: 'demo2', name: 'Agra Marketing', email: 'ap@AgraMarketing.com', phone: '503-521-9155', city: 'Tracy', state: 'CA', priceYard: 13.00 },
          { id: 'demo3', name: 'Aurora Innovations', email: 'brent@beaverpumice.com', phone: '', city: 'Eugene', state: 'OR' },
        ];
      }
    }

    // ==================== PHASE 2: REPORTS & QUICKBOOKS EXPORT ====================
    
    // Reports state
    let reportData = null;
    let selectedTicketsForExport = new Set();
    let reportFilters = {
      startDate: null,
      endDate: null,
      customerId: null,
      carrierId: null,
      productId: null,
      status: null
    };

    async function loadReportData() {
      const params = new URLSearchParams();
      
      if (reportFilters.startDate) params.append('startDate', reportFilters.startDate);
      if (reportFilters.endDate) params.append('endDate', reportFilters.endDate);
      if (reportFilters.customerId) params.append('customerId', reportFilters.customerId);
      if (reportFilters.carrierId) params.append('carrierId', reportFilters.carrierId);
      if (reportFilters.productId) params.append('productId', reportFilters.productId);
      if (reportFilters.status) params.append('status', reportFilters.status);
      
      try {
        const response = await fetch(`/api/reports/tickets?${params.toString()}`);
        if (!response.ok) throw new Error('Failed to load report data');
        
        reportData = await response.json();
        return reportData;
      } catch (error) {
        console.error('Error loading report data:', error);
        showToast('Failed to load report data', 'error');
        return null;
      }
    }

    function setReportDateRange(range) {
      const today = new Date();
      let start, end;
      
      switch (range) {
        case 'today':
          start = end = today.toISOString().split('T')[0];
          break;
        case 'yesterday':
          const yesterday = new Date(today);
          yesterday.setDate(yesterday.getDate() - 1);
          start = end = yesterday.toISOString().split('T')[0];
          break;
        case 'thisWeek':
          const weekStart = new Date(today);
          weekStart.setDate(today.getDate() - today.getDay());
          start = weekStart.toISOString().split('T')[0];
          end = today.toISOString().split('T')[0];
          break;
        case 'lastWeek':
          const lastWeekEnd = new Date(today);
          lastWeekEnd.setDate(today.getDate() - today.getDay() - 1);
          const lastWeekStart = new Date(lastWeekEnd);
          lastWeekStart.setDate(lastWeekEnd.getDate() - 6);
          start = lastWeekStart.toISOString().split('T')[0];
          end = lastWeekEnd.toISOString().split('T')[0];
          break;
        case 'thisMonth':
          start = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
          end = today.toISOString().split('T')[0];
          break;
        case 'lastMonth':
          const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
          const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
          start = lastMonth.toISOString().split('T')[0];
          end = lastMonthEnd.toISOString().split('T')[0];
          break;
        case 'thisYear':
          start = new Date(today.getFullYear(), 0, 1).toISOString().split('T')[0];
          end = today.toISOString().split('T')[0];
          break;
        case 'custom':
          return;
        default:
          start = null;
          end = null;
      }
      
      reportFilters.startDate = start;
      reportFilters.endDate = end;
      
      document.getElementById('report-start-date').value = start || '';
      document.getElementById('report-end-date').value = end || '';
    }

    async function applyReportFilters() {
      reportFilters.startDate = document.getElementById('report-start-date').value || null;
      reportFilters.endDate = document.getElementById('report-end-date').value || null;
      reportFilters.customerId = document.getElementById('report-customer-filter').value || null;
      reportFilters.carrierId = document.getElementById('report-carrier-filter').value || null;
      reportFilters.productId = document.getElementById('report-product-filter').value || null;
      reportFilters.status = document.getElementById('report-status-filter').value || null;
      
      document.getElementById('report-loading').classList.remove('hidden');
      document.getElementById('report-results').classList.add('hidden');
      
      await loadReportData();
      renderCurrentReport();
      
      document.getElementById('report-loading').classList.add('hidden');
      document.getElementById('report-results').classList.remove('hidden');
    }

    function clearReportFilters() {
      reportFilters = { startDate: null, endDate: null, customerId: null, carrierId: null, productId: null, status: null };
      
      document.getElementById('report-start-date').value = '';
      document.getElementById('report-end-date').value = '';
      document.getElementById('report-customer-filter').value = '';
      document.getElementById('report-carrier-filter').value = '';
      document.getElementById('report-product-filter').value = '';
      document.getElementById('report-status-filter').value = '';
      document.getElementById('report-date-range').value = 'all';
      
      applyReportFilters();
    }

    function renderCurrentReport() {
      const reportType = document.getElementById('report-type-select').value;
      
      switch (reportType) {
        case 'customer-activity': renderCustomerActivityReport(); break;
        case 'sales-by-product': renderSalesByProductReport(); break;
        case 'carrier-summary': renderCarrierSummaryReport(); break;
        default: renderTicketDetailReport(); break;
      }
    }

    function renderTicketDetailReport() {
      if (!reportData) return;
      
      const container = document.getElementById('report-content');
      const summary = reportData.summary;
      const rptTickets = reportData.tickets;
      
      container.innerHTML = `
        <div class="mb-6">
          <h3 class="text-lg font-bold text-slate-900 mb-4">Ticket Detail Report</h3>
          <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <div class="bg-gold-50 rounded-xl p-4 border border-gold-200">
              <p class="text-sm text-gold-700 font-medium">Total Tickets</p>
              <p class="text-2xl font-bold text-gold-900">${summary.totalTickets.toLocaleString()}</p>
            </div>
            <div class="bg-emerald-50 rounded-xl p-4 border border-emerald-200">
              <p class="text-sm text-emerald-700 font-medium">Total Tons</p>
              <p class="text-2xl font-bold text-emerald-900">${summary.totalTons.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
            </div>
            <div class="bg-blue-50 rounded-xl p-4 border border-blue-200">
              <p class="text-sm text-blue-700 font-medium">Total Yards</p>
              <p class="text-2xl font-bold text-blue-900">${summary.totalYards.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
            </div>
            <div class="bg-green-50 rounded-xl p-4 border border-green-200 amount-column">
              <p class="text-sm text-green-700 font-medium">Total $ Amount</p>
              <p class="text-2xl font-bold text-green-900">$${(() => {
                let total = 0;
                rptTickets.forEach(t => {
                  // v69: Use calcAmount for correct per-ton vs per-yard billing
                  total += calcAmount(t);
                });
                return total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
              })()}</p>
            </div>
            <div class="bg-purple-50 rounded-xl p-4 border border-purple-200">
              <p class="text-sm text-purple-700 font-medium">Net Weight</p>
              <p class="text-2xl font-bold text-purple-900">${summary.totalNetLbs.toLocaleString()} lbs</p>
            </div>
          </div>
        </div>
        
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="bg-slate-100 text-left">
                <th class="px-3 py-2 font-semibold text-slate-700">
                  <input type="checkbox" id="select-all-tickets" onchange="toggleAllTicketSelection(this.checked)" class="rounded">
                </th>
                <th class="px-3 py-2 font-semibold text-slate-700">Ticket #</th>
                <th class="px-3 py-2 font-semibold text-slate-700">Date</th>
                <th class="px-3 py-2 font-semibold text-slate-700">Customer</th>
                <th class="px-3 py-2 font-semibold text-slate-700">Carrier</th>
                <th class="px-3 py-2 font-semibold text-slate-700">Product</th>
                <th class="px-3 py-2 font-semibold text-slate-700 text-right">Tons</th>
                <th class="px-3 py-2 font-semibold text-slate-700 text-right">Yards</th>
                <th class="px-3 py-2 font-semibold text-slate-700 text-right amount-column">$ Amount</th>
                <th class="px-3 py-2 font-semibold text-slate-700">Status</th>
              </tr>
            </thead>
            <tbody>
              ${rptTickets.map(t => {
                // v69: Use calcAmount for correct per-ton vs per-yard billing
                const amount = calcAmount(t).toFixed(2);
                return `
                <tr class="border-b border-slate-100 hover:bg-slate-50">
                  <td class="px-3 py-2">
                    <input type="checkbox" class="ticket-checkbox rounded" value="${t.id}" 
                           ${selectedTicketsForExport.has(t.id) ? 'checked' : ''}
                           onchange="toggleTicketSelection('${t.id}', this.checked)">
                  </td>
                  <td class="px-3 py-2 font-mono font-semibold text-gold-700">${t.number}</td>
                  <td class="px-3 py-2 text-slate-600">${formatReportDate(t.date)}</td>
                  <td class="px-3 py-2 font-medium">${escapeHtmlReport(t.customer)}</td>
                  <td class="px-3 py-2 text-slate-600">${escapeHtmlReport(t.carrier)}</td>
                  <td class="px-3 py-2">${escapeHtmlReport(t.product)}</td>
                  <td class="px-3 py-2 text-right font-mono">${t.netTons.toFixed(2)}</td>
                  <td class="px-3 py-2 text-right font-mono">${t.netYards.toFixed(2)}</td>
                  <td class="px-3 py-2 text-right font-mono font-bold text-emerald-600 amount-column">$${parseFloat(amount).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                  <td class="px-3 py-2">
                    <span class="px-2 py-1 rounded-full text-xs font-medium ${getReportStatusClass(t.status === 'Closed' && t.exportedToQB ? 'Exported' : t.status)}">${t.status === 'Closed' && t.exportedToQB ? 'Exported' : t.status}</span>
                  </td>
                </tr>
              `}).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      updateExportButtonState();
    }

    function renderCustomerActivityReport() {
      if (!reportData) return;
      
      const container = document.getElementById('report-content');
      const byCustomer = reportData.byCustomer;
      const customers = Object.entries(byCustomer).sort((a, b) => b[1].totalTons - a[1].totalTons);
      
      container.innerHTML = `
        <div class="mb-6">
          <h3 class="text-lg font-bold text-slate-900 mb-4">Customer Activity Report</h3>
        </div>
        
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="bg-slate-100 text-left">
                <th class="px-4 py-3 font-semibold text-slate-700">Customer</th>
                <th class="px-4 py-3 font-semibold text-slate-700 text-right">Loads</th>
                <th class="px-4 py-3 font-semibold text-slate-700 text-right">Total Tons</th>
                <th class="px-4 py-3 font-semibold text-slate-700 text-right">Total Yards</th>
                <th class="px-4 py-3 font-semibold text-slate-700 text-right amount-column">$ Amount</th>
                <th class="px-4 py-3 font-semibold text-slate-700 text-right">Avg Tons/Load</th>
              </tr>
            </thead>
            <tbody>
              ${customers.map(([name, data]) => {
                const customer = CUSTOMERS.find(c => c.name === name);
                // v69: Check pricing method - use tons or yards accordingly
                const method = (customer?.pricingMethod || '').toLowerCase();
                const billByTon = method.includes('ton') || (customer?.priceTon && !customer?.priceYard);
                let amount;
                if (billByTon && customer?.priceTon) {
                  amount = (data.totalTons * customer.priceTon).toFixed(2);
                } else {
                  const priceYard = customer?.priceYard || 13;
                  amount = (data.totalYards * priceYard).toFixed(2);
                }
                return `
                <tr class="border-b border-slate-100 hover:bg-slate-50">
                  <td class="px-4 py-3 font-medium">${escapeHtmlReport(name)}</td>
                  <td class="px-4 py-3 text-right font-mono">${data.ticketCount}</td>
                  <td class="px-4 py-3 text-right font-mono font-semibold text-emerald-700">${data.totalTons.toFixed(2)}</td>
                  <td class="px-4 py-3 text-right font-mono text-blue-700">${data.totalYards.toFixed(2)}</td>
                  <td class="px-4 py-3 text-right font-mono font-bold text-emerald-600 amount-column">$${parseFloat(amount).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                  <td class="px-4 py-3 text-right font-mono text-slate-600">${(data.totalTons / data.ticketCount).toFixed(2)}</td>
                </tr>
              `}).join('')}
            </tbody>
            <tfoot>
              ${(() => {
                // v69: Calculate total $ amount using correct pricing method per customer
                let totalAmount = 0;
                customers.forEach(([name, data]) => {
                  const customer = CUSTOMERS.find(c => c.name === name);
                  const method = (customer?.pricingMethod || '').toLowerCase();
                  const billByTon = method.includes('ton') || (customer?.priceTon && !customer?.priceYard);
                  if (billByTon && customer?.priceTon) {
                    totalAmount += data.totalTons * customer.priceTon;
                  } else {
                    const priceYard = customer?.priceYard || 13;
                    totalAmount += data.totalYards * priceYard;
                  }
                });
                return `
              <tr class="bg-slate-50 font-semibold">
                <td class="px-4 py-3">TOTAL</td>
                <td class="px-4 py-3 text-right font-mono">${reportData.summary.totalTickets}</td>
                <td class="px-4 py-3 text-right font-mono text-emerald-700">${reportData.summary.totalTons.toFixed(2)}</td>
                <td class="px-4 py-3 text-right font-mono text-blue-700">${reportData.summary.totalYards.toFixed(2)}</td>
                <td class="px-4 py-3 text-right font-mono font-bold text-emerald-600 amount-column">$${totalAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                <td class="px-4 py-3 text-right font-mono text-slate-600">${(reportData.summary.totalTons / reportData.summary.totalTickets).toFixed(2)}</td>
              </tr>
              `;
              })()}
            </tfoot>
          </table>
        </div>
      `;
    }

    function renderSalesByProductReport() {
      if (!reportData) return;
      
      const container = document.getElementById('report-content');
      const byProduct = reportData.byProduct;
      const products = Object.entries(byProduct).sort((a, b) => b[1].totalTons - a[1].totalTons);
      
      container.innerHTML = `
        <div class="mb-6">
          <h3 class="text-lg font-bold text-slate-900 mb-4">Sales by Product Report</h3>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
          ${products.map(([name, data]) => `
            <div class="bg-white border border-slate-200 rounded-xl p-4 hover:shadow-md transition-shadow">
              <h4 class="font-semibold text-slate-900 mb-2">${escapeHtmlReport(name)}</h4>
              <div class="grid grid-cols-3 gap-2 text-sm">
                <div>
                  <p class="text-slate-500">Loads</p>
                  <p class="font-mono font-semibold">${data.ticketCount}</p>
                </div>
                <div>
                  <p class="text-slate-500">Tons</p>
                  <p class="font-mono font-semibold text-emerald-700">${data.totalTons.toFixed(1)}</p>
                </div>
                <div>
                  <p class="text-slate-500">Yards</p>
                  <p class="font-mono font-semibold text-blue-700">${data.totalYards.toFixed(1)}</p>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderCarrierSummaryReport() {
      if (!reportData) return;
      
      const container = document.getElementById('report-content');
      const byCarrier = reportData.byCarrier;
      const carriers = Object.entries(byCarrier).sort((a, b) => b[1].totalTons - a[1].totalTons);
      
      container.innerHTML = `
        <div class="mb-6">
          <h3 class="text-lg font-bold text-slate-900 mb-4">Carrier Summary Report</h3>
        </div>
        
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="bg-slate-100 text-left">
                <th class="px-4 py-3 font-semibold text-slate-700">Carrier</th>
                <th class="px-4 py-3 font-semibold text-slate-700 text-right">Loads</th>
                <th class="px-4 py-3 font-semibold text-slate-700 text-right">Total Tons</th>
                <th class="px-4 py-3 font-semibold text-slate-700 text-right">Total Yards</th>
                <th class="px-4 py-3 font-semibold text-slate-700 text-right">% of Volume</th>
              </tr>
            </thead>
            <tbody>
              ${carriers.map(([name, data]) => `
                <tr class="border-b border-slate-100 hover:bg-slate-50">
                  <td class="px-4 py-3 font-medium">${escapeHtmlReport(name)}</td>
                  <td class="px-4 py-3 text-right font-mono">${data.ticketCount}</td>
                  <td class="px-4 py-3 text-right font-mono font-semibold text-emerald-700">${data.totalTons.toFixed(2)}</td>
                  <td class="px-4 py-3 text-right font-mono text-blue-700">${data.totalYards.toFixed(2)}</td>
                  <td class="px-4 py-3 text-right font-mono text-slate-600">${((data.totalTons / reportData.summary.totalTons) * 100).toFixed(1)}%</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    // Ticket selection for export
    function toggleTicketSelection(ticketId, selected) {
      if (selected) {
        selectedTicketsForExport.add(ticketId);
      } else {
        selectedTicketsForExport.delete(ticketId);
      }
      updateExportButtonState();
    }

    function toggleAllTicketSelection(selected) {
      if (!reportData) return;
      
      if (selected) {
        reportData.tickets.forEach(t => selectedTicketsForExport.add(t.id));
      } else {
        selectedTicketsForExport.clear();
      }
      
      document.querySelectorAll('.ticket-checkbox').forEach(cb => { cb.checked = selected; });
      updateExportButtonState();
    }

    function updateExportButtonState() {
      const count = selectedTicketsForExport.size;
      const btn = document.getElementById('export-qb-btn');
      const countEl = document.getElementById('selected-count');
      
      if (btn) {
        btn.disabled = count === 0;
        btn.classList.toggle('opacity-50', count === 0);
        btn.classList.toggle('cursor-not-allowed', count === 0);
      }
      
      if (countEl) {
        countEl.textContent = count > 0 ? `(${count} selected)` : '';
      }
    }

    // QuickBooks IIF Export
    function openQuickBooksExportModal() {
      if (selectedTicketsForExport.size === 0) {
        showToast('Please select tickets to export', 'error');
        return;
      }
      
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('qb-invoice-date').value = today;
      document.getElementById('qb-starting-invoice').value = '10';
      document.getElementById('qb-group-by-customer').checked = true;
      document.getElementById('qb-mark-exported').checked = true;
      document.getElementById('qb-export-count').textContent = selectedTicketsForExport.size;
      
      openModal('quickbooks-export-modal');
    }

    async function executeQuickBooksExport() {
      const invoiceDate = document.getElementById('qb-invoice-date').value;
      const startingNum = document.getElementById('qb-starting-invoice').value;
      const groupByCustomer = document.getElementById('qb-group-by-customer').checked;
      const markExported = document.getElementById('qb-mark-exported').checked;
      
      if (!invoiceDate) {
        showToast('Please select an invoice date', 'error');
        return;
      }
      
      const btn = document.getElementById('qb-export-btn');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner mr-2"></span> Generating...';
      
      try {
        const dateParts = invoiceDate.split('-');
        const iifDate = `${dateParts[1]}/${dateParts[2]}/${dateParts[0]}`;
        
        const response = await fetch('/api/export/iif', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ticketIds: Array.from(selectedTicketsForExport),
            invoiceDate: iifDate,
            groupByCustomer,
            startingInvoiceNum: parseInt(startingNum)
          })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Export failed');
        }
        
        const iifContent = await response.text();
        const blob = new Blob([iifContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `invoices_${invoiceDate}.iif`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        if (markExported) {
          await fetch('/api/tickets/mark-exported', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              ticketIds: Array.from(selectedTicketsForExport),
              exportDate: new Date().toISOString()
            })
          });
          
          // Update local tickets array to show Exported status immediately
          const exportedIds = new Set(selectedTicketsForExport);
          tickets.forEach(t => {
            if (exportedIds.has(t.id)) {
              t.exportedToQB = true;
            }
          });
          // Refresh the main tickets table to show "Exported" badge
          renderTicketsTable();
          renderRecentActivity();
        }
        
        showToast(`Exported ${selectedTicketsForExport.size} tickets to QuickBooks IIF!`);
        closeModal('quickbooks-export-modal');
        
        selectedTicketsForExport.clear();
        await applyReportFilters();
        
      } catch (error) {
        console.error('Export error:', error);
        showToast(error.message || 'Export failed', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    // PDF Export
    async function exportReportToPDF() {
      if (typeof html2pdf === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
        script.onload = () => generatePDF();
        document.head.appendChild(script);
      } else {
        generatePDF();
      }
    }

    function generatePDF() {
      const reportContent = document.getElementById('report-content');
      const reportType = document.getElementById('report-type-select');
      const reportName = reportType.options[reportType.selectedIndex].text;
      
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `
        <div style="padding: 20px; font-family: Arial, sans-serif;">
          <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #b8860b; padding-bottom: 15px;">
            <h1 style="color: #1a1a2e; margin: 0;">Beaver Pumice</h1>
            <p style="color: #666; margin: 5px 0;">92777 HWY 97 N, Chemult, Oregon 97731</p>
            <h2 style="color: #b8860b; margin: 15px 0 0;">${reportName}</h2>
            <p style="color: #666; font-size: 12px;">
              ${reportFilters.startDate ? `From: ${reportFilters.startDate}` : 'All Time'}
              ${reportFilters.endDate ? ` To: ${reportFilters.endDate}` : ''}
            </p>
            <p style="color: #999; font-size: 11px;">Generated: ${new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' })}</p>
          </div>
          ${reportContent.innerHTML}
        </div>
      `;
      
      wrapper.querySelectorAll('input[type="checkbox"]').forEach(el => el.remove());
      
      html2pdf().set({
        margin: 0.5,
        filename: `beaver_pumice_${reportType.value}_${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
      }).from(wrapper).save();
      
      showToast('PDF exported successfully!');
    }

    // Excel Export
    async function exportReportToExcel() {
      if (typeof XLSX === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
        script.onload = () => generateExcel();
        document.head.appendChild(script);
      } else {
        generateExcel();
      }
    }

    function generateExcel() {
      if (!reportData) return;
      
      const reportType = document.getElementById('report-type-select').value;
      let data = [];
      let filename = 'report';
      
      switch (reportType) {
        case 'customer-activity':
          data = Object.entries(reportData.byCustomer).map(([name, d]) => ({
            'Customer': name, 'Loads': d.ticketCount, 'Total Tons': d.totalTons, 'Total Yards': d.totalYards, 'Avg Tons/Load': d.totalTons / d.ticketCount
          }));
          filename = 'customer_activity';
          break;
        case 'sales-by-product':
          data = Object.entries(reportData.byProduct).map(([name, d]) => ({
            'Product': name, 'Loads': d.ticketCount, 'Total Tons': d.totalTons, 'Total Yards': d.totalYards, '% of Total': (d.totalTons / reportData.summary.totalTons * 100).toFixed(1) + '%'
          }));
          filename = 'sales_by_product';
          break;
        case 'carrier-summary':
          data = Object.entries(reportData.byCarrier).map(([name, d]) => ({
            'Carrier': name, 'Loads': d.ticketCount, 'Total Tons': d.totalTons, 'Total Yards': d.totalYards, '% of Volume': (d.totalTons / reportData.summary.totalTons * 100).toFixed(1) + '%'
          }));
          filename = 'carrier_summary';
          break;
        default:
          data = reportData.tickets.map(t => ({
            'Ticket #': t.number, 'Date': formatReportDate(t.date), 'Customer': t.customer, 'Carrier': t.carrier, 'Product': t.product, 'Truck': t.truck, 'Tare (lbs)': t.tare, 'Gross (lbs)': t.gross, 'Net (lbs)': t.netLbs, 'Tons': t.netTons, 'Yards': t.netYards, 'PO #': t.po, 'Status': t.status
          }));
          filename = 'ticket_detail';
          break;
      }
      
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Report');
      
      XLSX.writeFile(wb, `beaver_pumice_${filename}_${new Date().toISOString().split('T')[0]}.xlsx`);
      showToast('Excel exported successfully!');
    }

    // Report helper functions
    function formatReportDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      return d.toLocaleDateString('en-US', { timeZone: 'America/Los_Angeles', month: 'short', day: 'numeric', year: 'numeric' });
    }

    function getReportStatusClass(status) {
      switch (status) {
        case 'Closed': return 'bg-emerald-100 text-emerald-700';
        case 'Void': return 'bg-red-100 text-red-700';
        case 'Exported': return 'bg-blue-100 text-blue-700';
        default: return 'bg-gold-100 text-gold-700';
      }
    }

    function escapeHtmlReport(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function initReportsView() {
      populateReportFilters();
      setReportDateRange('thisMonth');
      await applyReportFilters();
      // Initialize the auto-export panel for admins
      await initAutoExportPanel();
    }

    function populateReportFilters() {
      const customerSelect = document.getElementById('report-customer-filter');
      if (customerSelect) {
        customerSelect.innerHTML = '<option value="">All Customers</option>';
        CUSTOMERS.sort((a, b) => a.name.localeCompare(b.name)).forEach(c => {
          customerSelect.innerHTML += `<option value="${c.id}">${escapeHtmlReport(c.name)}</option>`;
        });
      }
      
      const carrierSelect = document.getElementById('report-carrier-filter');
      if (carrierSelect) {
        carrierSelect.innerHTML = '<option value="">All Carriers</option>';
        CARRIERS.sort((a, b) => a.name.localeCompare(b.name)).forEach(c => {
          carrierSelect.innerHTML += `<option value="${c.id}">${escapeHtmlReport(c.name)}</option>`;
        });
      }
      
      const productSelect = document.getElementById('report-product-filter');
      if (productSelect) {
        productSelect.innerHTML = '<option value="">All Products</option>';
        PRODUCTS.forEach(p => {
          productSelect.innerHTML += `<option value="${p.id}">${escapeHtmlReport(p.name)}</option>`;
        });
      }
    }

    // ==================== AUTOMATED QB EXPORT ====================
    
    let pendingExportCount = 0;
    
    async function initAutoExportPanel() {
      const panel = document.getElementById('auto-export-panel');
      if (!panel) return;
      
      // Show for admin AND finance roles (Jesse needs to trigger exports)
      if (currentUser?.role === 'admin' || currentUser?.role === 'finance') {
        panel.classList.remove('hidden');
        await refreshPendingCount();
      } else {
        panel.classList.add('hidden');
      }
    }
    
    async function refreshPendingCount() {
      const countEl = document.getElementById('pending-export-count');
      const btn = document.getElementById('export-now-btn');
      
      if (!countEl) return;
      
      countEl.textContent = '...';
      
      try {
        const response = await fetch('/api/trigger-qb-export', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dryRun: true })
        });
        
        const data = await response.json();
        
        if (data.success) {
          pendingExportCount = data.ticketsFound || 0;
          countEl.textContent = pendingExportCount;
          
          if (btn) {
            btn.disabled = pendingExportCount === 0;
          }
        } else if (data.message && data.message.includes('No pending')) {
          pendingExportCount = 0;
          countEl.textContent = '0';
          if (btn) btn.disabled = true;
        } else {
          countEl.textContent = '?';
          console.error('Failed to get pending count:', data.error);
        }
      } catch (error) {
        console.error('Error fetching pending count:', error);
        countEl.textContent = '?';
      }
    }
    
    async function triggerManualExport() {
      if (pendingExportCount === 0) {
        showToast('No pending tickets to export', 'info');
        return;
      }
      
      const confirmMsg = `Export ${pendingExportCount} ticket(s) to QuickBooks?\n\nThis will:\n‚Ä¢ Generate an IIF file\n‚Ä¢ Email it to accounting@beaverpumice.com\n‚Ä¢ Mark tickets as exported\n\nContinue?`;
      
      if (!confirm(confirmMsg)) return;
      
      const btn = document.getElementById('export-now-btn');
      const progress = document.getElementById('export-progress');
      const progressText = document.getElementById('export-progress-text');
      const progressDetail = document.getElementById('export-progress-detail');
      
      if (btn) btn.disabled = true;
      if (progress) progress.classList.remove('hidden');
      if (progressText) progressText.textContent = 'Generating IIF file...';
      if (progressDetail) progressDetail.textContent = `Processing ${pendingExportCount} tickets`;
      
      try {
        const response = await fetch('/api/trigger-qb-export', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        
        const data = await response.json();
        
        if (data.success) {
          if (progressText) progressText.textContent = '‚úÖ Export complete!';
          if (progressDetail) progressDetail.textContent = `${data.ticketsExported} tickets in ${data.invoicesGenerated} invoice(s) emailed to ${data.emailSentTo}`;
          
          showToast(`Exported ${data.ticketsExported} tickets to QuickBooks!`, 'success');
          
          const lastExportInfo = document.getElementById('last-export-info');
          const lastExportDate = document.getElementById('last-export-date');
          
          if (lastExportInfo) lastExportInfo.classList.remove('hidden');
          if (lastExportDate) lastExportDate.textContent = new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' });
          
          setTimeout(async () => {
            if (progress) progress.classList.add('hidden');
            await refreshPendingCount();
            if (typeof applyReportFilters === 'function') {
              await applyReportFilters();
            }
          }, 3000);
          
        } else {
          throw new Error(data.error || 'Export failed');
        }
        
      } catch (error) {
        console.error('Export error:', error);
        if (progressText) progressText.textContent = '‚ùå Export failed';
        if (progressDetail) progressDetail.textContent = error.message;
        showToast('Export failed: ' + error.message, 'error');
        
        setTimeout(() => {
          if (progress) progress.classList.add('hidden');
          if (btn) btn.disabled = pendingExportCount === 0;
        }, 3000);
      }
    }

    console.log('Phase 2 Reports & QuickBooks Export module loaded');

    // Start the app
    init();
  </script>

  <!-- Floating Help Button -->
  <div id="help-fab" class="fixed bottom-6 right-6 z-50">
    <div id="help-menu" class="hidden absolute bottom-16 right-0 bg-white rounded-xl shadow-2xl border border-slate-200 overflow-hidden w-64 mb-2">
      <div class="bg-slate-800 text-white px-4 py-3">
        <h3 class="font-bold">Need Help?</h3>
      </div>
      <div class="p-2">
        <!-- Operator Links (shown to everyone) -->
        <a href="operator-guide.html" class="flex items-center gap-3 px-4 py-3 hover:bg-slate-50 rounded-lg transition-all">
          <span class="text-xl">üë∑</span>
          <div>
            <div class="font-semibold text-slate-800">Operator Guide</div>
            <div class="text-xs text-slate-500">How to create tickets</div>
          </div>
        </a>
        
        <!-- Admin Links (hidden for operators) -->
        <a href="training.html" id="help-admin-training" class="hidden flex items-center gap-3 px-4 py-3 hover:bg-slate-50 rounded-lg transition-all">
          <span class="text-xl">üëë</span>
          <div>
            <div class="font-semibold text-slate-800">Admin Guide</div>
            <div class="text-xs text-slate-500">Reports, QuickBooks, settings</div>
          </div>
        </a>
        <a href="test-dashboard.html" id="help-admin-diagnostics" class="hidden flex items-center gap-3 px-4 py-3 hover:bg-slate-50 rounded-lg transition-all">
          <span class="text-xl">üß™</span>
          <div>
            <div class="font-semibold text-slate-800">System Diagnostics</div>
            <div class="text-xs text-slate-500">Test all connections</div>
          </div>
        </a>
        
        <hr class="my-2">
        <a href="mailto:support@resultantai.com?subject=Beaver%20Pumice%20Support%20Request" class="flex items-center gap-3 px-4 py-3 hover:bg-amber-50 rounded-lg transition-all">
          <span class="text-xl">üìß</span>
          <div>
            <div class="font-semibold text-amber-700">Contact Support</div>
            <div class="text-xs text-slate-500">support@resultantai.com</div>
          </div>
        </a>
      </div>
    </div>
    <button onclick="toggleHelpMenu()" class="bg-slate-800 hover:bg-slate-700 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-2xl transition-all hover:scale-110">
      <span id="help-icon">‚ùì</span>
    </button>
  </div>
  
  <script>
    function toggleHelpMenu() {
      const menu = document.getElementById('help-menu');
      const icon = document.getElementById('help-icon');
      menu.classList.toggle('hidden');
      icon.textContent = menu.classList.contains('hidden') ? '‚ùì' : '‚úï';
      
      // Show/hide admin links based on user role
      const isAdmin = currentUser && currentUser.role === 'admin';
      document.getElementById('help-admin-training').classList.toggle('hidden', !isAdmin);
      document.getElementById('help-admin-diagnostics').classList.toggle('hidden', !isAdmin);
    }
    // Close menu when clicking outside
    document.addEventListener('click', function(e) {
      const fab = document.getElementById('help-fab');
      if (!fab.contains(e.target)) {
        document.getElementById('help-menu').classList.add('hidden');
        document.getElementById('help-icon').textContent = '‚ùì';
      }
    });
  </script>

  <!-- Scale Integration -->
  <script src="js/scale-integration.js"></script>
  <script>
    // Initialize scale integration when page loads
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof initScaleIntegration === 'function') {
        initScaleIntegration();
        // Try to auto-reconnect to previously paired scale
        if (typeof autoReconnectScale === 'function') {
          autoReconnectScale();
        }
      }
    });
  </script>

  <!-- Pricing Admin -->
  <script src="js/pricing-admin.js"></script>
  
  <!-- Email Integration -->
  <script src="js/email-integration.js"></script>
  
  <style>
    .pricing-tab.active {
      color: #d4a921;
      border-bottom-color: #d4a921;
    }
    .pricing-row:hover {
      background-color: #f9fafb;
    }
  </style>

</body>
</html>
